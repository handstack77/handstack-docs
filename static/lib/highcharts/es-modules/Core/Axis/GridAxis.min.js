"use strict";import Axis from"./Axis.js";import H from"../Globals.js";const dateFormats=H["dateFormats"];import U from"../Utilities.js";const{addEvent,defined,erase,find,isArray,isNumber,merge,pick,timeUnits,wrap}=U;var GridAxisSide;function argsToArray(t){return Array.prototype.slice.call(t,1)}function isObject(t){return U.isObject(t,!0)}function applyGridOptions(t){const i=t.options;i.labels.align=pick(i.labels.align,"center"),t.categories||(i.showLastLabel=!1),t.labelRotation=0,i.labels.rotation=0,i.minTickInterval=1}function compose(t,i,e){return t.keepProps.includes("grid")||(t.keepProps.push("grid"),t.prototype.getMaxLabelDimensions=getMaxLabelDimensions,wrap(t.prototype,"unsquish",wrapUnsquish),wrap(t.prototype,"getOffset",wrapGetOffset),addEvent(t,"init",onInit),addEvent(t,"afterGetTitlePosition",onAfterGetTitlePosition),addEvent(t,"afterInit",onAfterInit),addEvent(t,"afterRender",onAfterRender),addEvent(t,"afterSetAxisTranslation",onAfterSetAxisTranslation),addEvent(t,"afterSetOptions",onAfterSetOptions),addEvent(t,"afterSetOptions",onAfterSetOptions2),addEvent(t,"afterSetScale",onAfterSetScale),addEvent(t,"afterTickSize",onAfterTickSize),addEvent(t,"trimTicks",onTrimTicks),addEvent(t,"destroy",onDestroy),addEvent(i,"afterSetChartSize",onChartAfterSetChartSize),addEvent(e,"afterGetLabelPosition",onTickAfterGetLabelPosition),addEvent(e,"labelFormat",onTickLabelFormat)),t}function getMaxLabelDimensions(n,t){const s={width:0,height:0};return t.forEach(function(t){t=n[t];let i,e=0,r;isObject(t)&&(i=(r=isObject(t.label)?t.label:{}).getBBox?r.getBBox().height:0,r.textStr&&!isNumber(r.textPxLength)&&(r.textPxLength=r.getBBox().width),e=isNumber(r.textPxLength)?Math.round(r.textPxLength):0,r.textStr&&(e=Math.round(r.getBBox().width)),s.height=Math.max(i,s.height),s.width=Math.max(e,s.width))}),"treegrid"===this.type&&this.treeGrid&&this.treeGrid.mapOfPosToGridNode&&(t=this.treeGrid.mapOfPosToGridNode[-1].height||0,s.width+=this.options.labels.indentation*(t-1)),s}function wrapGetOffset(t){var i=this["grid"],e=3===this.side;if(e||t.apply(this),!i?.isColumn){let t=i?.columns||[];(t=e?t.slice().reverse():t).forEach(t=>{t.getOffset()})}e&&t.apply(this)}function onAfterGetTitlePosition(t){var i=this;const e=i.options;if(!0===(e.grid||{}).enabled){const{axisTitle:l,height:h,horiz:c,left:f,offset:g,opposite:p,options:e,top:u,width:m}=i;var r=i.tickSize(),n=l&&l.getBBox().width,s=e.title.x,o=e.title.y,a=pick(e.title.margin,c?5:10),d=l?i.chart.renderer.fontMetrics(l).f:0,r=(c?u+h:f)+(c?1:-1)*(p?-1:1)*(r?r[0]/2:0)+(i.side===GridAxisSide.bottom?d:0);t.titlePosition.x=c?f-(n||0)/2-a+s:r+(p?m:0)+g+s,t.titlePosition.y=c?r-(p?h:0)+(p?d:-d)/2+g+o:u-a+o}}function onAfterInit(){var i=this,{chart:e,options:{grid:r={}},userOptions:n}=i;if(r.enabled&&applyGridOptions(i),r.columns){const o=i.grid.columns=[];let t=i.grid.columnIndex=0;for(;++t<r.columns.length;){var s=merge(n,r.columns[t],{isInternal:!0,linkedTo:0,scrollbar:{enabled:!1}},{grid:{columns:void 0}});const a=new Axis(i.chart,s,"yAxis");a.grid.isColumn=!0,a.grid.columnIndex=t,erase(e.axes,a),erase(e[i.coll]||[],a),o.push(a)}}}function onAfterRender(){const e=this,{axisTitle:t,grid:i,options:r}=e,n=r.grid||{};if(!0===n.enabled){var s=e.min||0,o=e.max||0,a=e.ticks[e.tickPositions[0]];if(t&&!e.chart.styledMode&&a?.slotWidth&&!e.options.title.style.width&&t.css({width:a.slotWidth+"px"}),e.maxLabelDimensions=e.getMaxLabelDimensions(e.ticks,e.tickPositions),e.rightWall&&e.rightWall.destroy(),e.grid&&e.grid.isOuterAxis()&&e.axisLine){var a=r.lineWidth;if(a){const h=e.getLinePath(a),c=h[0],f=h[1],g=(e.tickSize("tick")||[1])[0],p=g*(e.side===GridAxisSide.top||e.side===GridAxisSide.left?-1:1);"M"===c[0]&&"L"===f[0]&&(e.horiz?(c[2]+=p,f[2]+=p):(c[1]+=p,f[1]+=p)),!e.horiz&&e.chart.marginRight&&(a=[c,["L",e.left,c[2]||0]],d=["L",e.chart.chartWidth-e.chart.marginRight,e.toPixels(o+e.tickmarkOffset)],d=[["M",f[1]||0,e.toPixels(o+e.tickmarkOffset)],d],e.grid.upperBorder||s%1==0||(e.grid.upperBorder=e.grid.renderBorder(a)),e.grid.upperBorder&&(e.grid.upperBorder.attr({stroke:r.lineColor,"stroke-width":r.lineWidth}),e.grid.upperBorder.animate({d:a})),e.grid.lowerBorder||o%1==0||(e.grid.lowerBorder=e.grid.renderBorder(d)),e.grid.lowerBorder&&(e.grid.lowerBorder.attr({stroke:r.lineColor,"stroke-width":r.lineWidth}),e.grid.lowerBorder.animate({d:d}))),e.grid.axisLineExtra?(e.grid.axisLineExtra.attr({stroke:r.lineColor,"stroke-width":r.lineWidth}),e.grid.axisLineExtra.animate({d:h})):e.grid.axisLineExtra=e.grid.renderBorder(h),e.axisLine[e.showAxis?"show":"hide"]()}}if((i&&i.columns||[]).forEach(t=>t.render()),!e.horiz&&e.chart.hasRendered&&(e.scrollbar||e.linkedParent&&e.linkedParent.scrollbar)&&e.tickPositions.length){var a=e.tickmarkOffset,d=e.tickPositions[e.tickPositions.length-1],l=e.tickPositions[0];let t,i;for(;(t=e.hiddenLabels.pop())&&t.element;)t.show();for(;(i=e.hiddenMarks.pop())&&i.element;)i.show();(t=e.ticks[l].label)&&(a<s-l?e.hiddenLabels.push(t.hide()):t.show()),(t=e.ticks[d].label)&&(a<d-o?e.hiddenLabels.push(t.hide()):t.show());const u=e.ticks[d].mark;u&&d-o<a&&0<d-o&&e.ticks[d].isLast&&e.hiddenMarks.push(u.hide())}}}function onAfterSetAxisTranslation(){var t=this,i=t.tickPositions&&t.tickPositions.info;const e=t.options;var r=e.grid||{},n=t.userOptions.labels||{};r.enabled&&(t.horiz?(t.series.forEach(t=>{t.options.pointRange=0}),i&&e.dateTimeLabelFormats&&e.labels&&!defined(n.align)&&(!1===e.dateTimeLabelFormats[i.unitName].range||1<i.count)&&(e.labels.align="left",defined(n.x)||(e.labels.x=3))):"treegrid"!==this.type&&t.grid&&t.grid.columns&&(this.minPointOffset=this.tickInterval))}function onAfterSetOptions(t){const i=this.options,e=t.userOptions,r=i&&isObject(i.grid)?i.grid:{};let l;!0===r.enabled&&(l=merge(!0,{className:"highcharts-grid-axis "+(e.className||""),dateTimeLabelFormats:{hour:{list:["%H:%M","%H"]},day:{list:["%A, %e. %B","%a, %e. %b","%E"]},week:{list:["Week %W","W%W"]},month:{list:["%B","%b","%o"]}},grid:{borderWidth:1},labels:{padding:2,style:{fontSize:"0.9em"}},margin:0,title:{text:null,reserveSpace:!1,rotation:0,style:{textOverflow:"ellipsis"}},units:[["millisecond",[1,10,100]],["second",[1,10]],["minute",[1,5,15]],["hour",[1,6]],["day",[1]],["week",[1]],["month",[1]],["year",null]]},e),"xAxis"===this.coll&&(defined(e.linkedTo)&&!defined(e.tickPixelInterval)&&(l.tickPixelInterval=350),defined(e.tickPixelInterval)||!defined(e.linkedTo)||defined(e.tickPositioner)||defined(e.tickInterval)||defined(e.units)||(l.tickPositioner=function(r,n){var s=this.linkedParent&&this.linkedParent.tickPositions&&this.linkedParent.tickPositions.info;if(s){var o=l.units||[];let i,t=1,e="year";for(let t=0;t<o.length;t++){var a=o[t];if(a&&a[0]===s.unitName){i=t;break}}var d=isNumber(i)&&o[i+1],d=(d?(e=d[0]||"year",d=d[1],t=d&&d[0]||1):"year"===s.unitName&&(t=10*s.count),timeUnits[e]);return this.tickInterval=d*t,this.chart.time.getTimeTicks({unitRange:d,count:t,unitName:e},r,n,this.options.startOfWeek)}})),merge(!0,this.options,l),this.horiz&&(i.minPadding=pick(e.minPadding,0),i.maxPadding=pick(e.maxPadding,0)),isNumber(i.grid.borderWidth)&&(i.tickWidth=i.lineWidth=r.borderWidth))}function onAfterSetOptions2(t){var t=t.userOptions,t=t&&t.grid||{},i=t.columns;t.enabled&&i&&merge(!0,this.options,i[0])}function onAfterSetScale(){(this.grid.columns||[]).forEach(t=>t.setScale())}function onAfterTickSize(t){var i,{horiz:e,maxLabelDimensions:r,options:{grid:n={}}}=this;n.enabled&&r&&(i=2*this.options.labels.distance,e=e?n.cellHeight||i+r.height:i+r.width,isArray(t.tickSize)?t.tickSize[0]=e:t.tickSize=[e,0])}function onChartAfterSetChartSize(){this.axes.forEach(t=>{(t.grid&&t.grid.columns||[]).forEach(t=>{t.setAxisSize(),t.setAxisTranslation()})})}function onDestroy(i){const t=this["grid"];(t.columns||[]).forEach(t=>t.destroy(i.keepEvents)),t.columns=void 0}function onInit(t){var i=this;const e=t.userOptions||{};t=e.grid||{};t.enabled&&defined(t.borderColor)&&(e.tickColor=e.lineColor=t.borderColor),i.grid||(i.grid=new GridAxisAdditions(i)),i.hiddenLabels=[],i.hiddenMarks=[]}function onTickAfterGetLabelPosition(n){const s=this.label,o=this.axis,a=o.reversed,d=o.chart,t=o.options,i=t.grid||{},l=o.options.labels,h=l.align,c=GridAxisSide[o.side],e=n.tickmarkOffset,r=o.tickPositions,f=this.pos-e,g=isNumber(r[n.index+1])?r[n.index+1]-e:(o.max||0)+e,p=o.tickSize("tick"),u=p?p[0]:0,m=p?p[1]/2:0;if(!0===i.enabled){let t,i,e,r;var k,x;"top"===c?(t=o.top+o.offset,i=t-u):"bottom"===c?(i=d.chartHeight-o.bottom+o.offset,t=i+u):(t=o.top+o.len-(o.translate(a?g:f)||0),i=o.top+o.len-(o.translate(a?f:g)||0)),"right"===c?(e=d.chartWidth-o.right+o.offset,r=e+u):"left"===c?(r=o.left+o.offset,e=r-u):(e=Math.round(o.left+(o.translate(a?g:f)||0))-m,r=Math.min(Math.round(o.left+(o.translate(a?f:g)||0))-m,o.left+o.len)),this.slotWidth=r-e,n.pos.x="left"===h?e:"right"===h?r:e+(r-e)/2,n.pos.y=i+(t-i)/2,s&&(k=d.renderer.fontMetrics(s),x=s.getBBox().height,l.useHTML?n.pos.y+=k.b+-x/2:(x=Math.round(x/k.h),n.pos.y+=(k.b-(k.h-k.f))/2+-((x-1)*k.h)/2)),n.pos.x+=o.horiz&&l.x||0}}function onTickLabelFormat(i){const{axis:e,value:r}=i;if(e.options.grid&&e.options.grid.enabled){var n=e.tickPositions;const a=(e.linkedParent||e).series[0];var s=r===n[0],n=r===n[n.length-1],o=a&&find(a.options.data,function(t){return t[e.isXAxis?"x":"y"]===r});let t;o&&a.is("gantt")&&(t=merge(o),H.seriesTypes.gantt.prototype.pointClass.setGanttPointAliases(t)),i.isFirst=s,i.isLast=n,i.point=t}}function onTrimTicks(){const t=this,i=t.options,e=i.grid||{},r=t.categories,n=t.tickPositions,s=n[0],o=n[1],a=n[n.length-1],d=n[n.length-2],l=t.linkedParent&&t.linkedParent.min,h=t.linkedParent&&t.linkedParent.max,c=l||t.min,f=h||t.max,g=t.tickInterval,p=isNumber(c)&&s+g<=c&&c<o,u=isNumber(c)&&s<c&&c<s+g,m=isNumber(f)&&f<a&&a-g<f,k=isNumber(f)&&f<=a-g&&d<f;!0!==e.enabled||r||!t.isXAxis&&!t.isLinked||(!u&&!p||i.startOnTick||(n[0]=c),!m&&!k||i.endOnTick||(n[n.length-1]=f))}function wrapUnsquish(t){var{options:{grid:i={}}}=this;return!0===i.enabled&&this.categories?this.tickInterval:t.apply(this,argsToArray(arguments))}!function(t){t[t.top=0]="top",t[t.right=1]="right",t[t.bottom=2]="bottom",t[t.left=3]="left"}(GridAxisSide=GridAxisSide||{});class GridAxisAdditions{constructor(t){this.axis=t}isOuterAxis(){const e=this.axis,t=e.chart;var i=e.grid.columnIndex,r=e.linkedParent?.grid.columns||e.grid.columns||[];const n=i?e.linkedParent:e;let s=-1,o=0;return 3===e.side&&!t.inverted&&r.length?!e.linkedParent:((t[e.coll]||[]).forEach((t,i)=>{t.side!==e.side||t.options.isInternal||(o=i,t===n&&(s=i))}),o===s&&(!isNumber(i)||r.length===i))}renderBorder(t){const i=this.axis,e=i.chart.renderer,r=i.options,n=e.path(t).addClass("highcharts-axis-line").add(i.axisGroup);return e.styledMode||n.attr({stroke:r.lineColor,"stroke-width":r.lineWidth,zIndex:7}),n}}dateFormats.E=function(t){return this.dateFormat("%a",t,!0).charAt(0)},dateFormats.W=function(t){const i=this,e=new this.Date(t);["Hours","Milliseconds","Minutes","Seconds"].forEach(function(t){i.set(t,e,0)});t=(this.get("Day",e)+6)%7;const r=new this.Date(e.valueOf()),n=(this.set("Date",r,this.get("Date",e)-t+3),new this.Date(this.get("FullYear",r),0,1));return 4!==this.get("Day",n)&&(this.set("Month",e,0),this.set("Date",e,1+(11-this.get("Day",n))%7)),(1+Math.floor((r.valueOf()-n.valueOf())/6048e5)).toString()};const GridAxis={compose:compose};export default GridAxis;