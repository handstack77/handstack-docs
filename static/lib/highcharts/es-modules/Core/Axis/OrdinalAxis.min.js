"use strict";import Axis from"./Axis.js";import H from"../Globals.js";import Series from"../Series/Series.js";import U from"../Utilities.js";const{addEvent,correctFloat,css,defined,error,isNumber,pick,timeUnits,isString}=U;var OrdinalAxis;!function(e){function o(t,i,a,n,e=[],o=0,r){const s={},l=this.options.tickPixelInterval,d=this.chart.time,c=[];let p,g,h,f,u,v=0,x=[],m=-Number.MAX_VALUE;if(!this.options.ordinal&&!this.options.breaks||!e||e.length<3||void 0===i)return d.getTimeTicks.apply(d,arguments);var P=e.length;for(p=0;p<P;p++){if(u=p&&e[p-1]>a,e[p]<i&&(v=p),p===P-1||e[p+1]-e[p]>5*o||u){if(e[p]>m){for(g=d.getTimeTicks(t,e[v],e[p],n);g.length&&g[0]<=m;)g.shift();g.length&&(m=g[g.length-1]),c.push(x.length),x=x.concat(g)}v=p+1}if(u)break}if(g){if(f=g.info,r&&f.unitRange<=timeUnits.hour){for(p=x.length-1,v=1;v<p;v++)d.dateFormat("%d",x[v])!==d.dateFormat("%d",x[v-1])&&(s[x[v]]="day",h=!0);h&&(s[x[0]]="day"),f.higherRanks=s}f.segmentStarts=c,x.info=f}else error(12,!1,this.chart);if(r&&defined(l)){const O=x.length,M=[],E=[];let t,i,n,e,o,r=O;for(;r--;)i=this.translate(x[r]),n&&(E[r]=n-i),M[r]=n=i;for(E.sort((t,i)=>t-i),(e=E[Math.floor(E.length/2)])<.6*l&&(e=null),r=x[O-1]>a?O-1:O,n=void 0;r--;)i=M[r],o=Math.abs(n-i),n&&o<.8*l&&(null===e||o<.8*e)?(s[x[r]]&&!s[x[r+1]]?(t=r+1,n=i):t=r,x.splice(t,1)):n=i}return x}function r(t){var i=this.ordinal.positions;if(!i)return t;let n=i.length-1,e;return t<0?t=i[0]:t>n?t=i[n]:(n=Math.floor(t),e=t-n),void 0!==e&&void 0!==i[n]?i[n]+(e?e*(i[n+1]-i[n]):0):t}function a(t){const i=this,n=i.ordinal,e=(i.old||i).min,o=(i.old||i).transA;var r=n.getExtendedPositions();if(r&&r.length){var a,s=correctFloat((t-e)*o+i.minPixelPadding),s=correctFloat(n.getIndexOfPoint(s,r)),l=correctFloat(s%1);if(0<=s&&s<=r.length-1)return a=r[Math.floor(s)],a=r[Math.ceil(s)]-a,r[Math.floor(s)]+l*a}return t}function d(t,i){var n=e.Additions.findIndexOf(t,i,!0);return t[n]===i?n:n+(i-t[n])/(t[n+1]-t[n])}function s(){this.ordinal||(this.ordinal=new e.Additions(this))}function l(){var t=this,{eventArgs:i,options:n}=t;t.isXAxis&&defined(n.overscroll)&&0!==n.overscroll&&isNumber(t.max)&&isNumber(t.min)&&(t.options.ordinal&&!t.ordinal.originalOrdinalRange&&t.ordinal.getExtendedPositions(!1),t.max!==t.dataMax||"pan"===i?.trigger&&!t.isInternal||"navigator"===i?.trigger||(n=t.ordinal.convertOverscroll(n.overscroll),t.max+=n,!t.isInternal&&defined(t.userMin)&&"mousewheel"!==i?.trigger&&(t.min+=n)))}function c(){var t=this;t.horiz&&!t.isDirty&&(t.isDirty=t.isOrdinal&&t.chart.navigator&&!t.chart.navigator.adaptToUpdatedData)}function p(){var t=this;t.ordinal&&(t.ordinal.beforeSetTickPositions(),t.tickInterval=t.ordinal.postProcessTickInterval(t.tickInterval))}function g(t){const n=this,e=n.xAxis[0],o=e.ordinal.convertOverscroll(e.options.overscroll),r=t.originalEvent.chartX,i=n.options.chart.panning;let a=!1;if(i&&"y"!==i.type&&e.options.ordinal&&e.series.length&&(!t.touches||t.touches.length<=1)){const s=n.mouseDownX,l=e.getExtremes(),d=l.dataMin,c=l.dataMax,p=l.min,g=l.max,h=n.hoverPoints,f=e.closestPointRange||e.ordinal&&e.ordinal.overscrollPointsRange,u=e.translationSlope*(e.ordinal.slope||f),v=Math.round((s-r)/u),x=e.ordinal.getExtendedPositions(),m={ordinal:{positions:x,extendedOrdinalPositions:x}},P=e.index2val,O=e.val2lin;let t,i;if(p<=d&&v<0||c<=g+o&&0<v)return;m.ordinal.positions?1<Math.abs(v)&&(h&&h.forEach(function(t){t.setState()}),c>(i=m.ordinal.positions)[i.length-1]&&i.push(c),n.setFixedRange(g-p),(t=e.navigatorAxis.toFixedRange(void 0,void 0,P.apply(m,[O.apply(m,[p,!0])+v]),P.apply(m,[O.apply(m,[g,!0])+v]))).min>=Math.min(l.dataMin,p)&&t.max<=Math.max(c,g)+o&&e.setExtremes(t.min,t.max,!0,!1,{trigger:"pan"}),n.mouseDownX=r,css(n.container,{cursor:"move"})):a=!0}else a=!0;a||i&&/y/.test(i.type)?o&&(e.max=e.dataMax+o):t.preventDefault()}function h(){const t=this.xAxis;t&&t.options.ordinal&&(delete t.ordinal.index,delete t.ordinal.originalOrdinalRange)}function f(t,i){const n=this.ordinal,e=n.positions;let o=n.slope,r;if(!e)return t;var a=e.length;let s;if(e[0]<=t&&e[a-1]>=t)s=d(e,t);else{if(!(r=n.getExtendedPositions&&n.getExtendedPositions())||!r.length)return t;var a=r.length,l=(o=o||(r[a-1]-r[0])/a,d(r,e[0]));if(t>=r[0]&&t<=r[a-1])s=d(r,t)-l;else{if(!i)return t;s=t<r[0]?-l-(r[0]-t)/o:(t-r[a-1])/o+a-l}}return i?s:o*(s||0)+n.offset}e.compose=function(t,i,n){const e=t.prototype;return e.ordinal2lin||(e.getTimeTicks=o,e.index2val=r,e.lin2val=a,e.val2lin=f,e.ordinal2lin=e.val2lin,addEvent(t,"afterInit",s),addEvent(t,"foundExtremes",l),addEvent(t,"afterSetScale",c),addEvent(t,"initialAxisTranslation",p),addEvent(n,"pan",g),addEvent(n,"touchpan",g),addEvent(i,"updatedData",h)),t};class u{constructor(t){this.index={},this.axis=t}beforeSetTickPositions(){const t=this.axis,i=t.ordinal,n=t.getExtremes(),e=n.min,o=n.max,r=t.brokenAxis?.hasBreaks,a=t.options.ordinal;let s,l,d,c,p,g,h,f=[],u=Number.MAX_VALUE,v=!1,x=!1,m=!1;if(a||r){let n=0;if(t.series.forEach(function(t,i){if(l=[],0<i&&"highcharts-navigator-series"!==t.options.id&&1<t.processedXData.length&&(x=n!==t.processedXData[1]-t.processedXData[0]),n=t.processedXData[1]-t.processedXData[0],t.boosted&&(m=t.boosted),t.reserveSpace()&&(!1!==t.takeOrdinalPosition||r)&&(f=f.concat(t.processedXData),s=f.length,f.sort(function(t,i){return t-i}),u=Math.min(u,pick(t.closestPointRange,u)),s)){for(i=0;i<s-1;)f[i]!==f[i+1]&&l.push(f[i+1]),i++;l[0]!==f[0]&&l.unshift(f[0]),f=l}}),t.ordinal.originalOrdinalRange||(t.ordinal.originalOrdinalRange=(f.length-1)*u),x&&m&&(f.pop(),f.shift()),2<(s=f.length)){for(d=f[1]-f[0],h=s-1;h--&&!v;)f[h+1]-f[h]!=d&&(v=!0);!t.options.keepOrdinalPadding&&(f[0]-e>d||o-f[f.length-1]>d)&&(v=!0)}else t.options.overscroll&&(2===s?u=f[1]-f[0]:1===s?(u=t.ordinal.convertOverscroll(t.options.overscroll),f=[f[0],f[0]+u]):u=i.overscrollPointsRange);v||t.forceOrdinal?(t.options.overscroll&&(i.overscrollPointsRange=u,f=f.concat(i.getOverscrollPositions())),i.positions=f,c=t.ordinal2lin(Math.max(e,f[0]),!0),p=Math.max(t.ordinal2lin(Math.min(o,f[f.length-1]),!0),1),i.slope=g=(o-e)/(p-c),i.offset=e-c*g):(i.overscrollPointsRange=pick(t.closestPointRange,i.overscrollPointsRange),i.positions=t.ordinal.slope=i.offset=void 0)}t.isOrdinal=a&&v,i.groupIntervalFactor=null}static findIndexOf(t,i,n){let e=0,o=t.length-1,r;for(;e<o;)t[r=Math.ceil((e+o)/2)]<=i?e=r:o=r-1;return t[e]===i||n?e:-1}getExtendedPositions(i=!0){const n=this,t=n.axis,e=t.constructor.prototype,o=t.chart,r=t.series[0]?.currentDataGrouping,a=r?r.count+r.unitName:"raw",s=i?t.ordinal.convertOverscroll(t.options.overscroll):0,l=t.getExtremes();let d,c=void 0,p=n.index;return(p=p||(n.index={}))[a]||((d={series:[],chart:o,forceOrdinal:!1,getExtremes:function(){return{min:l.dataMin,max:l.dataMax+s}},applyGrouping:e.applyGrouping,getGroupPixelWidth:e.getGroupPixelWidth,getTimeTicks:e.getTimeTicks,options:{ordinal:!0},ordinal:{getGroupIntervalFactor:this.getGroupIntervalFactor},ordinal2lin:e.ordinal2lin,getIndexOfPoint:e.getIndexOfPoint,val2lin:e.val2lin}).ordinal.axis=d,t.series.forEach(function(t){c={xAxis:d,xData:t.xData.slice(),chart:o,groupPixelWidth:t.groupPixelWidth,destroyGroupedData:H.noop,getProcessedData:Series.prototype.getProcessedData,applyGrouping:Series.prototype.applyGrouping,reserveSpace:Series.prototype.reserveSpace,visible:t.visible},i&&(c.xData=c.xData.concat(n.getOverscrollPositions())),c.options={dataGrouping:r?{firstAnchor:t.options.dataGrouping?.firstAnchor,anchor:t.options.dataGrouping?.anchor,lastAnchor:t.options.dataGrouping?.firstAnchor,enabled:!0,forced:!0,approximation:"open",units:[[r.unitName,[r.count]]]}:{enabled:!1}},d.series.push(c),t.processData.apply(c)}),d.applyGrouping({hasExtremesChanged:!0}),c?.closestPointRange!==c?.basePointRange&&c.currentDataGrouping&&(d.forceOrdinal=!0),t.ordinal.beforeSetTickPositions.apply({axis:d}),!t.ordinal.originalOrdinalRange&&d.ordinal.originalOrdinalRange&&(t.ordinal.originalOrdinalRange=d.ordinal.originalOrdinalRange),p[a]=d.ordinal.positions),p[a]}getGroupIntervalFactor(t,i,n){const e=n.processedXData,o=e.length,r=[];let a,s,l=this.groupIntervalFactor;if(!l){for(s=0;s<o-1;s++)r[s]=e[s+1]-e[s];r.sort(function(t,i){return t-i}),a=r[Math.floor(o/2)],t=Math.max(t,e[0]),i=Math.min(i,e[o-1]),this.groupIntervalFactor=l=o*a/(i-t)}return l}getIndexOfPoint(t,i){const e=this.axis;let n=0;let o;e.series.forEach(t=>{var i=t.points?.[0];defined(i?.plotX)&&(i.plotX<o||!defined(o))&&function(t){const{min:i,max:n}=e;return!(!defined(i)||!defined(n))&&t.points.some(t=>t.x>=i&&t.x<=n)}(t)&&(o=i.plotX,n=i.x)}),o=o??e.minPixelPadding;var r=e.translationSlope*(this.slope||e.closestPointRange||this.overscrollPointsRange),t=correctFloat((t-o)/r);return u.findIndexOf(i,n,!0)+t}getOverscrollPositions(){const t=this.axis,i=this.convertOverscroll(t.options.overscroll),n=this.overscrollPointsRange,e=[];let o=t.dataMax;if(defined(n))for(;o<=t.dataMax+i;)o+=n,e.push(o);return e}postProcessTickInterval(t){var i=this.axis,n=this.slope;let e;return e=n?i.options.breaks?i.closestPointRange||t:t/(n/i.closestPointRange):t}convertOverscroll(t=0){function i(t){return pick(n.originalOrdinalRange,defined(e.dataMax)&&defined(e.dataMin)?e.dataMax-e.dataMin:0)*t}const n=this,e=n.axis;var o;return isString(t)?(o=parseInt(t,10),/%$/.test(t)?i(o/100):/px/.test(t)?i((o=Math.min(o,.9*e.len)/e.len)/(1-o)):0):t}}e.Additions=u}(OrdinalAxis=OrdinalAxis||{});export default OrdinalAxis;