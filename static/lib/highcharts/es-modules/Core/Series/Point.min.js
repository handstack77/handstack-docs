"use strict";import AST from"../Renderer/HTML/AST.js";import A from"../Animation/AnimationUtilities.js";const animObject=A["animObject"];import D from"../Defaults.js";const defaultOptions=D["defaultOptions"];import F from"../Templating.js";const format=F["format"];import U from"../Utilities.js";const{addEvent,crisp,erase,extend,fireEvent,getNestedProperty,isArray,isFunction,isNumber,isObject,merge,pick,syncTimeout,removeEvent,uniqueKey}=U;class Point{animateBeforeDestroy(){const s=this,o={x:s.startXPos,opacity:0},t=s.getGraphicalProps();t.singular.forEach(function(t){var e="dataLabel"===t;s[t]=s[t].animate(e?{x:s[t].startXPos,y:s[t].startYPos,opacity:0}:o)}),t.plural.forEach(function(t){s[t].forEach(function(t){t.element&&t.animate(extend({x:s.startXPos},t.startYPos?{x:t.startXPos,y:t.startYPos}:{}))})})}applyOptions(t,e){const s=this,o=s.series,i=o.options.pointValKey||o.pointValKey;return t=Point.prototype.optionsToObject.call(this,t),extend(s,t),s.options=s.options?extend(s.options,t):t,t.group&&delete s.group,t.dataLabels&&delete s.dataLabels,i&&(s.y=Point.prototype.getNestedProperty.call(s,i)),s.selected&&(s.state="select"),"name"in s&&void 0===e&&o.xAxis&&o.xAxis.hasNames&&(s.x=o.xAxis.nameToX(s)),void 0===s.x&&o?s.x=e??o.autoIncrement():isNumber(t.x)&&o.options.relativeXValue&&(s.x=o.autoIncrement(t.x)),s.isNull=this.isValid&&!this.isValid(),s.formatPrefix=s.isNull?"null":"point",s}destroy(){if(!this.destroyed){const e=this,s=e.series,o=s.chart,i=s.options.dataSorting,r=o.hoverPoints,a=e.series.chart.renderer.globalAnimation,n=animObject(a);var t=()=>{(e.graphic||e.graphics||e.dataLabel||e.dataLabels)&&(removeEvent(e),e.destroyElements());for(const t in e)delete e[t]};e.legendItem&&o.legend.destroyItem(e),r&&(e.setState(),erase(r,e),r.length||(o.hoverPoints=null)),e===o.hoverPoint&&e.onMouseOut(),i&&i.enabled?(this.animateBeforeDestroy(),syncTimeout(t,n.duration)):t(),o.pointCount--}this.destroyed=!0}destroyElements(t){const e=this,s=e.getGraphicalProps(t);s.singular.forEach(function(t){e[t]=e[t].destroy()}),s.plural.forEach(function(t){e[t].forEach(function(t){t&&t.element&&t.destroy()}),delete e[t]})}firePointEvent(t,e,s){const o=this,i=this.series,r=i.options;o.manageEvent(t),"click"===t&&r.allowPointSelect&&(s=function(t){!o.destroyed&&o.select&&o.select(null,t.ctrlKey||t.metaKey||t.shiftKey)}),fireEvent(o,t,e,s)}getClassName(){var t=this;return"highcharts-point"+(t.selected?" highcharts-point-select":"")+(t.negative?" highcharts-negative":"")+(t.isNull?" highcharts-null-point":"")+(void 0!==t.colorIndex?" highcharts-color-"+t.colorIndex:"")+(t.options.className?" "+t.options.className:"")+(t.zone&&t.zone.className?" "+t.zone.className.replace("highcharts-negative",""):"")}getGraphicalProps(s){const o=this,t=[],i={singular:[],plural:[]};let e,r;for((s=s||{graphic:1,dataLabel:1}).graphic&&t.push("graphic","connector"),s.dataLabel&&t.push("dataLabel","dataLabelPath","dataLabelUpper"),r=t.length;r--;)e=t[r],o[e]&&i.singular.push(e);return["graphic","dataLabel"].forEach(function(t){var e=t+"s";s[t]&&o[e]&&i.plural.push(e)}),i}getLabelConfig(){return{x:this.category,y:this.y,color:this.color,colorIndex:this.colorIndex,key:this.name||this.category,series:this.series,point:this,percentage:this.percentage,total:this.total||this.stackTotal}}getNestedProperty(t){if(t)return 0===t.indexOf("custom.")?getNestedProperty(t,this.options):this[t]}getZone(){var t=this.series,e=t.zones,s=t.zoneAxis||"y";let o,i=0;for(o=e[i];this[s]>=o.value;)o=e[++i];return this.nonZonedColor||(this.nonZonedColor=this.color),o&&o.color&&!this.options.color?this.color=o.color:this.color=this.nonZonedColor,o}hasNewShapeType(){var t=this;return(t.graphic&&(t.graphic.symbolName||t.graphic.element.nodeName))!==this.shapeType}constructor(t,e,s){this.formatPrefix="point",this.visible=!0,this.series=t,this.applyOptions(e,s),this.id??(this.id=uniqueKey()),this.resolveColor(),t.chart.pointCount++,fireEvent(this,"afterInit")}isValid(){return(isNumber(this.x)||this.x instanceof Date)&&isNumber(this.y)}optionsToObject(t){const e=this.series,s=e.options.keys,o=s||e.pointArrayMap||["y"],i=o.length;let r={},a,n=0,l=0;if(isNumber(t)||null===t)r[o[0]]=t;else if(isArray(t))for(!s&&t.length>i&&("string"==(a=typeof t[0])?r.name=t[0]:"number"==a&&(r.x=t[0]),n++);l<i;)s&&void 0===t[n]||(0<o[l].indexOf(".")?Point.prototype.setNestedProperty(r,t[n],o[l]):r[o[l]]=t[n]),n++,l++;else"object"==typeof t&&((r=t).dataLabels&&(e.hasDataLabels=()=>!0),t.marker&&(e._hasPointMarkers=!0));return r}pos(s,o=this.plotY){if(!this.destroyed){var{plotX:i,series:r}=this,{chart:r,xAxis:a,yAxis:n}=r;let t=0,e=0;if(isNumber(i)&&isNumber(o))return s&&(t=a?a.pos:r.plotLeft,e=n?n.pos:r.plotTop),r.inverted&&a&&n?[n.len-o+e,a.len-i+t]:[i+t,o+e]}}resolveColor(){const t=this.series,e=t.chart.options.chart,s=t.chart.styledMode;let o,i,r=e.colorCount,a;delete this.nonZonedColor,t.options.colorByPoint?(s||(i=t.options.colors||t.chart.options.colors,o=i[t.colorCounter],r=i.length),a=t.colorCounter,t.colorCounter++,t.colorCounter===r&&(t.colorCounter=0)):(s||(o=t.color),a=t.colorIndex),this.colorIndex=pick(this.options.colorIndex,a),this.color=pick(this.options.color,o)}setNestedProperty(t,i,e){const s=e.split(".");return s.reduce(function(t,e,s,o){o=o.length-1===s;return t[e]=o?i:isObject(t[e],!0)?t[e]:{},t[e]},t),t}shouldDraw(){return!this.isNull}tooltipFormatter(e){const t=this.series,s=t.tooltipOptions,o=pick(s.valueDecimals,""),i=s.valuePrefix||"",r=s.valueSuffix||"";return t.chart.styledMode&&(e=t.chart.tooltip.styledModeFormat(e)),(t.pointArrayMap||["y"]).forEach(function(t){t="{point."+t,e=(e=i||r?e.replace(RegExp(t+"}","g"),i+t+"}"+r):e).replace(RegExp(t+"}","g"),t+":,."+o+"f}")}),format(e,{point:this,series:this.series},t.chart)}update(e,s,o,t){const i=this,r=i.series,a=i.graphic,n=r.chart,l=r.options;let c;function h(){i.applyOptions(e);var t=a&&i.hasMockGraphic,t=null===i.y?!t:t;a&&t&&(i.graphic=a.destroy(),delete i.hasMockGraphic),isObject(e,!0)&&(a&&a.element&&e&&e.marker&&void 0!==e.marker.symbol&&(i.graphic=a.destroy()),e?.dataLabels&&i.dataLabel&&(i.dataLabel=i.dataLabel.destroy())),c=i.index,r.updateParallelArrays(i,c),l.data[c]=isObject(l.data[c],!0)||isObject(e,!0)?i.options:pick(e,l.data[c]),r.isDirty=r.isDirtyData=!0,!r.fixedBox&&r.hasCartesianSeries&&(n.isDirtyBox=!0),"point"===l.legendType&&(n.isDirtyLegend=!0),s&&n.redraw(o)}s=pick(s,!0),!1===t?h():i.firePointEvent("update",{options:e},h)}remove(t,e){this.series.removePoint(this.series.data.indexOf(this),t,e)}select(t,e){const s=this,o=s.series,i=o.chart;t=pick(t,!s.selected),this.selectedStaging=t,s.firePointEvent(t?"select":"unselect",{accumulate:e},function(){s.selected=s.options.selected=t,o.options.data[o.data.indexOf(s)]=s.options,s.setState(t&&"select"),e||i.getSelectedPoints().forEach(function(t){const e=t.series;t.selected&&t!==s&&(t.selected=t.options.selected=!1,e.options.data[e.data.indexOf(t)]=t.options,t.setState(i.hoverPoints&&e.options.inactiveOtherPoints?"inactive":""),t.firePointEvent("unselect"))})}),delete this.selectedStaging}onMouseOver(t){const e=this.series,{inverted:s,pointer:o}=e.chart;o&&(t=t?o.normalize(t):o.getChartCoordinatesFromPoint(this,s),o.runPointActions(t,this))}onMouseOut(){const t=this.series.chart;this.firePointEvent("mouseOut"),this.series.options.inactiveOtherPoints||(t.hoverPoints||[]).forEach(function(t){t.setState()}),t.hoverPoints=t.hoverPoint=null}manageEvent(t){var e=this,s=merge(e.series.options.point,e.options).events?.[t];!isFunction(s)||e.hcEvents?.[t]&&-1!==e.hcEvents?.[t]?.map(t=>t.fn).indexOf(s)?e.importedUserEvent&&!s&&e.hcEvents?.[t]&&(removeEvent(e,t),delete e.hcEvents[t],Object.keys(e.hcEvents)||delete e.importedUserEvent):(e.importedUserEvent?.(),e.importedUserEvent=addEvent(e,t,s))}setState(t,e){const s=this,o=s.series,i=s.state,r=o.options.states[t||"normal"]||{},a=defaultOptions.plotOptions[o.type].marker&&o.options.marker,n=a&&!1===a.enabled,l=a&&a.states&&a.states[t||"normal"]||{},c=!1===l.enabled,h=s.marker||{},p=o.chart,d=a&&o.markerAttribs;let u=o.halo,m,y,f,g=o.stateMarkerGraphic,v;if(!((t=t||"")===s.state&&!e||s.selected&&"select"!==t||!1===r.enabled||t&&(c||n&&!1===l.enabled)||t&&h.states&&h.states[t]&&!1===h.states[t].enabled)){if(s.state=t,d&&(m=o.markerAttribs(s,t)),s.graphic&&!s.hasMockGraphic){if(i&&s.graphic.removeClass("highcharts-point-"+i),t&&s.graphic.addClass("highcharts-point-"+t),!p.styledMode){y=o.pointAttribs(s,t),f=pick(p.options.chart.animation,r.animation);const E=y.opacity;o.options.inactiveOtherPoints&&isNumber(E)&&(s.dataLabels||[]).forEach(function(t){t&&!t.hasClass("highcharts-data-label-hidden")&&(t.animate({opacity:E},f),t.connector&&t.connector.animate({opacity:E},f))}),s.graphic.animate(y,f)}m&&s.graphic.animate(m,pick(p.options.chart.animation,l.animation,a.animation)),g&&g.hide()}else t&&l&&(v=h.symbol||o.symbol,g&&g.currentSymbol!==v&&(g=g.destroy()),m&&(g?g[e?"animate":"attr"]({x:m.x,y:m.y}):v&&(o.stateMarkerGraphic=g=p.renderer.symbol(v,m.x,m.y,m.width,m.height).add(o.markerGroup),g.currentSymbol=v)),!p.styledMode&&g&&"inactive"!==s.state&&g.attr(o.pointAttribs(s,t))),g&&(g[t&&s.isInside?"show":"hide"](),g.element.point=s,g.addClass(s.getClassName(),!0));var b=r.halo,x=s.graphic||g,P=x&&x.visibility||"inherit";b&&b.size&&x&&"hidden"!==P&&!s.isCluster?(u||(o.halo=u=p.renderer.path().add(x.parentGroup)),u.show()[e?"animate":"attr"]({d:s.haloPath(b.size)}),u.attr({class:"highcharts-halo highcharts-color-"+pick(s.colorIndex,o.colorIndex)+(s.className?" "+s.className:""),visibility:P,zIndex:-1}),u.point=s,p.styledMode||u.attr(extend({fill:s.color||o.color,"fill-opacity":b.opacity},AST.filterUserAttributes(b.attributes||{})))):u?.point?.haloPath&&!u.point.destroyed&&u.animate({d:u.point.haloPath(0)},null,u.hide),fireEvent(s,"afterSetState",{state:t})}}haloPath(t){var e=this.pos();return e?this.series.chart.renderer.symbols.circle(crisp(e[0],1)-t,e[1]-t,2*t,2*t):[]}}export default Point;