"use strict";import Color from"./Color/Color.js";const color=Color["parse"];import H from"./Globals.js";const{charts,composed,isTouchDevice}=H;import U from"./Utilities.js";const{addEvent,attr,css,extend,find,fireEvent,isNumber,isObject,objectEach,offset,pick,pushUnique,splat}=U;class Pointer{applyInactiveState(t){let e=[],o;(t||[]).forEach(function(t){o=t.series,e.push(o),o.linkedParent&&e.push(o.linkedParent),o.linkedSeries&&(e=e.concat(o.linkedSeries)),o.navigatorSeries&&e.push(o.navigatorSeries)}),this.chart.series.forEach(function(t){-1===e.indexOf(t)?t.setState("inactive",!0):t.options.inactiveOtherPoints&&t.setAllPointsToState("inactive")})}destroy(){const o=this;this.eventsToUnbind.forEach(t=>t()),this.eventsToUnbind=[],H.chartCount||(Pointer.unbindDocumentMouseUp&&Pointer.unbindDocumentMouseUp.forEach(t=>t()),Pointer.unbindDocumentTouchEnd&&(Pointer.unbindDocumentTouchEnd=Pointer.unbindDocumentTouchEnd())),clearInterval(o.tooltipTimeout),objectEach(o,function(t,e){o[e]=void 0})}getSelectionMarkerAttrs(a,c){var t={args:{chartX:a,chartY:c},attrs:{},shapeType:"rect"};return fireEvent(this,"getSelectionMarkerAttrs",t,t=>{const{chart:e,zoomHor:o,zoomVert:i}=this,{mouseDownX:s=0,mouseDownY:n=0}=e,r=t.attrs;let h;r.x=e.plotLeft,r.y=e.plotTop,r.width=o?1:e.plotWidth,r.height=i?1:e.plotHeight,o&&(h=a-s,r.width=Math.max(1,Math.abs(h)),r.x=(0<h?0:h)+s),i&&(h=c-n,r.height=Math.max(1,Math.abs(h)),r.y=(0<h?0:h)+n)}),t}drag(t){const e=this["chart"],{mouseDownX:o=0,mouseDownY:i=0}=e,{panning:s,panKey:n,selectionMarkerFill:r}=e.options.chart,h=e.plotLeft,a=e.plotTop,c=e.plotWidth,u=e.plotHeight,l=isObject(s)?s.enabled:s,d=n&&t[n+"Key"];let p=t.chartX,v=t.chartY,f,m=this.selectionMarker;var g,P;m&&m.touch||(p<h?p=h:p>h+c&&(p=h+c),v<a?v=a:v>a+u&&(v=a+u),this.hasDragged=Math.sqrt(Math.pow(o-p,2)+Math.pow(i-v,2)),10<this.hasDragged&&(f=e.isInsidePlot(o-h,i-a,{visiblePlotOnly:!0}),{shapeType:g,attrs:P}=this.getSelectionMarkerAttrs(p,v),(e.hasCartesianSeries||e.mapView)&&this.hasZoom&&f&&!d&&!m&&(this.selectionMarker=m=e.renderer[g](),m.attr({class:"highcharts-selection-marker",zIndex:7}).add(),e.styledMode||m.attr({fill:r||color("#334eff").setOpacity(.25).get()})),m&&m.attr(P),f&&!m&&l&&e.pan(t,s)))}dragStart(t){const e=this.chart;e.mouseIsDown=t.type,e.cancelClick=!1,e.mouseDownX=t.chartX,e.mouseDownY=t.chartY}getSelectionBox(t){t={args:{marker:t},result:t.getBBox()};return fireEvent(this,"getSelectionBox",t),t.result}drop(t){const{chart:e,selectionMarker:o}=this;let i;for(const n of e.axes)n.isPanning&&(n.isPanning=!1,(n.options.startOnTick||n.options.endOnTick||n.series.some(t=>t.boosted))&&(n.forceRedraw=!0,n.setExtremes(n.userMin,n.userMax,!1),i=!0));var s;i&&e.redraw(),o&&t&&(this.hasDragged&&(s=this.getSelectionBox(o),e.transform({axes:e.axes.filter(t=>t.zoomEnabled&&("xAxis"===t.coll&&this.zoomX||"yAxis"===t.coll&&this.zoomY)),selection:{originalEvent:t,xAxis:[],yAxis:[],...s},from:s})),isNumber(e.index)&&(this.selectionMarker=o.destroy())),e&&isNumber(e.index)&&(css(e.container,{cursor:e._cursor}),e.cancelClick=10<this.hasDragged,e.mouseIsDown=!1,this.hasDragged=0,this.pinchDown=[])}findNearestKDPoint(t,r,o){let i;return t.forEach(function(t){var e=!(t.noSharedTooltip&&r)&&t.options.findNearestPointBy.indexOf("y")<0,t=t.searchPoint(o,e);isObject(t,!0)&&t.series&&(!isObject(i,!0)||0<function(t,e){var o=t.distX-e.distX,i=t.dist-e.dist,s=e.series.group?.zIndex-t.series.group?.zIndex;let n;return n=0!=o&&r?o:0!=i?i:0!=s?s:t.series.index>e.series.index?-1:1}(i,t))&&(i=t)}),i}getChartCoordinatesFromPoint(o,i){var{xAxis:s,yAxis:n}=o.series,r=o.shapeArgs;if(s&&n){let t=o.clientX??o.plotX??0,e=o.plotY||0;return o.isNode&&r&&isNumber(r.x)&&isNumber(r.y)&&(t=r.x,e=r.y),i?{chartX:n.len+n.pos-e,chartY:s.len+s.pos-t}:{chartX:t+s.pos,chartY:e+n.pos}}if(r&&r.x&&r.y)return{chartX:r.x,chartY:r.y}}getChartPosition(){if(this.chartPosition)return this.chartPosition;var t=this.chart["container"],e=offset(t),{offsetHeight:t,offsetWidth:o}=(this.chartPosition={left:e.left,top:e.top,scaleX:1,scaleY:1},t);return 2<o&&2<t&&(this.chartPosition.scaleX=e.width/o,this.chartPosition.scaleY=e.height/t),this.chartPosition}getCoordinates(t){const e={xAxis:[],yAxis:[]};for(const o of this.chart.axes)e[o.isXAxis?"xAxis":"yAxis"].push({axis:o,value:o.toValue(t[o.horiz?"chartX":"chartY"])});return e}getHoverData(t,e,o,i,s,n){const r=[],h=!(!i||!t),a=function(t){return t.visible&&!(!s&&t.directTouch)&&pick(t.options.enableMouseTracking,!0)};let c=e,u,l={chartX:n?n.chartX:void 0,chartY:n?n.chartY:void 0,shared:s};fireEvent(this,"beforeGetHoverData",l);i=c&&!c.stickyTracking;u=i?[c]:o.filter(t=>t.stickyTracking&&(l.filter||a)(t));const d=h||!n?t:this.findNearestKDPoint(u,s,n);return c=d&&d.series,d&&(s&&!c.noSharedTooltip?(u=o.filter(function(t){return l.filter?l.filter(t):a(t)&&!t.noSharedTooltip})).forEach(function(t){let e=find(t.points,function(t){return t.x===d.x&&!t.isNull});isObject(e)&&(t.boosted&&t.boost&&(e=t.boost.getPoint(e)),r.push(e))}):r.push(d)),l={hoverPoint:d},fireEvent(this,"afterGetHoverData",l),{hoverPoint:l.hoverPoint,hoverSeries:c,hoverPoints:r}}getPointFromEvent(t){let e=t.target,o;for(;e&&!o;)o=e.point,e=e.parentNode;return o}onTrackerMouseOut(t){var e=this.chart,t=t.relatedTarget;const o=e.hoverSeries;this.isDirectTouch=!1,!o||!t||o.stickyTracking||this.inClass(t,"highcharts-tooltip")||this.inClass(t,"highcharts-series-"+o.index)&&this.inClass(t,"highcharts-tracker")||o.onMouseOut()}inClass(t,e){let o=t,i;for(;o;){if(i=attr(o,"class")){if(-1!==i.indexOf(e))return!0;if(-1!==i.indexOf("highcharts-container"))return!1}o=o.parentElement}}constructor(t,e){this.hasDragged=0,this.pointerCaptureEventsToUnbind=[],this.eventsToUnbind=[],this.options=e,this.chart=t,this.runChartClick=Boolean(e.chart.events?.click),this.pinchDown=[],this.setDOMEvents(),fireEvent(this,"afterInit")}normalize(t,e){const o=t.touches;var i=o?o.length?o.item(0):pick(o.changedTouches,t.changedTouches)[0]:t,s=(e=e||this.getChartPosition(),i.pageX-e.left),i=i.pageY-e.top;return s/=e.scaleX,i/=e.scaleY,extend(t,{chartX:Math.round(s),chartY:Math.round(i)})}onContainerClick(t){const e=this.chart,o=e.hoverPoint;var t=this.normalize(t),i=e.plotLeft,s=e.plotTop;e.cancelClick||(o&&this.inClass(t.target,"highcharts-tracker")?(fireEvent(o.series,"click",extend(t,{point:o})),e.hoverPoint&&o.firePointEvent("click",t)):(extend(t,this.getCoordinates(t)),e.isInsidePlot(t.chartX-i,t.chartY-s,{visiblePlotOnly:!0})&&fireEvent(e,"click",t)))}onContainerMouseDown(t){var e=1==(1&(t.buttons||t.button));t=this.normalize(t),H.isFirefox&&0!==t.button&&this.onContainerMouseMove(t),void 0!==t.button&&!e||(this.zoomOption(t),e&&t.preventDefault?.(),this.dragStart(t))}onContainerMouseLeave(t){const e=(charts[pick(Pointer.hoverChartIndex,-1)]||{})["pointer"];t=this.normalize(t),this.onContainerMouseMove(t),e&&!this.inClass(t.relatedTarget,"highcharts-tooltip")&&(e.reset(),e.chartPosition=void 0)}onContainerMouseEnter(){delete this.chartPosition}onContainerMouseMove(t){const e=this.chart,o=e.tooltip,i=this.normalize(t);this.setHoverChartIndex(t),"mousedown"!==e.mouseIsDown&&!this.touchSelect(i)||this.drag(i),e.openMenu||!this.inClass(i.target,"highcharts-tracker")&&!e.isInsidePlot(i.chartX-e.plotLeft,i.chartY-e.plotTop,{visiblePlotOnly:!0})||o&&o.shouldStickOnContact(i)||(this.inClass(i.target,"highcharts-no-tooltip")?this.reset(!1,0):this.runPointActions(i))}onDocumentTouchEnd(t){this.onDocumentMouseUp(t)}onContainerTouchMove(t){this.touchSelect(t)?this.onContainerMouseMove(t):this.touch(t)}onContainerTouchStart(t){this.touchSelect(t)?this.onContainerMouseDown(t):(this.zoomOption(t),this.touch(t,!0))}onDocumentMouseMove(t){const e=this.chart,o=e.tooltip;var i=this.chartPosition,t=this.normalize(t,i);!i||e.isInsidePlot(t.chartX-e.plotLeft,t.chartY-e.plotTop,{visiblePlotOnly:!0})||o&&o.shouldStickOnContact(t)||t.target!==e.container.ownerDocument&&this.inClass(t.target,"highcharts-tracker")||this.reset()}onDocumentMouseUp(t){charts[pick(Pointer.hoverChartIndex,-1)]?.pointer?.drop(t)}pinch(e){const o=this,{chart:i,hasZoom:t,lastTouches:s}=o,n=[].map.call(e.touches||[],t=>o.normalize(t)),r=n.length,h=1===r&&(o.inClass(e.target,"highcharts-tracker")&&i.runTrackerClick||o.runChartClick),a=i.tooltip,c=1===r&&pick(a?.options.followTouchMove,!0);1<r?o.initiated=!0:c&&(o.initiated=!1),t&&o.initiated&&!h&&!1!==e.cancelable&&e.preventDefault(),"touchstart"===e.type?(o.pinchDown=n,o.res=!0,i.mouseDownX=e.chartX):c?this.runPointActions(o.normalize(e)):s&&(fireEvent(i,"touchpan",{originalEvent:e,touches:n},()=>{var t=t=>{var e=t[0],t=t[1]||e;return{x:e.chartX,y:e.chartY,width:t.chartX-e.chartX,height:t.chartY-e.chartY}};i.transform({axes:i.axes.filter(t=>t.zoomEnabled&&(this.zoomHor&&t.horiz||this.zoomVert&&!t.horiz)),to:t(n),from:t(s),trigger:e.type})}),o.res&&(o.res=!1,this.reset(!1,0))),o.lastTouches=n}reset(e,t){const o=this.chart,i=o.hoverSeries,s=o.hoverPoint,n=o.hoverPoints,r=o.tooltip,h=r&&r.shared?n:s;e&&h&&splat(h).forEach(function(t){t.series.isCartesian&&void 0===t.plotX&&(e=!1)}),e?r&&h&&splat(h).length&&(r.refresh(h),r.shared&&n?n.forEach(function(t){t.setState(t.state,!0),t.series.isCartesian&&(t.series.xAxis.crosshair&&t.series.xAxis.drawCrosshair(null,t),t.series.yAxis.crosshair&&t.series.yAxis.drawCrosshair(null,t))}):s&&(s.setState(s.state,!0),o.axes.forEach(function(t){t.crosshair&&s.series[t.coll]===t&&t.drawCrosshair(null,s)}))):(s&&s.onMouseOut(),n&&n.forEach(function(t){t.setState()}),i&&i.onMouseOut(),r&&r.hide(t),this.unDocMouseMove&&(this.unDocMouseMove=this.unDocMouseMove()),o.axes.forEach(function(t){t.hideCrosshair()}),o.hoverPoints=o.hoverPoint=void 0)}runPointActions(i,t,e){const o=this,s=o.chart,n=s.series,r=s.tooltip&&s.tooltip.options.enabled?s.tooltip:void 0,h=!!r&&r.shared;let a=t||s.hoverPoint,c=a&&a.series||s.hoverSeries;var t=(!i||"touchmove"!==i.type)&&(!!t||c&&c.directTouch&&o.isDirectTouch),t=this.getHoverData(a,c,n,t,h,i);a=t.hoverPoint,c=t.hoverSeries;const u=t.hoverPoints,l=c&&c.tooltipOptions.followPointer&&!c.tooltipOptions.split,d=h&&c&&!c.noSharedTooltip;if(a&&(e||a!==s.hoverPoint||r&&r.isHidden)){if((s.hoverPoints||[]).forEach(function(t){-1===u.indexOf(t)&&t.setState()}),s.hoverSeries!==c&&c.onMouseOver(),o.applyInactiveState(u),(u||[]).forEach(function(t){t.setState("hover")}),s.hoverPoint&&s.hoverPoint.firePointEvent("mouseOut"),!a.series)return;s.hoverPoints=u,(s.hoverPoint=a).firePointEvent("mouseOver",void 0,()=>{r&&a&&r.refresh(d?u:a,i)})}else l&&r&&!r.isHidden&&(t=r.getAnchor([{}],i),s.isInsidePlot(t[0],t[1],{visiblePlotOnly:!0})&&r.updatePosition({plotX:t[0],plotY:t[1]}));o.unDocMouseMove||(o.unDocMouseMove=addEvent(s.container.ownerDocument,"mousemove",t=>charts[Pointer.hoverChartIndex??-1]?.pointer?.onDocumentMouseMove(t)),o.eventsToUnbind.push(o.unDocMouseMove)),s.axes.forEach(function(e){var t=pick((e.crosshair||{}).snap,!0);let o;(o=!t||(o=s.hoverPoint)&&o.series[e.coll]===e?o:find(u,t=>t.series&&t.series[e.coll]===e))||!t?e.drawCrosshair(i,o):e.hideCrosshair()})}setDOMEvents(){const t=this.chart.container,e=t.ownerDocument;t.onmousedown=this.onContainerMouseDown.bind(this),t.onmousemove=this.onContainerMouseMove.bind(this),t.onclick=this.onContainerClick.bind(this),this.eventsToUnbind.push(addEvent(t,"mouseenter",this.onContainerMouseEnter.bind(this)),addEvent(t,"mouseleave",this.onContainerMouseLeave.bind(this))),Pointer.unbindDocumentMouseUp||(Pointer.unbindDocumentMouseUp=[]),Pointer.unbindDocumentMouseUp.push(addEvent(e,"mouseup",this.onDocumentMouseUp.bind(this)));let o=this.chart.renderTo.parentElement;for(;o&&"BODY"!==o.tagName;)this.eventsToUnbind.push(addEvent(o,"scroll",()=>{delete this.chartPosition})),o=o.parentElement;this.eventsToUnbind.push(addEvent(t,"touchstart",this.onContainerTouchStart.bind(this),{passive:!1}),addEvent(t,"touchmove",this.onContainerTouchMove.bind(this),{passive:!1})),Pointer.unbindDocumentTouchEnd||(Pointer.unbindDocumentTouchEnd=addEvent(e,"touchend",this.onDocumentTouchEnd.bind(this),{passive:!1})),this.setPointerCapture(),addEvent(this.chart,"redraw",this.setPointerCapture.bind(this))}setPointerCapture(){if(isTouchDevice){const t=this,e=t.pointerCaptureEventsToUnbind,o=t.chart,i=o.container,s=pick(o.options.tooltip?.followTouchMove,!0),n=s&&o.series.some(t=>-1<t.options.findNearestPointBy.indexOf("y"));!t.hasPointerCapture&&n?(e.push(addEvent(i,"pointerdown",t=>{t.target?.hasPointerCapture(t.pointerId)&&t.target?.releasePointerCapture(t.pointerId)}),addEvent(i,"pointermove",t=>{o.pointer?.getPointFromEvent(t)?.onMouseOver(t)})),o.styledMode||css(i,{"touch-action":"none"}),i.className+=" highcharts-no-touch-action",t.hasPointerCapture=!0):t.hasPointerCapture&&!n&&(e.forEach(t=>t()),e.length=0,o.styledMode||css(i,{"touch-action":pick(o.options.chart.style?.["touch-action"],"manipulation")}),i.className=i.className.replace(" highcharts-no-touch-action",""),t.hasPointerCapture=!1)}}setHoverChartIndex(t){var e,o=this.chart;const i=H.charts[pick(Pointer.hoverChartIndex,-1)];i&&i!==o&&(e={relatedTarget:o.container},t&&!t?.relatedTarget&&(t={...e,...t}),i.pointer?.onContainerMouseLeave(t||e)),i&&i.mouseIsDown||(Pointer.hoverChartIndex=o.index)}touch(t,e){const{chart:o,pinchDown:i=[]}=this;let s;this.setHoverChartIndex(),1===(t=this.normalize(t)).touches.length?o.isInsidePlot(t.chartX-o.plotLeft,t.chartY-o.plotTop,{visiblePlotOnly:!0})&&!o.openMenu?(e&&this.runPointActions(t),"touchmove"===t.type&&(s=!!i[0]&&16<=Math.pow(i[0].chartX-t.chartX,2)+Math.pow(i[0].chartY-t.chartY,2)),pick(s,!0)&&this.pinch(t)):e&&this.reset():2===t.touches.length&&this.pinch(t)}touchSelect(t){return Boolean(this.chart.zooming.singleTouch&&t.touches&&1===t.touches.length)}zoomOption(t){var e=this.chart,o=e.inverted;let i=e.zooming.type||"",s,n;/touch/.test(t.type)&&(i=pick(e.zooming.pinchType,i)),this.zoomX=s=/x/.test(i),this.zoomY=n=/y/.test(i),this.zoomHor=s&&!o||n&&o,this.zoomVert=n&&!o||s&&o,this.hasZoom=s||n}}!function(e){e.compose=function(t){pushUnique(composed,"Core.Pointer")&&addEvent(t,"beforeRender",function(){this.pointer=new e(this,this.options)})}}(Pointer=Pointer||{});export default Pointer;