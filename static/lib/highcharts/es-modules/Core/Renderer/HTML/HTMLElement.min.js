"use strict";import AST from"./AST.js";import H from"../../Globals.js";const composed=H["composed"];import SVGElement from"../SVG/SVGElement.js";import U from"../../Utilities.js";const{attr,css,createElement,defined,extend,pInt,pushUnique}=U;function commonSetter(t,e,i){const s=this.div?.style||i.style;SVGElement.prototype[e+"Setter"].call(this,t,e,i),s&&(s[e]=t)}const decorateSVGGroup=(i,t)=>{if(!i.div){const e=attr(i.element,"class"),s=i.css,o=createElement("div",e?{className:e}:void 0,{position:"absolute",left:`${i.translateX||0}px`,top:`${i.translateY||0}px`,...i.styles,display:i.display,opacity:i.opacity,visibility:i.visibility},i.parentGroup?.div||t);i.classSetter=(t,e,i)=>{i.setAttribute("class",t),o.className=t},i.translateXSetter=i.translateYSetter=(t,e)=>{i[e]=t,o.style["translateX"===e?"left":"top"]=t+"px",i.doTransform=!0},i.opacitySetter=i.visibilitySetter=commonSetter,i.css=t=>(s.call(i,t),t.cursor&&(o.style.cursor=t.cursor),t.pointerEvents&&(o.style.pointerEvents=t.pointerEvents),i),i.on=function(){return SVGElement.prototype.on.apply({element:o,onEvents:i.onEvents},arguments),i},i.div=o}return i.div};class HTMLElement extends SVGElement{static compose(t){pushUnique(composed,this.compose)&&(t.prototype.html=function(t,e,i){return new HTMLElement(this,"span").attr({text:t,x:Math.round(e),y:Math.round(i)})})}constructor(t,e){super(t,e),this.css({position:"absolute",...t.styledMode?{}:{fontFamily:t.style.fontFamily,fontSize:t.style.fontSize}}),this.element.style.whiteSpace="nowrap"}getSpanCorrection(t,e,i){this.xCorr=-t*i,this.yCorr=-e}css(t){var e=this["element"],i="SPAN"===e.tagName&&t&&"width"in t,s=i&&t.width;let o;return i&&(delete t.width,this.textWidth=pInt(s)||void 0,o=!0),"ellipsis"===t?.textOverflow&&(t.whiteSpace="nowrap",t.overflow="hidden"),extend(this.styles,t),css(e,t),o&&this.updateTransform(),this}htmlGetBBox(){var t=this["element"];return{x:t.offsetLeft,y:t.offsetTop,width:t.offsetWidth,height:t.offsetHeight}}updateTransform(){if(!this.added)return void(this.alignOnAdd=!0);const{element:i,renderer:s,rotation:o,rotationOriginX:r,rotationOriginY:n,styles:a,textAlign:l="left",textWidth:p,translateX:t=0,translateY:e=0,x:h=0,y:d=0}=this,c={left:0,center:.5,right:1}[l],m=a.whiteSpace;var f=()=>this.textPxLength||(css(i,{width:"",whiteSpace:m||"nowrap"}),i.offsetWidth);if(css(i,{marginLeft:t+"px",marginTop:e+"px"}),"SPAN"===i.tagName){var x,S=[o,l,i.innerHTML,p,this.textAlign].join(","),u=-1*this.parentGroup?.padding||0;let t,e=!1;p!==this.oldTextWidth&&(f=f(),((x=p||0)>this.oldTextWidth||x<f)&&(/[ \-]/.test(i.textContent||i.innerText)||"ellipsis"===i.style.textOverflow)&&(css(i,{width:x<f||o?p+"px":"auto",display:"block",whiteSpace:m||"normal"}),this.oldTextWidth=p,e=!0)),this.hasBoxWidthChanged=e,S!==this.cTT&&(t=s.fontMetrics(i).b,!defined(o)||o===(this.oldRotation||0)&&l===this.oldAlign||this.setSpanRotation(o,u,u),this.getSpanCorrection(!defined(o)&&this.textPxLength||i.offsetWidth,t,c));const{xCorr:y=0,yCorr:g=0}=this,v=(r??h)-y-h-u,T=(n??d)-g-d-u,a={left:h+y+"px",top:d+g+"px",transformOrigin:v+`px ${T}px`};css(i,a),this.cTT=S,this.oldRotation=o,this.oldAlign=l}}setSpanRotation(t,e,i){css(this.element,{transform:`rotate(${t}deg)`,transformOrigin:e+`% ${i}px`})}add(e){const i=this.renderer.box.parentNode,s=[];let o;if((this.parentGroup=e)&&!(o=e.div)){let t=e;for(;t;)s.push(t),t=t.parentGroup;for(const e of s.reverse())o=decorateSVGGroup(e,i)}return(o||i).appendChild(this.element),this.added=!0,this.alignOnAdd&&this.updateTransform(),this}textSetter(t){t!==this.textStr&&(delete this.bBox,delete this.oldTextWidth,AST.setElementHTML(this.element,t??""),this.textStr=t,this.doTransform=!0)}alignSetter(t){this.alignValue=this.textAlign=t,this.doTransform=!0}xSetter(t,e){this[e]=t,this.doTransform=!0}}const proto=HTMLElement.prototype;proto.visibilitySetter=proto.opacitySetter=commonSetter,proto.ySetter=proto.rotationSetter=proto.rotationOriginXSetter=proto.rotationOriginYSetter=proto.xSetter;export default HTMLElement;