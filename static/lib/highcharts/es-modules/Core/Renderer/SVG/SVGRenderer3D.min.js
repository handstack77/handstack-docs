"use strict";import A from"../../Animation/AnimationUtilities.js";const animObject=A["animObject"];import Color from"../../Color/Color.js";const color=Color["parse"];import H from"../../Globals.js";const{charts,deg2rad}=H;import Math3D from"../../Math3D.js";const{perspective,shapeArea}=Math3D;import SVGElement3D from"./SVGElement3D.js";import U from"../../Utilities.js";const{defined,extend,merge,pick}=U,cos=Math.cos,sin=Math.sin,PI=Math.PI,dFactor=4*(Math.sqrt(2)-1)/3/(PI/2);function curveTo(t,e,s,n,a,i,o,r){var h=i-a;let c=[];return a<i&&i-a>Math.PI/2+1e-4?c=(c=c.concat(curveTo(t,e,s,n,a,a+Math.PI/2,o,r))).concat(curveTo(t,e,s,n,a+Math.PI/2,i,o,r)):i<a&&a-i>Math.PI/2+1e-4?c=(c=c.concat(curveTo(t,e,s,n,a,a-Math.PI/2,o,r))).concat(curveTo(t,e,s,n,a-Math.PI/2,i,o,r)):[["C",t+s*Math.cos(a)-s*dFactor*h*Math.sin(a)+o,e+n*Math.sin(a)+n*dFactor*h*Math.cos(a)+r,t+s*Math.cos(i)+s*dFactor*h*Math.sin(i)+o,e+n*Math.sin(i)-n*dFactor*h*Math.cos(i)+r,t+s*Math.cos(i)+o,e+n*Math.sin(i)+r]]}var SVGRenderer3D;!function(){function e(t,e){const s=[];for(const n of t)s.push(["L",n.x,n.y]);return t.length&&(s[0][0]="M",e&&s.push(["Z"])),s}function s(t){const e=[];let s=!0;for(const n of t)e.push(s?["M",n.x,n.y]:["L",n.x,n.y]),s=!s;return e}function n(t){const n=this,a=n.Element.prototype,e=n.createElement("path");return e.vertexes=[],e.insidePlotArea=!1,e.enabled=!0,e.attr=function(t){var e,s;return"object"==typeof t&&(defined(t.enabled)||defined(t.vertexes)||defined(t.insidePlotArea))&&(this.enabled=pick(t.enabled,this.enabled),this.vertexes=pick(t.vertexes,this.vertexes),this.insidePlotArea=pick(t.insidePlotArea,this.insidePlotArea),delete t.enabled,delete t.vertexes,delete t.insidePlotArea,s=charts[n.chartIndex],s=perspective(this.vertexes,s,this.insidePlotArea),e=n.toLinePath(s,!0),s=shapeArea(s),t.d=e,t.visibility=this.enabled&&0<s?"inherit":"hidden"),a.attr.apply(this,arguments)},e.animate=function(t){var e,s;return"object"==typeof t&&(defined(t.enabled)||defined(t.vertexes)||defined(t.insidePlotArea))&&(this.enabled=pick(t.enabled,this.enabled),this.vertexes=pick(t.vertexes,this.vertexes),this.insidePlotArea=pick(t.insidePlotArea,this.insidePlotArea),delete t.enabled,delete t.vertexes,delete t.insidePlotArea,s=charts[n.chartIndex],s=perspective(this.vertexes,s,this.insidePlotArea),e=n.toLinePath(s,!0),s=shapeArea(s),s=this.enabled&&0<s?"visible":"hidden",t.d=e,this.attr("visibility",s)),a.animate.apply(this,arguments)},e.attr(t)}function a(t){const a=this,i=a.Element.prototype,o=a.g(),e=o.destroy;return this.styledMode||o.attr({"stroke-linejoin":"round"}),o.faces=[],o.destroy=function(){for(let t=0;t<o.faces.length;t++)o.faces[t].destroy();return e.call(this)},o.attr=function(e,t,s,n){if("object"==typeof e&&defined(e.faces)){for(;o.faces.length>e.faces.length;)o.faces.pop().destroy();for(;o.faces.length<e.faces.length;)o.faces.push(a.face3d().add(o));for(let t=0;t<e.faces.length;t++)a.styledMode&&delete e.faces[t].fill,o.faces[t].attr(e.faces[t],null,s,n);delete e.faces}return i.attr.apply(this,arguments)},o.animate=function(e,s,n){if(e&&e.faces){for(;o.faces.length>e.faces.length;)o.faces.pop().destroy();for(;o.faces.length<e.faces.length;)o.faces.push(a.face3d().add(o));for(let t=0;t<e.faces.length;t++)o.faces[t].animate(e.faces[t],s,n);delete e.faces}return i.animate.apply(this,arguments)},o.attr(t)}function i(t,e){const s=new SVGElement3D.types[t](this,"g");return s.initArgs(e),s}function o(t){return this.element3d("cuboid",t)}function r(t){const e=t.x||0,s=t.y||0,n=t.z||0,a=t.height||0,i=t.width||0,o=t.depth||0,r=charts[this.chartIndex],h=r.options.chart.options3d,c=h.alpha,d=[];let l,p=0,f=[{x:e,y:s,z:n},{x:e+i,y:s,z:n},{x:e+i,y:s+a,z:n},{x:e,y:s+a,z:n},{x:e,y:s+a,z:n+o},{x:e+i,y:s+a,z:n+o},{x:e+i,y:s,z:n+o},{x:e,y:s,z:n+o}];f=perspective(f,r,t.insidePlotArea);const u=t=>0===a&&1<t&&t<6?{x:f[t].x,y:f[t].y+10,z:f[t].z}:f[0].x===f[7].x&&4<=t?{x:f[t].x+10,y:f[t].y,z:f[t].z}:0===o&&t<2||5<t?{x:f[t].x,y:f[t].y,z:f[t].z+10}:f[t],M=t=>f[t],y=(t,e,s)=>{var n=t.map(M),a=e.map(M),t=t.map(u),e=e.map(u);let i=[[],-1];return shapeArea(n)<0?i=[n,0]:shapeArea(a)<0?i=[a,1]:s&&(d.push(s),i=!(shapeArea(t)<0)&&shapeArea(e)<0?[a,1]:[n,0]),i};var t=(l=y([3,2,1,0],[7,6,5,4],"front"))[0],x=l[1],v=(l=y([1,6,7,0],[4,5,2,3],"top"))[0],m=l[1],P=(l=y([1,2,5,6],[0,7,4,3],"side"))[0],b=l[1];return 1===b?p+=1e6*(r.plotWidth-e):b||(p+=1e6*e),p+=10*(!m||0<=c&&c<=180||c<360&&357.5<c?r.plotHeight-s:10+s),1===x?p+=100*n:x||(p+=100*(1e3-n)),{front:this.toLinePath(t,!0),top:this.toLinePath(v,!0),side:this.toLinePath(P,!0),zIndexes:{group:Math.round(p)},forcedSides:d,isFront:x,isTop:m}}function h(t){const e=this,h=e.g(),c=e.Element.prototype,a=["x","y","r","innerR","start","end","depth"];function d(t){const e={};let s=!1,n;for(n in t=merge(t))-1!==a.indexOf(n)&&(e[n]=t[n],delete t[n],s=!0);return!!s&&[e,t]}(t=merge(t)).alpha=(t.alpha||0)*deg2rad,t.beta=(t.beta||0)*deg2rad,h.top=e.path(),h.side1=e.path(),h.side2=e.path(),h.inn=e.path(),h.out=e.path(),h.onAdd=function(){var t=h.parentGroup,e=h.attr("class");h.top.add(h);for(const s of["out","inn","side1","side2"])h[s].attr({class:e+" highcharts-3d-side"}).add(t)};for(const s of["addClass","removeClass"])h[s]=function(){var t=arguments;for(const e of["top","out","inn","side1","side2"])h[e][s].apply(h[e],t)};h.setPaths=function(t){var e=h.renderer.arc3dPath(t),s=100*e.zTop;h.attribs=t,h.top.attr({d:e.top,zIndex:e.zTop}),h.inn.attr({d:e.inn,zIndex:e.zInn}),h.out.attr({d:e.out,zIndex:e.zOut}),h.side1.attr({d:e.side1,zIndex:e.zSide1}),h.side2.attr({d:e.side2,zIndex:e.zSide2}),h.zIndex=s,h.attr({zIndex:s}),t.center&&(h.top.setRadialReference(t.center),delete t.center)},h.setPaths(t),h.fillSetter=function(t){var e=color(t).brighten(-.1).get();return this.fill=t,this.side1.attr({fill:e}),this.side2.attr({fill:e}),this.inn.attr({fill:e}),this.out.attr({fill:e}),this.top.attr({fill:t}),this};for(const n of["opacity","translateX","translateY","visibility"])h[n+"Setter"]=function(t,e){h[e]=t;for(const s of["out","inn","side1","side2","top"])h[s].attr(e,t)};return h.attr=function(t){var e;return"object"==typeof t&&(t=d(t))&&(e=t[0],arguments[0]=t[1],extend(h.attribs,e),h.setPaths(h.attribs)),c.attr.apply(h,arguments)},h.animate=function(t,e,s){const n=this.attribs,a="data-"+Math.random().toString(26).substring(2,9);let i,o;delete t.center,delete t.z,delete t.alpha,delete t.beta;const r=animObject(pick(e,this.renderer.globalAnimation));return r.duration&&(i=d(t),h[a]=0,t[a]=1,h[a+"Setter"]=H.noop,i&&(o=i[0],r.step=function(t,e){var s=t=>n[t]+(pick(o[t],n[t])-n[t])*e.pos;e.prop===a&&e.elem.setPaths(merge(n,{x:s("x"),y:s("y"),r:s("r"),innerR:s("innerR"),start:s("start"),end:s("end"),depth:s("depth")}))}),e=r),c.animate.call(this,t,e,s)},h.destroy=function(){return this.top.destroy(),this.out.destroy(),this.inn.destroy(),this.side1.destroy(),this.side2.destroy(),c.destroy.call(this)},h.hide=function(){this.top.hide(),this.out.hide(),this.inn.hide(),this.side1.hide(),this.side2.hide()},h.show=function(t){this.top.show(t),this.out.show(t),this.inn.show(t),this.side1.show(t),this.side2.show(t)},h}function c(t){var e=t.x||0,s=t.y||0,n=t.start||0,a=(t.end||0)-1e-5,i=t.r||0,o=t.innerR||0,r=t.depth||0,h=t.alpha||0,t=t.beta||0,c=Math.cos(n),d=Math.sin(n),l=Math.cos(a),p=Math.sin(a),f=i*Math.cos(t),i=i*Math.cos(h),u=o*Math.cos(t),o=o*Math.cos(h),M=r*Math.sin(t),r=r*Math.sin(h);let y=[["M",e+f*c,s+i*d]];(y=y.concat(curveTo(e,s,f,i,n,a,0,0))).push(["L",e+u*l,s+o*p]),(y=y.concat(curveTo(e,s,u,o,a,n,0,0))).push(["Z"]);var t=0<t?Math.PI/2:0,h=0<h?0:Math.PI/2,t=!(-t<n)&&-t<a?-t:n,x=!(a<PI-h)&&n<PI-h?PI-h:a,v=2*PI-h;let m=[["M",e+f*cos(t),s+i*sin(t)]],P=(m=m.concat(curveTo(e,s,f,i,t,x,0,0)),v<a&&n<v?(m.push(["L",e+f*cos(x)+M,s+i*sin(x)+r]),(m=m.concat(curveTo(e,s,f,i,x,v,M,r))).push(["L",e+f*cos(v),s+i*sin(v)]),(m=m.concat(curveTo(e,s,f,i,v,a,0,0))).push(["L",e+f*cos(a)+M,s+i*sin(a)+r]),(m=m.concat(curveTo(e,s,f,i,a,v,M,r))).push(["L",e+f*cos(v),s+i*sin(v)]),m=m.concat(curveTo(e,s,f,i,v,x,0,0))):a>PI-h&&n<PI-h&&(m.push(["L",e+f*Math.cos(x)+M,s+i*Math.sin(x)+r]),(m=m.concat(curveTo(e,s,f,i,x,a,M,r))).push(["L",e+f*Math.cos(a),s+i*Math.sin(a)]),m=m.concat(curveTo(e,s,f,i,a,x,0,0))),m.push(["L",e+f*Math.cos(x)+M,s+i*Math.sin(x)+r]),(m=m.concat(curveTo(e,s,f,i,x,t,M,r))).push(["Z"]),[["M",e+u*c,s+o*d]]);(P=P.concat(curveTo(e,s,u,o,n,a,0,0))).push(["L",e+u*Math.cos(a)+M,s+o*Math.sin(a)+r]),(P=P.concat(curveTo(e,s,u,o,a,n,M,r))).push(["Z"]);v=[["M",e+f*c,s+i*d],["L",e+f*c+M,s+i*d+r],["L",e+u*c+M,s+o*d+r],["L",e+u*c,s+o*d],["Z"]],h=[["M",e+f*l,s+i*p],["L",e+f*l+M,s+i*p+r],["L",e+u*l+M,s+o*p+r],["L",e+u*l,s+o*p],["Z"]],x=Math.atan2(r,-M),t=Math.abs(a+x),c=Math.abs(n+x),d=Math.abs((n+a)/2+x);function b(t){return t=(t%=2*Math.PI)>Math.PI?2*Math.PI-t:t}t=b(t),c=b(c),f=1e5*b(d),i=1e5*c,e=1e5*t;return{top:y,zTop:1e5*Math.PI+1,out:m,zOut:Math.max(f,i,e),inn:P,zInn:Math.max(f,i,e),side1:v,zSide1:.99*e,side2:h,zSide2:.99*i}}(SVGRenderer3D||(SVGRenderer3D={})).compose=function(t){(t=t.prototype).element3d||extend(t,{Element3D:SVGElement3D,arc3d:h,arc3dPath:c,cuboid:o,cuboidPath:r,element3d:i,face3d:n,polyhedron:a,toLinePath:e,toLineSegments:s})}}();export default SVGRenderer3D;