"use strict";import AST from"../HTML/AST.js";import D from"../../Defaults.js";const defaultOptions=D["defaultOptions"];import Color from"../../Color/Color.js";import H from"../../Globals.js";const{charts,deg2rad,doc,isFirefox,isMS,isWebKit,noop,SVG_NS,symbolSizes,win}=H;import RendererRegistry from"../RendererRegistry.js";import SVGElement from"./SVGElement.js";import SVGLabel from"./SVGLabel.js";import Symbols from"./Symbols.js";import TextBuilder from"./TextBuilder.js";import U from"../../Utilities.js";const{addEvent,attr,createElement,crisp,css,defined,destroyObjectProperties,extend,isArray,isNumber,isObject,isString,merge,pick,pInt,replaceNested,uniqueKey}=U;let hasInternalReferenceBug;class SVGRenderer{constructor(t,e,i,r,s,n,o){const a=this,h=a.createElement("svg").attr({version:"1.1",class:"highcharts-root"}),l=h.element,d=(o||h.css(this.getStyle(r||{})),t.appendChild(l),attr(t,"dir","ltr"),-1===t.innerHTML.indexOf("xmlns")&&attr(l,"xmlns",this.SVG_NS),this.box=l,this.boxWrapper=h,this.alignedObjects=[],this.url=this.getReferenceURL(),this.createElement("desc").add());d.element.appendChild(doc.createTextNode("Created with @product.name@ @product.version@")),this.defs=this.createElement("defs").add(),this.allowHTML=n,this.forExport=s,this.styledMode=o,this.gradients={},this.cache={},this.cacheKeys=[],this.imgCount=0,this.rootFontSize=h.getStyle("font-size"),a.setSize(e,i,!1);let c,m;isFirefox&&t.getBoundingClientRect&&((c=function(){css(t,{left:0,top:0}),m=t.getBoundingClientRect(),css(t,{left:Math.ceil(m.left)-m.left+"px",top:Math.ceil(m.top)-m.top+"px"})})(),a.unSubPixelFix=addEvent(win,"resize",c))}definition(t){const e=new AST([t]);return e.addToDOM(this.defs.element)}getReferenceURL(){if((isFirefox||isWebKit)&&doc.getElementsByTagName("base").length){if(!defined(hasInternalReferenceBug)){var t=uniqueKey();const i=new AST([{tagName:"svg",attributes:{width:8,height:8},children:[{tagName:"defs",children:[{tagName:"clipPath",attributes:{id:t},children:[{tagName:"rect",attributes:{width:4,height:4}}]}]},{tagName:"rect",attributes:{id:"hitme",width:8,height:8,"clip-path":`url(#${t})`,fill:"rgba(0,0,0,0.001)"}}]}]);var t=i.addToDOM(doc.body),e=(css(t,{position:"fixed",top:0,left:0,zIndex:9e5}),doc.elementFromPoint(6,6));hasInternalReferenceBug="hitme"===(e&&e.id),doc.body.removeChild(t)}if(hasInternalReferenceBug)return replaceNested(win.location.href.split("#")[0],[/<[^>]*>/g,""],[/([\('\)])/g,"\\$1"],[/ /g,"%20"])}return""}getStyle(t){return this.style=extend({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"1rem"},t),this.style}setStyle(t){this.boxWrapper.css(this.getStyle(t))}isHidden(){return!this.boxWrapper.getBBox().width}destroy(){const t=this,e=t.defs;return t.box=null,t.boxWrapper=t.boxWrapper.destroy(),destroyObjectProperties(t.gradients||{}),t.gradients=null,t.defs=e.destroy(),t.unSubPixelFix&&t.unSubPixelFix(),t.alignedObjects=null}createElement(t){return new this.Element(this,t)}getRadialAttr(t,e){return{cx:t[0]-t[2]/2+(e.cx||0)*t[2],cy:t[1]-t[2]/2+(e.cy||0)*t[2],r:(e.r||0)*t[2]}}shadowDefinition(e){var t=["highcharts-drop-shadow-"+this.chartIndex,...Object.keys(e).map(t=>t+"-"+e[t])].join("-").toLowerCase().replace(/[^a-z\d\-]/g,""),i=merge({color:"#000000",offsetX:1,offsetY:1,opacity:.15,width:5},e);return this.defs.element.querySelector("#"+t)||this.definition({tagName:"filter",attributes:{id:t,filterUnits:i.filterUnits},children:this.getShadowFilterContent(i)}),t}getShadowFilterContent(t){return[{tagName:"feDropShadow",attributes:{dx:t.offsetX,dy:t.offsetY,"flood-color":t.color,"flood-opacity":Math.min(5*t.opacity,1),stdDeviation:t.width/2}}]}buildText(t){new TextBuilder(t).buildSVG()}getContrast(t){t=Color.parse(t).rgba.map(t=>{t/=255;return t<=.03928?t/12.92:Math.pow((.055+t)/1.055,2.4)}),t=.2126*t[0]+.7152*t[1]+.0722*t[2];return(.05+t)/.05<1.05/(.05+t)?"#FFFFFF":"#000000"}button(t,e,i,r,s={},n,o,a,h,l){const d=this.label(t,e,i,h,void 0,void 0,l,void 0,"button"),c=this.styledMode,m=arguments;let u=0;s=merge(defaultOptions.global.buttonTheme,s),c&&(delete s.fill,delete s.stroke,delete s["stroke-width"]);const g=s.states||{},p=s.style||{},f=(delete s.states,delete s.style,[AST.filterUserAttributes(s)]),b=[p];return c||["hover","select","disabled"].forEach((t,e)=>{f.push(merge(f[0],AST.filterUserAttributes(m[e+5]||g[t]||{}))),b.push(f[e+1].style),delete f[e+1].style}),addEvent(d.element,isMS?"mouseover":"mouseenter",function(){3!==u&&d.setState(1)}),addEvent(d.element,isMS?"mouseout":"mouseleave",function(){3!==u&&d.setState(u)}),d.setState=(t=0)=>{1!==t&&(d.state=u=t),d.removeClass(/highcharts-button-(normal|hover|pressed|disabled)/).addClass("highcharts-button-"+["normal","hover","pressed","disabled"][t]),c||(d.attr(f[t]),t=b[t],isObject(t)&&d.css(t))},d.attr(f[0]),c||(d.css(extend({cursor:"default"},p)),l&&d.text.css({pointerEvents:"none"})),d.on("touchstart",t=>t.stopPropagation()).on("click",function(t){3!==u&&r.call(d,t)})}crispLine(t,e){const[i,r]=t;return defined(i[1])&&i[1]===r[1]&&(i[1]=r[1]=crisp(i[1],e)),defined(i[2])&&i[2]===r[2]&&(i[2]=r[2]=crisp(i[2],e)),t}path(t){const e=this.styledMode?{}:{fill:"none"};return isArray(t)?e.d=t:isObject(t)&&extend(e,t),this.createElement("path").attr(e)}circle(t,e,i){const r=isObject(t)?t:void 0===t?{}:{x:t,y:e,r:i},s=this.createElement("circle");return s.xSetter=s.ySetter=function(t,e,i){i.setAttribute("c"+e,t)},s.attr(r)}arc(t,e,i,r,s,n){let o;isObject(t)?(e=(o=t).y,i=o.r,r=o.innerR,s=o.start,n=o.end,t=o.x):o={innerR:r,start:s,end:n};const a=this.symbol("arc",t,e,i,i,o);return a.r=i,a}rect(t,e,i,r,s,n){const o=isObject(t)?t:void 0===t?{}:{x:t,y:e,r:s,width:Math.max(i||0,0),height:Math.max(r||0,0)},a=this.createElement("rect");return this.styledMode||(void 0!==n&&(o["stroke-width"]=n,extend(o,a.crisp(o))),o.fill="none"),a.rSetter=function(t,e,i){a.r=t,attr(i,{rx:t,ry:t})},a.rGetter=function(){return a.r||0},a.attr(o)}roundedRect(t){return this.symbol("roundedRect").attr(t)}setSize(t,e,i){this.width=t,this.height=e,this.boxWrapper.animate({width:t,height:e},{step:function(){this.attr({viewBox:"0 0 "+this.attr("width")+" "+this.attr("height")})},duration:pick(i,!0)?void 0:0}),this.alignElements()}g(t){const e=this.createElement("g");return t?e.attr({class:"highcharts-"+t}):e}image(e,t,i,r,s,n){function o(t){h.attr({href:e}),n.call(h,t)}const a={preserveAspectRatio:"none"},h=(isNumber(t)&&(a.x=t),isNumber(i)&&(a.y=i),isNumber(r)&&(a.width=r),isNumber(s)&&(a.height=s),this.createElement("image").attr(a));if(n){h.attr({href:"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="});const l=new win.Image;addEvent(l,"load",o),l.src=e,l.complete&&o({})}else h.attr({href:e});return h}symbol(t,e,i,r,s,d){const n=this,o=/^url\((.*?)\)$/,a=o.test(t),h=!a&&(this.symbols[t]?t:"circle"),l=h&&this.symbols[h];let c,m,u,g;if(l)"number"==typeof e&&(m=l.call(this.symbols,e||0,i||0,r||0,s||0,d)),c=this.path(m),n.styledMode||c.attr("fill","none"),extend(c,{symbolName:h||void 0,x:e,y:i,width:r,height:s}),d&&extend(c,d);else if(a){u=t.match(o)[1];const p=c=this.image(u);p.imgwidth=pick(d&&d.width,symbolSizes[u]&&symbolSizes[u].width),p.imgheight=pick(d&&d.height,symbolSizes[u]&&symbolSizes[u].height),g=t=>t.attr({width:t.width,height:t.height}),["width","height"].forEach(t=>{p[t+"Setter"]=function(t,e){this[e]=t;const{alignByTranslate:i,element:r,width:s,height:n,imgwidth:o,imgheight:a}=this,h="width"===e?o:a;let l=1;d&&"within"===d.backgroundSize&&s&&n&&o&&a?(l=Math.min(s/o,n/a),attr(r,{width:Math.round(o*l),height:Math.round(a*l)})):r&&h&&r.setAttribute(e,h),!i&&o&&a&&this.translate(((s||0)-o*l)/2,((n||0)-a*l)/2)}}),defined(e)&&p.attr({x:e,y:i}),p.isImg=!0,p.symbolUrl=t,defined(p.imgwidth)&&defined(p.imgheight)?g(p):(p.attr({width:0,height:0}),createElement("img",{onload:function(){const t=charts[n.chartIndex];0===this.width&&(css(this,{position:"absolute",top:"-999em"}),doc.body.appendChild(this)),symbolSizes[u]={width:this.width,height:this.height},p.imgwidth=this.width,p.imgheight=this.height,p.element&&g(p),this.parentNode&&this.parentNode.removeChild(this),n.imgCount--,n.imgCount||!t||t.hasLoaded||t.onload()},src:u}),this.imgCount++)}return c}clipRect(t,e,i,r){return this.rect(t,e,i,r,0)}text(t,e,i,r){const s=this,n={};if(r&&(s.allowHTML||!s.forExport))return s.html(t,e,i);n.x=Math.round(e||0),i&&(n.y=Math.round(i)),defined(t)&&(n.text=t);const o=s.createElement("text").attr(n);return r&&(!s.forExport||s.allowHTML)||(o.xSetter=function(i,r,t){var s=t.getElementsByTagName("tspan"),n=t.getAttribute(r);for(let t=0,e;t<s.length;t++)(e=s[t]).getAttribute(r)===n&&e.setAttribute(r,i);t.setAttribute(r,i)}),o}fontMetrics(t){var t=pInt(SVGElement.prototype.getStyle.call(t,"font-size")||0),e=t<24?t+3:Math.round(1.2*t);return{h:e,b:Math.round(.8*e),f:t}}rotCorr(t,e,i){let r=t;return e&&i&&(r=Math.max(r*Math.cos(e*deg2rad),4)),{x:-t/3*Math.sin(e*deg2rad),y:r}}pathToSegments(e){const i=[],r=[];var s={A:8,C:7,H:2,L:3,M:3,Q:5,S:5,T:3,V:2};for(let t=0;t<e.length;t++)isString(r[0])&&isNumber(e[t])&&r.length===s[r[0].toUpperCase()]&&e.splice(t,0,r[0].replace("M","L").replace("m","l")),"string"==typeof e[t]&&(r.length&&i.push(r.slice(0)),r.length=0),r.push(e[t]);return i.push(r.slice(0)),i}label(t,e,i,r,s,n,o,a,h){return new SVGLabel(this,t,e,i,r,s,n,o,a,h)}alignElements(){this.alignedObjects.forEach(t=>t.align())}}extend(SVGRenderer.prototype,{Element:SVGElement,SVG_NS:SVG_NS,escapes:{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},symbols:Symbols,draw:noop}),RendererRegistry.registerRendererType("svg",SVGRenderer,!0);export default SVGRenderer;