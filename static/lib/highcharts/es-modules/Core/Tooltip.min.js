"use strict";import A from"./Animation/AnimationUtilities.js";const animObject=A["animObject"];import F from"./Templating.js";const format=F["format"];import H from"./Globals.js";const{composed,doc,isSafari}=H;import R from"./Renderer/RendererUtilities.js";const distribute=R["distribute"];import RendererRegistry from"./Renderer/RendererRegistry.js";import U from"./Utilities.js";const{addEvent,clamp,css,discardElement,extend,fireEvent,isArray,isNumber,isString,merge,pick,pushUnique,splat,syncTimeout}=U;class Tooltip{constructor(t,e,i){this.allowShared=!0,this.crosshairs=[],this.distance=0,this.isHidden=!0,this.isSticky=!1,this.options={},this.outside=!1,this.chart=t,this.init(t,e),this.pointer=i}bodyFormatter(t){return t.map(function(t){const e=t.series.tooltipOptions;return(e[(t.point.formatPrefix||"point")+"Formatter"]||t.point.tooltipFormatter).call(t.point,e[(t.point.formatPrefix||"point")+"Format"]||"")})}cleanSplit(i){this.chart.series.forEach(function(t){const e=t&&t.tt;e&&(!e.isActive||i?t.tt=e.destroy():e.isActive=!1)})}defaultFormatter(t){var e=this.points||splat(this);let i;return(i=(i=[t.tooltipFooterHeaderFormatter(e[0])]).concat(t.bodyFormatter(e))).push(t.tooltipFooterHeaderFormatter(e[0],!0)),i}destroy(){this.label&&(this.label=this.label.destroy()),this.split&&(this.cleanSplit(!0),this.tt&&(this.tt=this.tt.destroy())),this.renderer&&(this.renderer=this.renderer.destroy(),discardElement(this.container)),U.clearTimeout(this.hideTimer)}getAnchor(t,o){const{chart:e,pointer:i}=this,r=e.inverted,s=e.plotTop,a=e.plotLeft;let n;if((t=splat(t))[0].series&&t[0].series.yAxis&&!t[0].series.yAxis.options.reversedStacks&&(t=t.slice().reverse()),this.followPointer&&o)void 0===o.chartX&&(o=i.normalize(o)),n=[o.chartX-a,o.chartY-s];else if(t[0].tooltipPos)n=t[0].tooltipPos;else{let e=0,i=0;t.forEach(function(t){t=t.pos(!0);t&&(e+=t[0],i+=t[1])}),e/=t.length,i/=t.length,this.shared&&1<t.length&&o&&(r?e=o.chartX:i=o.chartY),n=[e-a,i-s]}return n.map(Math.round)}getClassName(t,e,i){const o=this.options,r=t.series,s=r.options;return[o.className,"highcharts-label",i&&"highcharts-tooltip-header",e?"highcharts-tooltip-box":"highcharts-tooltip",!i&&"highcharts-color-"+pick(t.colorIndex,r.colorIndex),s&&s.className].filter(isString).join(" ")}getLabel({anchorX:t,anchorY:e}={anchorX:0,anchorY:0}){const o=this,i=this.chart.styledMode,r=this.options,s=this.split&&this.allowShared;let a=this.container,n=this.chart.renderer;var l;if(this.label&&(l=!this.label.hasClass("highcharts-label"),(!s&&l||s&&!l)&&this.destroy()),!this.label){if(this.outside){const h=this.chart.options.chart.style,c=RendererRegistry.getRendererType();this.container=a=H.doc.createElement("div"),a.className="highcharts-tooltip-container",css(a,{position:"absolute",top:"1px",pointerEvents:"none",zIndex:Math.max(this.options.style.zIndex||0,(h&&h.zIndex||0)+3)}),this.renderer=n=new c(a,0,0,h,void 0,void 0,n.styledMode)}if(s?this.label=n.g("tooltip"):(this.label=n.label("",t,e,r.shape,void 0,void 0,r.useHTML,void 0,"tooltip").attr({padding:r.padding,r:r.borderRadius}),i||this.label.attr({fill:r.backgroundColor,"stroke-width":r.borderWidth||0}).css(r.style).css({pointerEvents:r.style.pointerEvents||(this.shouldStickOnContact()?"auto":"none")})),o.outside){const d=this.label;[d.xSetter,d.ySetter].forEach((e,i)=>{d[i?"ySetter":"xSetter"]=t=>{e.call(d,o.distance),d[i?"y":"x"]=t,a&&(a.style[i?"top":"left"]=t+"px")}})}this.label.attr({zIndex:8}).shadow(r.shadow).add()}return a&&!a.parentElement&&H.doc.body.appendChild(a),this.label}getPlayingField(){var{body:t,documentElement:e}=doc,{chart:i,distance:o,outside:r}=this;return{width:r?Math.max(t.scrollWidth,e.scrollWidth,t.offsetWidth,e.offsetWidth,e.clientWidth)-2*o:i.chartWidth,height:r?Math.max(t.scrollHeight,e.scrollHeight,t.offsetHeight,e.offsetHeight,e.clientHeight):i.chartHeight}}getPosition(i,o,t){const{distance:p,chart:r,outside:f,pointer:e}=this,{inverted:s,plotLeft:a,plotTop:n,polar:l}=r,{plotX:h=0,plotY:c=0}=t,g={},m=s&&t.h||0,{height:d,width:u}=this.getPlayingField(),x=e.getChartPosition(),y=t=>t*x.scaleX,b=t=>t*x.scaleY,v=t=>{var e="x"===t;return[t,e?u:d,e?i:o].concat(f?[e?y(i):b(o),e?x.left-p+y(h+a):x.top-p+b(c+n),0,e?u:d]:[e?i:o,e?h+a:c+n,e?a:n,e?a+r.plotWidth:n+r.plotHeight])};let w=v("y"),S=v("x"),k,T=!!t.negative;!l&&r.hoverSeries?.yAxis?.reversed&&(T=!T);const H=!this.followPointer&&pick(t.ttBelow,!l&&!s===T),M=function(t,e,i,o,r,s,a){var n=f?("y"===t?b:y)(p):p,l=(i-o)/2,h=o<r-p,c=r+p+o<e,d=r-n-i+l,r=r+n-l;if(H&&c)g[t]=r;else if(!H&&h)g[t]=d;else if(h)g[t]=Math.min(a-o,d-m<0?d:d-m);else{if(!c)return!1;g[t]=Math.max(s,r+m+i>e?r:r+m)}},X=function(t,e,i,o,r){if(r<p||r>e-p)return!1;g[t]=r<i/2?1:e-o/2<r?e-o-2:r-i/2},F=function(t){[w,S]=[S,w],k=t},P=()=>{!1!==M.apply(0,w)?!1!==X.apply(0,S)||k||(F(!0),P()):k?g.x=g.y=0:(F(!0),P())};return(s&&!l||1<this.len)&&F(),P(),g}hide(e){const i=this;U.clearTimeout(this.hideTimer),e=pick(e,this.options.hideDelay),this.isHidden||(this.hideTimer=syncTimeout(function(){const t=i.getLabel();i.getLabel().animate({opacity:0},{duration:e&&150,complete:()=>{t.hide(),i.container&&i.container.remove()}}),i.isHidden=!0},e))}init(t,e){this.chart=t,this.options=e,this.crosshairs=[],this.isHidden=!0,this.split=e.split&&!t.inverted&&!t.polar,this.shared=e.shared||this.split,this.outside=pick(e.outside,Boolean(t.scrollablePixelsX||t.scrollablePixelsY))}shouldStickOnContact(t){return!(this.followPointer||!this.options.stickOnContact||t&&!this.pointer.inClass(t.target,"highcharts-tooltip"))}move(t,e,i,o){const r=this,s=animObject(!r.isHidden&&r.options.animation),a=r.followPointer||1<(r.len||0),n={x:t,y:e};a||(n.anchorX=i,n.anchorY=o),s.step=()=>r.drawTracker(),r.getLabel().animate(n,s)}refresh(t,o){const r=this,{chart:s,options:a,pointer:n,shared:e}=this,l=splat(t),h=l[0],i=[],c=a.format,d=a.formatter||r.defaultFormatter,p=s.styledMode;let f={},g=r.allowShared;if(a.enabled&&h.series){U.clearTimeout(this.hideTimer),r.allowShared=!(!isArray(t)&&t.series&&t.series.noSharedTooltip),g=g&&!r.allowShared,r.followPointer=!r.split&&h.series.tooltipOptions.followPointer;var t=r.getAnchor(t,o),m=t[0],u=t[1];e&&r.allowShared?(n.applyInactiveState(l),l.forEach(function(t){t.setState("hover"),i.push(t.getLabelConfig())}),(f=h.getLabelConfig()).points=i):f=h.getLabelConfig(),this.len=i.length;const y=isString(c)?format(c,f,s):d.call(f,r);var x=h.series;if(this.distance=pick(x.tooltipOptions.distance,16),!1===y)this.hide();else{if(r.split&&r.allowShared)this.renderSplit(y,l);else{let e=m,i=u;if(o&&n.isDirectTouch&&(e=o.chartX-s.plotLeft,i=o.chartY-s.plotTop),!s.polar&&!1!==x.options.clip&&!l.some(t=>n.isDirectTouch||t.series.shouldShowTooltip(e,i)))return void r.hide();{const b=r.getLabel(g&&r.tt||{});a.style.width&&!p||b.css({width:(this.outside?this.getPlayingField():s.spacingBox).width+"px"}),b.attr({class:r.getClassName(h),text:y&&y.join?y.join(""):y}),this.outside&&b.attr({x:clamp(b.x||0,0,this.getPlayingField().width-(b.width||0))}),p||b.attr({stroke:a.borderColor||h.color||x.color||"#666666"}),r.updatePosition({plotX:m,plotY:u,negative:h.negative,ttBelow:h.ttBelow,h:t[2]||0})}}r.isHidden&&r.label&&r.label.attr({opacity:1}).show(),r.isHidden=!1}fireEvent(this,"refresh")}}renderSplit(t,c){const d=this,{chart:e,chart:{chartWidth:i,chartHeight:o,plotHeight:p,plotLeft:f,plotTop:g,scrollablePixelsY:r=0,scrollablePixelsX:s,styledMode:m},distance:u,options:x,options:{positioner:y},pointer:a}=d;var n,{scrollLeft:l=0,scrollTop:h=0}=e.scrollablePlotArea?.scrollingContainer||{};const b=d.outside&&"number"!=typeof s?doc.documentElement.getBoundingClientRect():{left:l,right:l+i,top:h,bottom:h+o},v=d.getLabel(),w=this.renderer||e.renderer,S=Boolean(e.xAxis[0]&&e.xAxis[0].opposite),{left:k,top:T}=a.getChartPosition();let H=g+h,M,X=p-r;function F(t,e,i,o,r=!0){let s,a;return{x:a=i?(s=S?0:X,clamp(t-o/2,b.left,b.right-o-(d.outside?k:0))):(s=e-H,a=r?t-o-u:t+u,clamp(a,r?a:b.left,b.right)),y:s}}let P=(t=isString(t)?[!1,t]:t).slice(0,c.length+1).reduce(function(t,e,i){if(!1!==e&&""!==e){var i=c[i-1]||{isHeader:!0,plotX:c[0].plotX,plotY:p,series:{}},o=i.isHeader;const l=o?d:i.series,h=l.tt=function(t,e,i){let o=t;var{isHeader:t,series:r}=e;if(!o){const s={padding:x.padding,r:x.borderRadius};m||(s.fill=x.backgroundColor,s["stroke-width"]=x.borderWidth??1),o=w.label("",0,0,x[t?"headerShape":"shape"],void 0,void 0,x.useHTML).addClass(d.getClassName(e,!0,t)).attr(s).add(v)}return o.isActive=!0,o.attr({text:i}),m||o.css(x.style).attr({stroke:x.borderColor||e.color||r.color||"#333333"}),o}(l.tt,i,e.toString());var r,e=h.getBBox(),s=e.width+h.strokeWidth(),{anchorX:a,anchorY:n}=(o&&(M=e.height,X+=M,S&&(H-=M)),function(t){const{isHeader:e,plotX:i=0,plotY:o=0,series:r}=t;let s,a;var n;return e?(s=Math.max(f+i,f),a=g+p/2):({xAxis:t,yAxis:n}=r,s=t.pos+clamp(i,-u,t.len+u),r.shouldShowTooltip(0,n.pos-g+o,{ignoreX:!0})&&(a=n.pos+o)),{anchorX:s=clamp(s,b.left-u,b.right+u),anchorY:a}}(i));"number"==typeof n?(e=e.height+1,r=y?y.call(d,s,e,i):F(a,n,o,s),t.push({align:y?0:void 0,anchorX:a,anchorY:n,boxWidth:s,point:i,rank:pick(r.rank,o?1:0),size:e,target:r.y,tt:h,x:r.x})):h.isActive=!1}return t},[]);!y&&P.some(t=>{var e=d["outside"],e=(e?k:0)+t.anchorX;return e<b.left&&e+t.boxWidth<b.right||e<k-b.left+t.boxWidth&&b.right-e>e})&&(P=P.map(t=>{var{x:e,y:i}=F(t.anchorX,t.anchorY,t.point.isHeader,t.boxWidth,!1);return extend(t,{target:i,x:e})})),d.cleanSplit(),distribute(P,X);const C={left:k,right:k},{container:A,outside:Y,renderer:E}=(P.forEach(function(t){var{x:t,boxWidth:e,isHeader:i}=t;i||(d.outside&&k+t<C.left&&(C.left=k+t),!i&&d.outside&&C.left+e>C.right&&(C.right=k+t))}),P.forEach(function(t){var{x:e,anchorX:i,anchorY:o,pos:r,point:{isHeader:s}}=t;const a={visibility:void 0===r?"hidden":"inherit",x:e,y:(r||0)+H,anchorX:i,anchorY:o};d.outside&&e<i&&(0<(r=k-C.left)&&(s||(a.x=e+r,a.anchorX=i+r),s&&(a.x=(C.right-C.left)/2,a.anchorX=i+r))),t.tt.attr(a)}),d);Y&&A&&E&&({width:l,height:h,x:t,y:n}=v.getBBox(),E.setSize(l+t,h+n,!1),A.style.left=C.left+"px",A.style.top=T+"px"),isSafari&&v.attr({opacity:1===v.opacity?.999:1})}drawTracker(){var t=this;if(this.shouldStickOnContact()){var e=t.chart;const o=t.label;var i=t.shared?e.hoverPoints:e.hoverPoint;if(o&&i){const r={x:0,y:0,width:0,height:0},s=this.getAnchor(i);i=o.getBBox();s[0]+=e.plotLeft-(o.translateX||0),s[1]+=e.plotTop-(o.translateY||0),r.x=Math.min(0,s[0]),r.y=Math.min(0,s[1]),r.width=s[0]<0?Math.max(Math.abs(s[0]),i.width-s[0]):Math.max(Math.abs(s[0]),i.width),r.height=s[1]<0?Math.max(Math.abs(s[1]),i.height-Math.abs(s[1])):Math.max(Math.abs(s[1]),i.height),t.tracker?t.tracker.attr(r):(t.tracker=o.renderer.rect(r).addClass("highcharts-tracker").add(o),e.styledMode||t.tracker.attr({fill:"rgba(0,0,0,0)"}))}}else t.tracker&&(t.tracker=t.tracker.destroy())}styledModeFormat(t){return t.replace('style="font-size: 0.8em"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex} {series.options.className} {point.options.className}"')}tooltipFooterHeaderFormatter(e,t){const i=e.series,o=i.tooltipOptions,r=i.xAxis,s=r&&r.dateTime,a={isFooter:t,labelConfig:e};let n=o.xDateFormat,l=o[t?"footerFormat":"headerFormat"];return fireEvent(this,"headerFormatter",a,function(t){s&&!n&&isNumber(e.key)&&(n=s.getXDateFormat(e.key,o.dateTimeLabelFormats)),s&&n&&(e.point&&e.point.tooltipDateKeys||["key"]).forEach(function(t){l=l.replace("{point."+t+"}","{point."+t+":"+n+"}")}),i.chart.styledMode&&(l=this.styledModeFormat(l)),t.text=format(l,{point:e,series:i},this.chart)}),a.text}update(t){this.destroy(),this.init(this.chart,merge(!0,this.options,t))}updatePosition(t){const{chart:e,container:i,distance:o,options:r,pointer:s,renderer:a}=this,{height:n=0,width:l=0}=this.getLabel(),{left:h,top:c,scaleX:d,scaleY:p}=s.getChartPosition(),f=(r.positioner||this.getPosition).call(this,l,n,t);let g=(t.plotX||0)+e.plotLeft,m=(t.plotY||0)+e.plotTop,u;a&&i&&(r.positioner&&(f.x+=h-o,f.y+=c-o),u=(r.borderWidth||0)+2*o+2,a.setSize(l+u,n+u,!1),1===d&&1===p||(css(i,{transform:`scale(${d}, ${p})`}),g*=d,m*=p),g+=h-f.x,m+=c-f.y),this.move(Math.round(f.x),Math.round(f.y||0),g,m)}}!function(e){e.compose=function(t){pushUnique(composed,"Core.Tooltip")&&addEvent(t,"afterInit",function(){const t=this.chart;t.options.tooltip&&(t.tooltip=new e(t,t.options.tooltip,this))})}}(Tooltip=Tooltip||{});export default Tooltip;