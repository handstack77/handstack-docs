"use strict";import H from"./Globals.js";const win=H["win"];import U from"./Utilities.js";const{defined,error,extend,isNumber,isObject,merge,objectEach,pad,pick,splat,timeUnits}=U,hasNewSafariBug=H.isSafari&&win.Intl&&win.Intl.DateTimeFormat.prototype.formatRange,hasOldSafariBug=H.isSafari&&win.Intl&&!win.Intl.DateTimeFormat.prototype.formatRange;class Time{constructor(e){this.options={},this.useUTC=!1,this.variableTimezone=!1,this.Date=win.Date,this.getTimezoneOffset=this.timezoneOffsetFunction(),this.update(e)}get(e,t){var i,s;return this.variableTimezone||this.timezoneOffset?(s=(i=t.getTime())-this.getTimezoneOffset(t),t.setTime(s),s=t["getUTC"+e](),t.setTime(i),s):this.useUTC?t["getUTC"+e]():t["get"+e]()}set(e,t,i){if(this.variableTimezone||this.timezoneOffset){if("Milliseconds"===e||"Seconds"===e||"Minutes"===e&&this.getTimezoneOffset(t)%36e5==0)return t["setUTC"+e](i);var s=this.getTimezoneOffset(t),s=t.getTime()-s,n=(t.setTime(s),t["setUTC"+e](i),this.getTimezoneOffset(t)),s=t.getTime()+n;return t.setTime(s)}return this.useUTC||hasNewSafariBug&&"FullYear"===e?t["setUTC"+e](i):t["set"+e](i)}update(e={}){var t=pick(e.useUTC,!0);this.options=e=merge(!0,this.options,e),this.Date=e.Date||win.Date||Date,this.useUTC=t,this.timezoneOffset=t&&e.timezoneOffset||void 0,this.getTimezoneOffset=this.timezoneOffsetFunction(),this.variableTimezone=t&&!(!e.getTimezoneOffset&&!e.timezone)}makeTime(e,t,i,s,n,a){let o,m,r;return this.useUTC?(o=this.Date.UTC.apply(0,arguments),m=this.getTimezoneOffset(o),o+=m,m!==(r=this.getTimezoneOffset(o))?o+=r-m:m-36e5!==this.getTimezoneOffset(o-36e5)||hasOldSafariBug||(o-=36e5)):o=new this.Date(e,t,pick(i,1),pick(s,0),pick(n,0),pick(a,0)).getTime(),o}timezoneOffsetFunction(){const e=this,o=this.options,t=o.getTimezoneOffset;return this.useUTC?o.timezone?e=>{try{const n="shortOffset,"+(o.timezone||""),a=Time.formatCache[n]=Time.formatCache[n]||Intl.DateTimeFormat("en",{timeZone:o.timezone,timeZoneName:"shortOffset"});var[,,t,,i=0]=a.format(e).split(/(GMT|:)/).map(Number),s=60*-(t+i/60)*6e4;if(isNumber(s))return s}catch(e){error(34)}return 0}:this.useUTC&&t?e=>6e4*t(e.valueOf()):()=>6e4*(e.timezoneOffset||0):e=>6e4*new Date(e.toString()).getTimezoneOffset()}dateFormat(i,s,e){if(!defined(s)||isNaN(s))return H.defaultOptions.lang&&H.defaultOptions.lang.invalidDate||"";i=pick(i,"%Y-%m-%d %H:%M:%S");const n=this,t=new this.Date(s),a=this.get("Hours",t),o=this.get("Day",t),m=this.get("Date",t),r=this.get("Month",t),f=this.get("FullYear",t),h=H.defaultOptions.lang,u=h&&h.weekdays,l=h&&h.shortWeekdays,g=extend({a:l?l[o]:u[o].substr(0,3),A:u[o],d:pad(m),e:pad(m,2," "),w:o,b:h.shortMonths[r],B:h.months[r],m:pad(r+1),o:r+1,y:f.toString().substr(2,2),Y:f,H:pad(a),k:a,I:pad(a%12||12),l:a%12||12,M:pad(this.get("Minutes",t)),p:a<12?"AM":"PM",P:a<12?"am":"pm",S:pad(this.get("Seconds",t)),L:pad(Math.floor(s%1e3),3)},H.dateFormats);return objectEach(g,function(e,t){for(;-1!==i.indexOf("%"+t);)i=i.replace("%"+t,"function"==typeof e?e.call(n,s):e)}),e?i.substr(0,1).toUpperCase()+i.substr(1):i}resolveDTLFormat(e){return isObject(e,!0)?e:{main:(e=splat(e))[0],from:e[1],to:e[2]}}getTimeTicks(e,t,i,s){const n=this,a=n.Date,o=[],m={},r=new a(t),f=e.unitRange,h=e.count||1;let u,l,g,T;if(s=pick(s,1),defined(t)){n.set("Milliseconds",r,f>=timeUnits.second?0:h*Math.floor(n.get("Milliseconds",r)/h)),f>=timeUnits.second&&n.set("Seconds",r,f>=timeUnits.minute?0:h*Math.floor(n.get("Seconds",r)/h)),f>=timeUnits.minute&&n.set("Minutes",r,f>=timeUnits.hour?0:h*Math.floor(n.get("Minutes",r)/h)),f>=timeUnits.hour&&n.set("Hours",r,f>=timeUnits.day?0:h*Math.floor(n.get("Hours",r)/h)),f>=timeUnits.day&&n.set("Date",r,f>=timeUnits.month?1:Math.max(1,h*Math.floor(n.get("Date",r)/h))),f>=timeUnits.month&&(n.set("Month",r,f>=timeUnits.year?0:h*Math.floor(n.get("Month",r)/h)),l=n.get("FullYear",r)),f>=timeUnits.year&&(l-=l%h,n.set("FullYear",r,l)),f===timeUnits.week&&(T=n.get("Day",r),n.set("Date",r,n.get("Date",r)-T+s+(T<s?-7:0))),l=n.get("FullYear",r);var d=n.get("Month",r),c=n.get("Date",r),p=n.get("Hours",r);t=r.getTime(),!n.variableTimezone&&n.useUTC||!defined(i)||(g=i-t>4*timeUnits.month||n.getTimezoneOffset(t)!==n.getTimezoneOffset(i));let e=r.getTime();for(u=1;e<i;)o.push(e),f===timeUnits.year?e=n.makeTime(l+u*h,0):f===timeUnits.month?e=n.makeTime(l,d+u*h):!g||f!==timeUnits.day&&f!==timeUnits.week?g&&f===timeUnits.hour&&1<h?e=n.makeTime(l,d,c,p+u*h):e+=f*h:e=n.makeTime(l,d,c+u*h*(f===timeUnits.day?1:7)),u++;o.push(e),f<=timeUnits.hour&&o.length<1e4&&o.forEach(function(e){e%18e5==0&&"000000000"===n.dateFormat("%H%M%S%L",e)&&(m[e]="day")})}return o.info=extend(e,{higherRanks:m,totalRange:f*h}),o}getDateFormat(e,t,i,s){const n=this.dateFormat("%m-%d %H:%M:%S.%L",t),a="01-01 00:00:00.000",o={millisecond:15,second:12,minute:9,hour:6,day:3};let m="millisecond",r=m;for(m in timeUnits){if(e===timeUnits.week&&+this.dateFormat("%w",t)===i&&n.substr(6)===a.substr(6)){m="week";break}if(timeUnits[m]>e){m=r;break}if(o[m]&&n.substr(o[m])!==a.substr(o[m]))break;"week"!==m&&(r=m)}return this.resolveDTLFormat(s[m]).main}}Time.formatCache={};export default Time;