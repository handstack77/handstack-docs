"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import D from"../../Core/Defaults.js";const{getOptions,setOptions}=D;import DownloadURL from"../DownloadURL.js";const downloadURL=DownloadURL["downloadURL"];import ExportDataDefaults from"./ExportDataDefaults.js";import H from"../../Core/Globals.js";const{doc,win}=H;import U from"../../Core/Utilities.js";const{addEvent,defined,extend,find,fireEvent,isNumber,pick}=U;function wrapLoading(t){const e=Boolean(this.options.exporting?.showExportInProgress),a=win.requestAnimationFrame||setTimeout;a(()=>{e&&this.showLoading(this.options.lang.exportInProgress),a(()=>{try{t.call(this)}finally{e&&this.hideLoading()}})})}function chartDownloadCSV(){wrapLoading.call(this,()=>{var t=this.getCSV(!0);downloadURL(getBlobFromContent(t,"text/csv")||"data:text/csv,\ufeff"+encodeURIComponent(t),this.getFilename()+".csv")})}function chartDownloadXLS(){wrapLoading.call(this,()=>{var t='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head>\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Ark1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style>td{border:none;font-family: Calibri, sans-serif;} .number{mso-number-format:"0.00";} .text{ mso-number-format:"@";}</style><meta name=ProgId content=Excel.Sheet><meta charset=UTF-8></head><body>'+this.getTable(!0)+"</body></html>";downloadURL(getBlobFromContent(t,"application/vnd.ms-excel")||"data:application/vnd.ms-excel;base64,"+(t=t,win.btoa(unescape(encodeURIComponent(t)))),this.getFilename()+".xls")})}function chartGetCSV(t){let n="";const i=this.getDataRows(),e=this.options.exporting.csv,r=pick(e.decimalPoint,","!==e.itemDelimiter&&t?1.1.toLocaleString()[1]:"."),s=pick(e.itemDelimiter,","===r?";":","),l=e.lineDelimiter;return i.forEach((t,e)=>{let a="",o=t.length;for(;o--;)"number"==typeof(a="string"==typeof(a=t[o])?`"${a}"`:a)&&"."!==r&&(a=a.toString().replace(".",r)),t[o]=a;t.length=i.length?i[0].length:0,n+=t.join(s),e<i.length-1&&(n+=l)}),n}function chartGetDataRows(n){function i(t,e,a){if(w.columnHeaderFormatter){var o=w.columnHeaderFormatter(t,e,a);if(!1!==o)return o}return t?t.bindAxes?n?{columnTitle:1<a?e:t.name,topLevelColumnTitle:t.name}:t.name+(1<a?" ("+e+")":""):t.options.title&&t.options.title.text||(t.dateTime?c:l):l}function x(a,t,o){const n={},i={};return t.forEach(function(t){var e=(a.keyToAxis&&a.keyToAxis[t]||t)+"Axis",e=isNumber(o)?a.chart[e][o]:a[e];n[t]=e&&e.categories||[],i[t]=e&&e.dateTime}),{categoryMap:n,dateTimeValueAxisMap:i}}const b=this.hasParallelCoordinates,D=this.time,w=this.options.exporting&&this.options.exporting.csv||{},r=this.xAxis,T={},t=[],s=[],y=[],e=this.options.lang,a=e.exportData,l=a.categoryHeader,c=a.categoryDatetimeHeader,v=[];let o,h,S,C=0,p,d;for(p in this.series.forEach(function(l){const t=l.options.keys,c=l.xAxis,h=t||(a=c,o=(e=l).pointArrayMap||["y"],e.data.some(t=>void 0!==t.y&&t.name)&&a&&!a.categories&&"name"!==e.exportKey?["x",...o]:o),p=h.length,d=!l.requireSorting&&{},m=r.indexOf(c);var e,a,o;let g=x(l,h),u,f;if(!1!==l.options.includeInDataExport&&!l.options.isInternal&&!1!==l.visible){for(find(v,function(t){return t[0]===m})||v.push([m,C]),f=0;f<p;)S=i(l,h[f],h.length),y.push(S.columnTitle||S),n&&s.push(S.topLevelColumnTitle||S),f++;u={chart:l.chart,autoIncrement:l.autoIncrement,options:l.options,pointArrayMap:l.pointArrayMap,index:l.index},l.options.data.forEach(function(t,e){var a={series:u};let o,n,i;b&&(g=x(l,h,e)),l.pointClass.prototype.applyOptions.apply(a,[t]);t=l.data[e]&&l.data[e].name;if(o=(a.x??"")+","+t,f=0,(!c||"name"===l.exportKey||!b&&c&&c.hasNames&&t)&&(o=t),d&&(d[o]&&(o+="|"+e),d[o]=!0),T[o]){var e=o+","+T[o].pointers[l.index],r=o;T[o].pointers[l.index]&&(T[e]||(T[e]=[],T[e].xValues=[],T[e].pointers=[]),o=e),T[r].pointers[l.index]+=1}else{T[o]=[],T[o].xValues=[];const s=[];for(let t=0;t<l.chart.series.length;t++)s[t]=0;T[o].pointers=s,T[o].pointers[l.index]=1}for(T[o].x=a.x,T[o].name=t,T[o].xValues[m]=a.x;f<p;)i=a[n=h[f]],T[o][C+f]=pick(g.categoryMap[n][i],g.dateTimeValueAxisMap[n]?D.dateFormat(w.dateFormat,i):null,i),f++}),C+=f}}),T)Object.hasOwnProperty.call(T,p)&&t.push(T[p]);let m,g;for(h=n?[s,y]:[y],C=v.length;C--;)m=v[C][0],g=v[C][1],o=r[m],t.sort(function(t,e){return t.xValues[m]-e.xValues[m]}),d=i(o),h[0].splice(g,0,d),n&&h[1]&&h[1].splice(g,0,d),t.forEach(function(t){let e=t.name;o&&!defined(e)&&(e=o.dateTime?(t.x instanceof Date&&(t.x=t.x.getTime()),D.dateFormat(w.dateFormat,t.x)):o.categories?pick(o.names[t.x],o.categories[t.x],t.x):t.x),t.splice(g,0,e)});return h=h.concat(t),fireEvent(this,"exportData",{dataRows:h}),h}function chartGetTable(t){const e=t=>{if(!t.tagName||"#text"===t.tagName)return t.textContent||"";const a=t.attributes;let o="<"+t.tagName;return a&&Object.keys(a).forEach(t=>{var e=a[t];o+=` ${t}="${e}"`}),o=(o+=">")+(t.textContent||""),(t.children||[]).forEach(t=>{o+=e(t)}),o+=`</${t.tagName}>`};t=this.getTableAST(t);return e(t)}function chartGetTableAST(t){let o=0;const e=[],d=this.options,r=t?1.1.toLocaleString()[1]:".",m=pick(d.exporting.useMultiLevelHeaders,!0),a=this.getDataRows(m),n=m?a.shift():null,i=a.shift(),g=function(t,e){let a=t.length;if(e.length!==a)return!1;for(;a--;)if(t[a]!==e[a])return!1;return!0},u=function(t,e,a,o){let n=pick(o,""),i="highcharts-text"+(e?" "+e:"");return"number"==typeof n?(n=n.toString(),","===r&&(n=n.replace(".",r)),i="highcharts-number"):o||(i="highcharts-empty"),{tagName:t,attributes:a=extend({class:i},a),textContent:n}};!1!==d.exporting.tableCaption&&e.push({tagName:"caption",attributes:{class:"highcharts-table-caption"},textContent:pick(d.exporting.tableCaption,d.title.text||"Chart")});for(let t=0,e=a.length;t<e;++t)a[t].length>o&&(o=a[t].length);e.push(function(t,e,a){const o=[];let n=0,i=a||e&&e.length,r,s=0,l;if(m&&t&&e&&!g(t,e)){const c=[];for(;n<i;++n)if((r=t[n])===t[n+1])++s;else if(s)c.push(u("th","highcharts-table-topheading",{scope:"col",colspan:s+1},r)),s=0;else{r===e[n]?d.exporting.useRowspanHeaders?(l=2,delete e[n]):(l=1,e[n]=""):l=1;const h=u("th","highcharts-table-topheading",{scope:"col"},r);1<l&&h.attributes&&(h.attributes.valign="top",h.attributes.rowspan=l),c.push(h)}o.push({tagName:"tr",children:c})}if(e){const p=[];for(n=0,i=e.length;n<i;++n)void 0!==e[n]&&p.push(u("th",null,{scope:"col"},e[n]));o.push({tagName:"tr",children:p})}return{tagName:"thead",children:o}}(n,i,Math.max(o,i.length)));const s=[];a.forEach(function(e){const a=[];for(let t=0;t<o;t++)a.push(u(t?"td":"th",null,t?{}:{scope:"row"},e[t]));s.push({tagName:"tr",children:a})}),e.push({tagName:"tbody",children:s});t={tree:{tagName:"table",id:"highcharts-data-table-"+this.index,children:e}};return fireEvent(this,"aftergetTableAST",t),t.tree}function chartHideData(){this.toggleDataTable(!1)}function chartToggleDataTable(t){var e=(t=pick(t,!this.isDataTableVisible))&&!this.dataTableDiv;if(e&&(this.dataTableDiv=doc.createElement("div"),this.dataTableDiv.className="highcharts-data-table",this.renderTo.parentNode.insertBefore(this.dataTableDiv,this.renderTo.nextSibling)),this.dataTableDiv){const r=this.dataTableDiv.style,s=r.display;if(r.display=t?"block":"none",t){this.dataTableDiv.innerHTML=AST.emptyHTML;const l=new AST([this.getTableAST()]);l.addToDOM(this.dataTableDiv),fireEvent(this,"afterViewData",{element:this.dataTableDiv,wasHidden:e||s!==r.display})}else fireEvent(this,"afterHideData")}this.isDataTableVisible=t;const a=this.exportDivElements,o=this.options.exporting,n=o&&o.buttons&&o.buttons.contextButton.menuItems,i=this.options.lang;o&&o.menuItemDefinitions&&i&&i.viewData&&i.hideData&&n&&a&&((e=a[n.indexOf("viewData")])&&AST.setElementHTML(e,this.isDataTableVisible?i.hideData:i.viewData))}function chartViewData(){this.toggleDataTable(!0)}function compose(t,e){const a=t.prototype;if(!a.getCSV){const o=getOptions().exporting,{arearange:n,gantt:i,map:r,mapbubble:s,treemap:l,xrange:c}=(addEvent(t,"afterViewData",onChartAfterViewData),addEvent(t,"render",onChartRenderer),addEvent(t,"destroy",onChartDestroy),a.downloadCSV=chartDownloadCSV,a.downloadXLS=chartDownloadXLS,a.getCSV=chartGetCSV,a.getDataRows=chartGetDataRows,a.getTable=chartGetTable,a.getTableAST=chartGetTableAST,a.hideData=chartHideData,a.toggleDataTable=chartToggleDataTable,a.viewData=chartViewData,o&&(extend(o.menuItemDefinitions,{downloadCSV:{textKey:"downloadCSV",onclick:function(){this.downloadCSV()}},downloadXLS:{textKey:"downloadXLS",onclick:function(){this.downloadXLS()}},viewData:{textKey:"viewData",onclick:function(){wrapLoading.call(this,this.toggleDataTable)}}}),o.buttons&&o.buttons.contextButton.menuItems&&o.buttons.contextButton.menuItems.push("separator","downloadCSV","downloadXLS","viewData")),setOptions(ExportDataDefaults),e.types);n&&(n.prototype.keyToAxis={low:"y",high:"y"}),i&&(i.prototype.exportKey="name",i.prototype.keyToAxis={start:"x",end:"x"}),r&&(r.prototype.exportKey="name"),s&&(s.prototype.exportKey="name"),l&&(l.prototype.exportKey="name"),c&&(c.prototype.keyToAxis={x2:"x"})}}function getBlobFromContent(t,e){const a=win.navigator,o=win.URL||win.webkitURL||win;try{if(a.msSaveOrOpenBlob&&win.MSBlobBuilder){const n=new win.MSBlobBuilder;return n.append(t),n.getBlob("image/svg+xml")}return o.createObjectURL(new win.Blob(["\ufeff"+t],{type:e}))}catch(t){}}function onChartAfterViewData(){const n=this,i=n.dataTableDiv,r=(t,e)=>t.children[e].textContent,s=(o,n)=>(t,e)=>{var a;return a=r(n?t:e,o),e=r(n?e:t,o),""===a||""===e||isNaN(a)||isNaN(e)?a.toString().localeCompare(e):a-e};if(i&&n.options.exporting&&n.options.exporting.allowTableSorting){const t=i.querySelector("thead tr");t&&t.childNodes.forEach(a=>{const o=a.closest("table");a.addEventListener("click",function(){const t=[...i.querySelectorAll("tr:not(thead tr)")],e=[...a.parentNode.children];t.sort(s(e.indexOf(a),n.ascendingOrderInTable=!n.ascendingOrderInTable)).forEach(t=>{o.appendChild(t)}),e.forEach(e=>{["highcharts-sort-ascending","highcharts-sort-descending"].forEach(t=>{e.classList.contains(t)&&e.classList.remove(t)})}),a.classList.add(n.ascendingOrderInTable?"highcharts-sort-ascending":"highcharts-sort-descending")})})}}function onChartRenderer(){this.options&&this.options.exporting&&this.options.exporting.showTable&&!this.options.chart.forExport&&this.viewData()}function onChartDestroy(){this.dataTableDiv?.remove()}const ExportData={compose:compose};export default ExportData;