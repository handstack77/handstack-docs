"use strict";import ApproximationRegistry from"./ApproximationRegistry.js";import DataGroupingDefaults from"./DataGroupingDefaults.js";import DateTimeAxis from"../../Core/Axis/DateTimeAxis.js";import D from"../../Core/Defaults.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{prototype:seriesProto}=SeriesRegistry["series"];import U from"../../Core/Utilities.js";const{addEvent,defined,error,extend,isNumber,merge,pick}=U,baseGeneratePoints=seriesProto.generatePoints;function adjustExtremes(t,a){defined(a[0])&&isNumber(t.min)&&isNumber(t.dataMin)&&a[0]<t.min&&((!defined(t.options.min)&&t.min<=t.dataMin||t.min===t.dataMin)&&(t.min=Math.min(a[0],t.min)),t.dataMin=Math.min(a[0],t.dataMin)),defined(a[a.length-1])&&isNumber(t.max)&&isNumber(t.dataMax)&&a[a.length-1]>t.max&&((!defined(t.options.max)&&isNumber(t.dataMax)&&t.max>=t.dataMax||t.max===t.dataMax)&&(t.max=Math.max(a[a.length-1],t.max)),t.dataMax=Math.max(a[a.length-1],t.dataMax))}function anchorPoints(o,e,i){var r=o.options.dataGrouping,n=o.currentDataGrouping&&o.currentDataGrouping.gapSize;if(r&&o.xData&&n&&o.groupMap){var s=e.length-1,p=r.anchor,u=r.firstAnchor,r=r.lastAnchor;let t=e.length-1,a=0;if(u&&o.xData[0]>=e[0]){a++;var l=o.groupMap[0].start,g=o.groupMap[0].length;let t;isNumber(l)&&isNumber(g)&&(t=l+(g-1)),e[0]={start:e[0],middle:e[0]+.5*n,end:e[0]+n,firstPoint:o.xData[0],lastPoint:t&&o.xData[t]}[u]}if(0<s&&r&&n&&e[s]>=i-n&&(t--,l=o.groupMap[o.groupMap.length-1].start,e[s]={start:e[s],middle:e[s]+.5*n,end:e[s]+n,firstPoint:l&&o.xData[l],lastPoint:o.xData[o.xData.length-1]}[r]),p&&"start"!==p)for(var d=n*{middle:.5,end:1}[p];t>=a;)e[t]+=d,t--}}function applyGrouping(t){const r=this,n=r.chart,a=r.options,s=a.dataGrouping,o=!1!==r.allowDG&&s&&pick(s.enabled,n.options.isStock),p=r.reserveSpace(),u=this.currentDataGrouping;let l,g,e=!1;o&&!r.requireSorting&&(r.requireSorting=e=!0);t=!1===skipDataGrouping(r,t)||!o;if(e&&(r.requireSorting=!1),!t){r.destroyGroupedData();const d=s.groupAll?r.xData:r.processedXData,m=s.groupAll?r.yData:r.processedYData,h=n.plotSizeX,c=r.xAxis,D=c.options.ordinal,f=r.groupPixelWidth;let e,i;if(f&&d&&d.length&&h){i=!0,r.isDirty=!0,r.points=null;const G=c.getExtremes(),x=G.min,y=G.max,A=D&&c.ordinal&&c.ordinal.getGroupIntervalFactor(x,y,r)||1,M=f*(y-x)/h*A,S=c.getTimeTicks(DateTimeAxis.Additions.prototype.normalizeTimeTickInterval(M,s.units||DataGroupingDefaults.units),Math.min(x,d[0]),Math.max(y,d[d.length-1]),c.options.startOfWeek,d,r.closestPointRange),v=seriesProto.groupData.apply(r,[d,m,S,s.approximation]);let t=v.groupedXData,a=v.groupedYData,o=0;for(s&&s.smoothed&&t.length&&(s.firstAnchor="firstPoint",s.anchor="middle",s.lastAnchor="lastPoint",error(32,!1,n,{"dataGrouping.smoothed":"use dataGrouping.anchor"})),e=1;e<S.length;e++)S.info.segmentStarts&&-1!==S.info.segmentStarts.indexOf(e)||(o=Math.max(S[e]-S[e-1],o));(l=S.info).gapSize=o,r.closestPointRange=S.info.totalRange,r.groupMap=v.groupMap,r.currentDataGrouping=l,anchorPoints(r,t,y),p&&adjustExtremes(c,t),s.groupAll&&(r.allGroupedData=a,g=r.cropData(t,a,c.min,c.max),t=g.xData,a=g.yData,r.cropStart=g.start),r.processedXData=t,r.processedYData=a}else r.groupMap=null,r.currentDataGrouping=void 0;r.hasGroupedData=i,r.preventGraphAnimation=(u&&u.totalRange)!==(l&&l.totalRange)}}function compose(t){var a,o=t.prototype;o.applyGrouping||(a=t.prototype.pointClass,addEvent(a,"update",function(){if(this.dataGroup)return error(24,!1,this.series.chart),!1}),addEvent(t,"afterSetOptions",onAfterSetOptions),addEvent(t,"destroy",destroyGroupedData),extend(o,{applyGrouping:applyGrouping,destroyGroupedData:destroyGroupedData,generatePoints:generatePoints,getDGApproximation:getDGApproximation,groupData:groupData}))}function destroyGroupedData(){this.groupedData&&(this.groupedData.forEach(function(t,a){t&&(this.groupedData[a]=t.destroy?t.destroy():null)},this),this.groupedData.length=0,delete this.allGroupedData)}function generatePoints(){baseGeneratePoints.apply(this),this.destroyGroupedData(),this.groupedData=this.hasGroupedData?this.points:null}function getDGApproximation(){return this.is("arearange")?"range":this.is("ohlc")?"ohlc":this.is("hlc")?"hlc":this.is("column")||this.options.cumulative?"sum":"average"}function groupData(a,o,e,t){const i=this,r=i.data,n=i.options&&i.options.data,s=[],p=[],u=[],l=a.length,g=!!o,d=[],m=i.pointArrayMap,h=m&&m.length,c=["x"].concat(m||["y"]),D=this.options.dataGrouping&&this.options.dataGrouping.groupAll;let f,G,x,y=0,A=0;const M="function"==typeof t?t:t&&ApproximationRegistry[t]?ApproximationRegistry[t]:ApproximationRegistry[i.getDGApproximation&&i.getDGApproximation()||"average"];if(h){let t=m.length;for(;t--;)d.push([])}else d.push([]);var S=h||1;for(let t=0;t<=l;t++)if(!(a[t]<e[0])){for(;void 0!==e[y+1]&&a[t]>=e[y+1]||t===l;){f=e[y],i.dataGroupInfo={start:D?A:i.cropStart+A,length:d[0].length,groupStart:f},x=M.apply(i,d),i.pointClass&&!defined(i.dataGroupInfo.options)&&(i.dataGroupInfo.options=merge(i.pointClass.prototype.optionsToObject.call({series:i},i.options.data[i.cropStart+A])),c.forEach(function(t){delete i.dataGroupInfo.options[t]})),void 0!==x&&(s.push(f),p.push(x),u.push(i.dataGroupInfo)),A=t;for(let t=0;t<S;t++)d[t].length=0,d[t].hasNulls=!1;if(y+=1,t===l)break}if(t===l)break;if(m){var v,P=i.options.dataGrouping&&i.options.dataGrouping.groupAll?t:i.cropStart+t,b=r&&r[P]||i.pointClass.prototype.applyOptions.apply({series:i},[n[P]]);for(let t=0;t<h;t++)v=b[m[t]],isNumber(v)?d[t].push(v):null===v&&(d[t].hasNulls=!0)}else G=g?o[t]:null,isNumber(G)?d[0].push(G):null===G&&(d[0].hasNulls=!0)}return{groupedXData:s,groupedYData:p,groupMap:u}}function onAfterSetOptions(t){const a=t.options,o=this.type,e=this.chart.options.plotOptions,i=this.useCommonDataGrouping&&DataGroupingDefaults.common,r=DataGroupingDefaults.seriesSpecific;let n=D.defaultOptions.plotOptions[o].dataGrouping;e&&(r[o]||i)&&(t=this.chart.rangeSelector,n=n||merge(DataGroupingDefaults.common,r[o]),a.dataGrouping=merge(i,n,e.series&&e.series.dataGrouping,e[o].dataGrouping,this.userOptions.dataGrouping,!a.isInternal&&t&&isNumber(t.selected)&&t.buttonOptions[t.selected].dataGrouping))}function skipDataGrouping(t,a){return!(t.isCartesian&&!t.isDirty&&!t.xAxis.isDirty&&!t.yAxis.isDirty&&!a)}const DataGroupingSeriesComposition={compose:compose,groupData:groupData};export default DataGroupingSeriesComposition;