"use strict";import AST from"../../../Core/Renderer/HTML/AST.js";import H from"../../../Core/Globals.js";const doc=H["doc"];import SeriesRegistry from"../../../Core/Series/SeriesRegistry.js";const seriesTypes=SeriesRegistry["seriesTypes"];import U from"../../../Core/Utilities.js";const{addEvent,createElement,defined,isArray,isObject,objectEach,stableSort}=U;var DropdownProperties;!function(e){e[e["params.algorithm"]=0]="params.algorithm",e[e["params.average"]=1]="params.average"}(DropdownProperties=DropdownProperties||{});const dropdownParameters={"algorithm-pivotpoints":["standard","fibonacci","camarilla"],"average-disparityindex":["sma","ema","dema","tema","wma"]};function addColsContainer(e){var t=createElement("div",{className:"highcharts-popup-lhs-col"},void 0,e),e=createElement("div",{className:"highcharts-popup-rhs-col"},void 0,e);return createElement("div",{className:"highcharts-popup-rhs-col-wrapper"},void 0,e),{lhsCol:t,rhsCol:e}}function addForm(e,t,i){var a,r=this.lang;if(e){this.tabs.init.call(this,e);const s=this.container.querySelectorAll(".highcharts-tab-item-content");addColsContainer(s[0]),addSearchBox.call(this,e,s[0]),addIndicatorList.call(this,e,s[0],"add"),a=s[0].querySelectorAll(".highcharts-popup-rhs-col")[0],this.addButton(a,r.addButton||"add","add",a,i),addColsContainer(s[1]),addIndicatorList.call(this,e,s[1],"edit"),a=s[1].querySelectorAll(".highcharts-popup-rhs-col")[0],this.addButton(a,r.saveButton||"save","edit",a,i),this.addButton(a,r.removeButton||"remove","remove",a,i)}}function addFormFields(e,t,i,a){var r=t.params||t.options.params;a.innerHTML=AST.emptyHTML,createElement("h3",{className:"highcharts-indicator-title"},void 0,a).appendChild(doc.createTextNode(getNameType(t,i).indicatorFullName)),createElement("input",{type:"hidden",name:"highcharts-type-"+i,value:i},void 0,a),listAllSeries.call(this,i,"series",e,a,t,t.linkedParent&&t.linkedParent.options.id),r.volumeSeriesID&&listAllSeries.call(this,i,"volume",e,a,t,t.linkedParent&&r.volumeSeriesID),addParamInputs.call(this,e,"params",r,i,a)}function addIndicatorList(a,e,t,i){function s(e,t){const i=m.parentNode.children[1];addFormFields.call(r,a,e,t,m),i&&(i.style.display="block"),c&&e.options&&createElement("input",{type:"hidden",name:"highcharts-id-"+t,value:e.options.id},void 0,m).setAttribute("highcharts-data-series-id",e.options.id)}const r=this,o=r.lang,n=e.querySelectorAll(".highcharts-popup-lhs-col")[0],l=e.querySelectorAll(".highcharts-popup-rhs-col")[0],c="edit"===t,d=c?a.series:a.options.plotOptions||{};if(!a&&d)return;let h,p=[];c||isArray(d)?isArray(d)&&(p=filterSeriesArray.call(this,d)):p=filterSeries.call(this,d,i),stableSort(p,(e,t)=>{e=e.indicatorFullName.toLowerCase(),t=t.indicatorFullName.toLowerCase();return e<t?-1:t<e?1:0}),n.children[1]&&n.children[1].remove();const u=createElement("ul",{className:"highcharts-indicator-list"},void 0,n),m=l.querySelectorAll(".highcharts-popup-rhs-col-wrapper")[0];if(p.forEach(e=>{const{indicatorFullName:t,indicatorType:i,series:a}=e,r=(h=createElement("li",{className:"highcharts-indicator-list"},void 0,u),createElement("button",{className:"highcharts-indicator-list-item",textContent:t},void 0,h));["click","touchstart"].forEach(e=>{addEvent(r,e,function(){s(a,i)})})}),0<p.length){const{series:d,indicatorType:v}=p[0];s(d,v)}else c||(AST.setElementHTML(m.parentNode.children[0],o.noFilterMatch||""),m.parentNode.children[1].style.display="none")}function addParamInputs(r,s,e,o,n){if(r){const l=this.addInput;objectEach(e,(e,t)=>{var i,a=s+"."+t;defined(e)&&a&&(isObject(e)&&(l.call(this,a,o,n,{}),addParamInputs.call(this,r,a,e,o,n)),a in DropdownProperties?(i=addSelection.call(this,o,a,n),addSelectionOptions.call(this,r,s,i,o,t,e)):"params.volumeSeriesID"==a||isArray(e)||l.call(this,a,o,n,{value:e,type:"number"}))})}}function addSearchBox(t,e){function i(e){addIndicatorList.call(a,t,a.container,"add",e)}const a=this,r=e.querySelectorAll(".highcharts-popup-lhs-col")[0],s=this.lang.clearFilter,o=createElement("div",{className:"highcharts-input-wrapper"},void 0,r),n=this.addInput("searchIndicators","input",o,{value:"",type:"text",htmlFor:"search-indicators",labelClassName:"highcharts-input-search-indicators-label"}),l=createElement("a",{textContent:s},void 0,o);n.classList.add("highcharts-input-search-indicators"),l.classList.add("clear-filter-button"),addEvent(n,"input",function(){i(this.value),this.value.length?l.style.display="inline-block":l.style.display="none"}),["click","touchstart"].forEach(e=>{addEvent(l,e,function(){n.value="",i(""),l.style.display="none"})})}function addSelection(e,t,i){var a=t.split("."),a=a[a.length-1],e="highcharts-"+t+"-type-"+e,r=this.lang;createElement("label",{htmlFor:e},null,i).appendChild(doc.createTextNode(r[a]||t));const s=createElement("select",{name:e,className:"highcharts-popup-field",id:"highcharts-select-"+t},null,i);return s.setAttribute("id","highcharts-select-"+t),s}function addSelectionOptions(e,a,r,t,i,s,o){if("series"===a||"volume"===a)e.series.forEach(e=>{var t=e.options,i=t.name||t.params?e.name:t.id||"";"highcharts-navigator-series"!==t.id&&t.id!==(o&&o.options&&o.options.id)&&(defined(s)||"volume"!==a||"column"!==e.type||(s=t.id),createElement("option",{value:t.id},void 0,r).appendChild(doc.createTextNode(i)))});else if(t&&i){const n=i+"-"+t,l=dropdownParameters[n];l.forEach(e=>{createElement("option",{value:e},void 0,r).appendChild(doc.createTextNode(e))})}defined(s)&&(r.value=s)}function filterSeries(e,n){const t=this.chart&&this.chart.options.lang,l=t&&t.navigation&&t.navigation.popup&&t.navigation.popup.indicatorAliases,c=[];let d;return objectEach(e,(e,t)=>{var i=e&&e.options;if(e.params||i&&i.params){const{indicatorFullName:a,indicatorType:r}=getNameType(e,t);if(n){i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");const s=new RegExp(i,"i"),o=l&&l[r]&&l[r].join(" ")||"";(a.match(s)||o.match(s))&&(d={indicatorFullName:a,indicatorType:r,series:e},c.push(d))}else d={indicatorFullName:a,indicatorType:r,series:e},c.push(d)}}),c}function filterSeriesArray(e){const t=[];return e.forEach(e=>{e.is("sma")&&t.push({indicatorFullName:e.name,indicatorType:e.type,series:e})}),t}function getAmount(){let t=0;return this.series.forEach(e=>{(e.params||e.options.params)&&t++}),t}function getNameType(e,t){var i=e.options;let a=seriesTypes[t]&&seriesTypes[t].prototype.nameBase||t.toUpperCase(),r=t;return i&&i.type&&(r=e.options.type,a=e.name),{indicatorFullName:a,indicatorType:r}}function listAllSeries(e,t,i,a,r,s){if(i){const o=addSelection.call(this,e,t,a);addSelectionOptions.call(this,i,t,o,void 0,void 0,void 0,r),defined(s)&&(o.value=s)}}const PopupIndicators={addForm:addForm,getAmount:getAmount};export default PopupIndicators;