"use strict";import Controllable from"./Controllable.js";import F from"../../../Core/Templating.js";const format=F["format"];import MockPoint from"../MockPoint.js";import U from"../../../Core/Utilities.js";const{extend,isNumber,pick}=U;function symbolConnector(t,o,i,n,e){var s=e&&e.anchorX,e=e&&e.anchorY;let a,l,r=i/2;return isNumber(s)&&isNumber(e)&&(a=[["M",s,e]],(l=(l=o-e)<0?-n-l:l)<i&&(r=s<t+i/2?l:i-l),o+n<e?a.push(["L",t+r,o+n]):e<o?a.push(["L",t+r,o]):s<t?a.push(["L",t,o+n/2]):t+i<s&&a.push(["L",t+i,o+n/2])),a||[]}class ControllableLabel extends Controllable{static alignedPosition(t,o){var i=t.align,n=t.verticalAlign;let e=(o.x||0)+(t.x||0),s=(o.y||0)+(t.y||0),a,l;return"right"===i?a=1:"center"===i&&(a=2),a&&(e+=(o.width-(t.width||0))/a),"bottom"===n?l=1:"middle"===n&&(l=2),l&&(s+=(o.height-(t.height||0))/l),{x:Math.round(e),y:Math.round(s)}}static compose(t){const o=t.prototype.symbols;o.connector=symbolConnector}static justifiedOptions(t,o,i,n){const e=i.align,s=i.verticalAlign,a=!o.box&&o.padding||0,l=o.getBBox(),r={align:e,verticalAlign:s,x:i.x,y:i.y,width:o.width,height:o.height},h=(n.x||0)-t.plotLeft,c=(n.y||0)-t.plotTop;let p;return(p=h+a)<0&&("right"===e?r.align="left":r.x=(r.x||0)-p),(p=h+l.width-a)>t.plotWidth&&("left"===e?r.align="right":r.x=(r.x||0)+t.plotWidth-p),(p=c+a)<0&&("bottom"===s?r.verticalAlign="top":r.y=(r.y||0)-p),(p=c+l.height-a)>t.plotHeight&&("top"===s?r.verticalAlign="bottom":r.y=(r.y||0)+t.plotHeight-p),r}constructor(t,o,i){super(t,o,i,"label")}translatePoint(t,o){super.translatePoint(t,o,0)}translate(t,o){const i=this.annotation.chart,n=this.annotation.userOptions,e=i.annotations.indexOf(this.annotation),s=i.options.annotations,a=s[e];var l;i.inverted&&(l=t,t=o,o=l),this.options.x+=t,this.options.y+=o,a[this.collection][this.index].x=this.options.x,a[this.collection][this.index].y=this.options.y,n[this.collection][this.index].x=this.options.x,n[this.collection][this.index].y=this.options.y}render(t){const o=this.options,i=this.attrsFromOptions(o),n=o.style;this.graphic=this.annotation.chart.renderer.label("",0,-9999,o.shape,null,null,o.useHTML,null,"annotation-label").attr(i).add(t),this.annotation.chart.styledMode||("contrast"===n.color&&(n.color=this.annotation.chart.renderer.getContrast(-1<ControllableLabel.shapesWithoutBackground.indexOf(o.shape)?"#FFFFFF":o.backgroundColor)),this.graphic.css(o.style).shadow(o.shadow)),this.graphic.labelrank=o.labelrank,super.render()}redraw(t){const o=this.options,i=this.text||o.format||o.text,n=this.graphic,e=this.points[0];if(n){n.attr({text:i?format(String(i),e.getLabelConfig(),this.annotation.chart):o.formatter.call(e,this)});var s=this.anchor(e);const a=this.position(s);a?((n.alignAttr=a).anchorX=s.absolutePosition.x,a.anchorY=s.absolutePosition.y,n[t?"animate":"attr"](a)):n.attr({x:0,y:-9999}),n.placed=!!a,super.redraw(t)}else this.redraw(t)}anchor(t){const o=super.anchor.apply(this,arguments),i=this.options.x||0,n=this.options.y||0;return o.absolutePosition.x-=i,o.absolutePosition.y-=n,o.relativePosition.x-=i,o.relativePosition.y-=n,o}position(t){const o=this.graphic,i=this.annotation.chart,n=i.tooltip,e=this.points[0],s=this.options,a=t.absolutePosition,l=t.relativePosition;let r,h,c,p,d=e.series.visible&&MockPoint.prototype.isInsidePlot.call(e);var g;return o&&d&&({width:t=0,height:g=0}=o,s.distance&&n?r=n.getPosition.call({chart:i,distance:pick(s.distance,16),getPlayingField:n.getPlayingField,pointer:n.pointer},t,g,{plotX:l.x,plotY:l.y,negative:e.negative,ttBelow:e.ttBelow,h:l.height||l.width}):s.positioner?r=s.positioner.call(this):(h={x:a.x,y:a.y,width:0,height:0},r=ControllableLabel.alignedPosition(extend(s,{width:t,height:g}),h),"justify"===this.options.overflow&&(r=ControllableLabel.alignedPosition(ControllableLabel.justifiedOptions(i,o,s,r),h))),s.crop&&(c=r.x-i.plotLeft,p=r.y-i.plotTop,d=i.isInsidePlot(c,p)&&i.isInsidePlot(c+t,p+g))),d?r:null}}ControllableLabel.attrsMap={backgroundColor:"fill",borderColor:"stroke",borderWidth:"stroke-width",zIndex:"zIndex",borderRadius:"r",padding:"padding"},ControllableLabel.shapesWithoutBackground=["connector"];export default ControllableLabel;