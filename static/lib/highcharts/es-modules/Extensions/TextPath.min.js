"use strict";import H from"../Core/Globals.js";import U from"../Core/Utilities.js";const deg2rad=H["deg2rad"],{addEvent,merge,uniqueKey,defined,extend}=U;function setTextPath(s,t){t=merge(!0,{enabled:!0,attributes:{dy:-5,startOffset:"50%",textAnchor:"middle"}},t);const n=this.renderer.url,h=this.text||this,e=h.textPath,{attributes:d,enabled:o}=t;return s=s||e&&e.path,e&&e.undo(),s&&o?(t=addEvent(h,"afterModifyTree",e=>{if(s&&o){let t=s.attr("id");t||s.attr("id",t=uniqueKey());const r={x:0,y:0};defined(d.dx)&&(r.dx=d.dx,delete d.dx),defined(d.dy)&&(r.dy=d.dy,delete d.dy),h.attr(r),this.attr({transform:""}),this.box&&(this.box=this.box.destroy());var a=e.nodes.slice(0);e.nodes.length=0,e.nodes[0]={tagName:"textPath",attributes:extend(d,{"text-anchor":d.textAnchor,href:n+"#"+t}),children:a}}}),h.textPath={path:s,undo:t}):(h.attr({dx:0,dy:0}),delete h.textPath),this.added&&(h.textCache="",this.renderer.buildText(h)),this}function setPolygon(t){const e=t.bBox,s=this.element?.querySelector("textPath");if(s){const c=[],{b:f,h:a}=this.renderer.fontMetrics(this.element),u=a-f,p=new RegExp('(<tspan>|<tspan(?!\\sclass="highcharts-br")[^>]*>|<\\/tspan>)',"g"),P=s.innerHTML.replace(p,"").split(/<tspan class="highcharts-br"[^>]*>/),b=P.length;var r=(t,e)=>{var{x:e,y:a}=e,t=(s.getRotationOfChar(t)-90)*deg2rad,r=Math.cos(t),t=Math.sin(t);return[[e-u*r,a-u*t],[e+f*r,a+f*t]]};for(let e=0,a=0;a<b;a++){var n=P[a].length;for(let t=0;t<n;t+=5)try{var h=e+t+a,[d,o]=r(h,s.getStartPositionOfChar(h));0===t?(c.push(o),c.push(d)):(0===a&&c.unshift(o),a===b-1&&c.push(d))}catch(t){break}e+=n-1;try{var i=e+a,[l,x]=r(i,s.getEndPositionOfChar(i));c.unshift(x),c.unshift(l)}catch(t){break}}c.length&&c.push(c[0].slice()),e.polygon=c}return e}function drawTextPath(t){const e=t.labelOptions,a=t.point,r=e[a.formatPrefix+"TextPath"]||e.textPath;r&&!e.useHTML&&(this.setTextPath(a.getDataLabelPath?.(this)||a.graphic,r),a.dataLabelPath&&!r.enabled&&(a.dataLabelPath=a.dataLabelPath.destroy()))}function compose(t){addEvent(t,"afterGetBBox",setPolygon),addEvent(t,"beforeAddingDataLabel",drawTextPath);const e=t.prototype;e.setTextPath||(e.setTextPath=setTextPath)}const TextPath={compose:compose};export default TextPath;