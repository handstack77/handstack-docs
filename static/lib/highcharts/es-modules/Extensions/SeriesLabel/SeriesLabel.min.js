"use strict";import A from"../../Core/Animation/AnimationUtilities.js";const animObject=A["animObject"];import T from"../../Core/Templating.js";const format=T["format"];import D from"../../Core/Defaults.js";const setOptions=D["setOptions"];import H from"../../Core/Globals.js";const composed=H["composed"];import SeriesLabelDefaults from"./SeriesLabelDefaults.js";import SLU from"./SeriesLabelUtilities.js";const{boxIntersectLine,intersectRect}=SLU;import U from"../../Core/Utilities.js";const{addEvent,extend,fireEvent,isNumber,pick,pushUnique,syncTimeout}=U,labelDistance=3;function checkClearPoint(t,e,o,r,a){var i=t.chart,n=t.options.label||{},s=pick(n.onArea,!!t.area),h=s||n.connectorAllowed,l=16,c=i.boxesToAvoid;let p=Number.MAX_VALUE,d=Number.MAX_VALUE,b,m,f,x,u,g,y;for(g=0;c&&g<c.length;g+=1)if(intersectRect(c[g],{left:e,right:e+r.width,top:o,bottom:o+r.height}))return!1;for(g=0;g<i.series.length;g+=1){const Y=i.series[g],w=Y.interpolatedPoints&&[...Y.interpolatedPoints];if(Y.visible&&w){var X=i.plotHeight/10;for(let t=i.plotTop;t<=i.plotTop+i.plotHeight;t+=X)w.unshift({chartX:i.plotLeft,chartY:t}),w.push({chartX:i.plotLeft+i.plotWidth,chartY:t});for(y=1;y<w.length;y+=1){if(w[y].chartX>=e-l&&w[y-1].chartX<=e+r.width+l){if(boxIntersectLine(e,o,r.width,r.height,w[y-1].chartX,w[y-1].chartY,w[y].chartX,w[y].chartY))return!1;t===Y&&!f&&a&&(f=boxIntersectLine(e-l,o-l,r.width+32,r.height+32,w[y-1].chartX,w[y-1].chartY,w[y].chartX,w[y].chartY))}!h&&!f||t===Y&&!s||(x=e+r.width/2-w[y].chartX,u=o+r.height/2-w[y].chartY,p=Math.min(p,x*x+u*u))}if(!s&&h&&t===Y&&(a&&!f||p<Math.pow(n.connectorNeighbourDistance||1,2))){for(y=1;y<w.length;y+=1)(b=Math.min(Math.pow(e+r.width/2-w[y].chartX,2)+Math.pow(o+r.height/2-w[y].chartY,2),Math.pow(e-w[y].chartX,2)+Math.pow(o-w[y].chartY,2),Math.pow(e+r.width-w[y].chartX,2)+Math.pow(o-w[y].chartY,2),Math.pow(e+r.width-w[y].chartX,2)+Math.pow(o+r.height-w[y].chartY,2),Math.pow(e-w[y].chartX,2)+Math.pow(o+r.height-w[y].chartY,2)))<d&&(d=b,m=w[y]);f=!0}}}return!(a&&!f)&&{x:e,y:o,weight:p-(m?d:0),connectorPoint:m}}function compose(t,e){pushUnique(composed,"SeriesLabel")&&(addEvent(t,"load",onChartRedraw),addEvent(t,"redraw",onChartRedraw),e.prototype.symbols.connector=symbolConnector,setOptions({plotOptions:{series:{label:SeriesLabelDefaults}}}))}function drawSeriesLabels(C){C.boxesToAvoid=[];const t=C.labelSeries||[],i=C.boxesToAvoid;C.series.forEach(a=>(a.points||[]).forEach(t=>(t.dataLabels||[]).forEach(t=>{var{width:e,height:o}=t.getBBox(),r=(t.translateX||0)+(a.xAxis?a.xAxis.pos:a.chart.plotLeft),t=(t.translateY||0)+(a.yAxis?a.yAxis.pos:a.chart.plotTop);i.push({left:r,top:t,right:r+e,bottom:t+o})}))),t.forEach(function(t){var e=t.options.label||{};t.interpolatedPoints=getPointsOnGraph(t),i.push(...e.boxesToAvoid||[])}),C.series.forEach(function(c){const p=c.options.label;if(p&&(c.xAxis||c.yAxis)){const f="highcharts-color-"+pick(c.colorIndex,"none"),x=!c.labelBySeries,u=p.minFontSize,g=p.maxFontSize,y=C.inverted,X=(y?c.yAxis:c.xAxis).pos,Y=(y?c.xAxis:c.yAxis).pos,w=(C.inverted?c.yAxis:c.xAxis).len,M=(C.inverted?c.xAxis:c.yAxis).len,A=c.interpolatedPoints,S=pick(p.onArea,!!c.area),L=[],v=c.xData||[];let t,e,o,r,a,i,n=c.labelBySeries,s,h,l;if(S&&!y&&(s=[c.xAxis.toPixels(v[0]),c.xAxis.toPixels(v[v.length-1])],h=Math.min.apply(Math,s),l=Math.max.apply(Math,s)),c.visible&&!c.boosted&&A){if(!n){let t=c.name;"string"==typeof p.format?t=format(p.format,c,C):p.formatter&&(t=p.formatter.call(c)),c.labelBySeries=n=C.renderer.label(t,0,0,"connector",0,0,p.useHTML).addClass("highcharts-series-label highcharts-series-label-"+c.index+" "+(c.options.className||"")+" "+f),C.renderer.styledMode||(d="string"==typeof c.color?c.color:"#666666",n.css(extend({color:S?C.renderer.getContrast(d):d},p.style||{})),n.attr({opacity:C.renderer.forExport?1:0,stroke:c.color,"stroke-width":1})),u&&g&&n.css({fontSize:labelFontSize(c,u,g)}),n.attr({padding:0,zIndex:3}).add()}for((t=n.getBBox()).width=Math.round(t.width),a=A.length-1;0<a;--a)S?(e=(A[a].chartCenterX??A[a].chartX)-t.width/2,o=(A[a].chartCenterY??A[a].chartY)-t.height/2,(i=b(e,o,t)?checkClearPoint(c,e,o,t):i)&&L.push(i)):(e=A[a].chartX+labelDistance,o=A[a].chartY-t.height-labelDistance,(i=b(e,o,t)?checkClearPoint(c,e,o,t,!0):i)&&L.push(i),e=A[a].chartX+labelDistance,o=A[a].chartY+labelDistance,(i=b(e,o,t)?checkClearPoint(c,e,o,t,!0):i)&&L.push(i),e=A[a].chartX-t.width-labelDistance,o=A[a].chartY+labelDistance,(i=b(e,o,t)?checkClearPoint(c,e,o,t,!0):i)&&L.push(i),e=A[a].chartX-t.width-labelDistance,o=A[a].chartY-t.height-labelDistance,(i=b(e,o,t)?checkClearPoint(c,e,o,t,!0):i)&&L.push(i));if(p.connectorAllowed&&!L.length&&!S)for(e=X+w-t.width;e>=X;e-=16)for(o=Y;o<Y+M-t.height;o+=16)(r=checkClearPoint(c,e,o,t,!0))&&L.push(r);if(L.length){L.sort((t,e)=>e.weight-t.weight),i=L[0],(C.boxesToAvoid||[]).push({left:i.x,right:i.x+t.width,top:i.y,bottom:i.y+t.height});var d=Math.sqrt(Math.pow(Math.abs(i.x-(n.x||0)),2)+Math.pow(Math.abs(i.y-(n.y||0)),2));if(d&&c.labelBySeries){let t={opacity:C.renderer.forExport?1:0,x:i.x,y:i.y},e={opacity:1};d<=10&&(e={x:t.x,y:t.y},t={});let o;x&&((o=animObject(c.options.animation)).duration*=.2),c.labelBySeries.attr(extend(t,{anchorX:i.connectorPoint&&(i.connectorPoint.plotX||0)+X,anchorY:i.connectorPoint&&(i.connectorPoint.plotY||0)+Y})).animate(e,o),c.options.kdNow=!0,c.buildKDTree();d=c.searchPoint({chartX:i.x,chartY:i.y},!0);d&&(n.closest=[d,i.x-(d.plotX||0),i.y-(d.plotY||0)])}}else m()}else m();function b(t,e,o){var r=Math.max(X,pick(h,-1/0)),a=Math.min(X+w,pick(l,1/0));return r<t&&t<=a-o.width&&e>=Y&&e<=Y+M-o.height}function m(){n&&(c.labelBySeries=n.destroy())}}}),fireEvent(C,"afterDrawSeriesLabels")}function getPointsOnGraph(t){if(t.xAxis||t.yAxis){const p=t.points,d=[],b=t.graph||t.area,m=b&&b.element,f=t.chart.inverted,x=t.xAxis,u=t.yAxis,g=(f?u:x).pos,y=(f?x:u).pos,X=(f?x:u).len,Y=(f?u:x).len,w=t.options.label||{},M=pick(w.onArea,!!t.area),A=u.getThreshold(t.options.threshold),S={},L=f?"chartCenterX":"chartCenterY";let e,o,r,a,i,n,s;if(t.getPointSpline&&m&&m.getPointAtLength&&!M&&p.length<(t.chart.plotSizeX||0)/16){t=b.toD&&b.attr("d");for(b.toD&&b.attr({d:b.toD}),i=m.getTotalLength(),e=0;e<i;e+=16){var h=m.getPointAtLength(e),l=f?Y-h.y:h.x,h=f?X-h.x:h.y;c({chartX:g+l,chartY:y+h,plotX:l,plotY:h})}t&&b.attr({d:t});const v=p[p.length-1],C=v.pos();c({chartX:g+(C?.[0]||0),chartY:y+(C?.[1]||0)})}else{i=p.length;let t;for(e=0;e<i;e+=1){const D=p[e],[P,T]=D.pos()||[],k=D["plotHigh"];if(isNumber(P)&&isNumber(T)){const E={plotX:P,plotY:T,chartX:g+P,chartY:y+T};if(M&&(k&&(E.plotY=k,E.chartY=y+k),f?E.chartCenterX=g+Y-((k||D.plotY||0)+pick(D.yBottom,A))/2:E.chartCenterY=y+((k||T)+pick(D.yBottom,A))/2),t&&(o=Math.abs(E.chartX-t.chartX),r=Math.abs(E.chartY-t.chartY),16<(a=Math.max(o,r))))for(n=Math.ceil(a/16),s=1;s<n;s+=1)c({chartX:t.chartX+(E.chartX-t.chartX)*(s/n),chartY:t.chartY+(E.chartY-t.chartY)*(s/n),[L]:(t[L]||0)+((E[L]||0)-(t[L]||0))*(s/n),plotX:(t.plotX||0)+(P-(t.plotX||0))*(s/n),plotY:(t.plotY||0)+(T-(t.plotY||0))*(s/n)});c(E),t=E}}}return d;function c(t){var e=Math.round((t.plotX||0)/8)+","+Math.round((t.plotY||0)/8);S[e]||(S[e]=1,d.push(t))}}}function labelFontSize(t,e,o){return e+(t.sum||0)/(t.chart.labelSeriesMaxSum||0)*(o-e)+"px"}function onChartRedraw(i){if(this.renderer){const n=this;let a=animObject(n.renderer.globalAnimation).duration;n.labelSeries=[],n.labelSeriesMaxSum=0,n.seriesLabelTimer&&U.clearTimeout(n.seriesLabelTimer),n.series.forEach(function(t){const e=t.options.label||{},o=t.labelBySeries,r=o&&o.closest;e.enabled&&t.visible&&(t.graph||t.area)&&!t.boosted&&n.labelSeries&&(n.labelSeries.push(t),e.minFontSize&&e.maxFontSize&&t.yData&&(t.sum=t.yData.reduce((t,e)=>(t||0)+(e||0),0),n.labelSeriesMaxSum=Math.max(n.labelSeriesMaxSum||0,t.sum||0)),"load"===i.type&&(a=Math.max(a,animObject(t.options.animation).duration)),r&&(void 0!==r[0].plotX?o.animate({x:r[0].plotX+r[1],y:r[0].plotY+r[2]}):o.attr({opacity:0})))}),n.seriesLabelTimer=syncTimeout(function(){n.series&&n.labelSeries&&drawSeriesLabels(n)},n.renderer.forExport||!a?0:a)}}function symbolConnector(t,e,o,r,a){var i=a&&a.anchorX,a=a&&a.anchorY;let n,s,h=o/2;return isNumber(i)&&isNumber(a)&&(n=[["M",i,a]],(s=(s=e-a)<0?-r-s:s)<o&&(h=i<t+o/2?s:o-s),e+r<a?n.push(["L",t+h,e+r]):a<e?n.push(["L",t+h,e]):i<t?n.push(["L",t,e+r/2]):t+o<i&&n.push(["L",t+o,e+r/2])),n||[]}const SeriesLabel={compose:compose};export default SeriesLabel;