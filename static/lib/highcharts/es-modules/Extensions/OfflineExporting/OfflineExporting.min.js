"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import Chart from"../../Core/Chart/Chart.js";import D from"../../Core/Defaults.js";const defaultOptions=D["defaultOptions"];import DownloadURL from"../DownloadURL.js";const downloadURL=DownloadURL["downloadURL"];import Exporting from"../Exporting/Exporting.js";import H from"../../Core/Globals.js";const{doc,win}=H;import HU from"../../Core/HttpUtilities.js";const ajax=HU["ajax"];import OfflineExportingDefaults from"./OfflineExportingDefaults.js";import U from"../../Core/Utilities.js";const{addEvent,error,extend,fireEvent,merge}=U;var OfflineExporting;AST.allowedAttributes.push("data-z-index","fill-opacity","filter","rx","ry","stroke-dasharray","stroke-linejoin","stroke-opacity","text-anchor","transform","version","viewBox","visibility","xmlns","xmlns:xlink"),AST.allowedTags.push("desc","clippath","g"),function(y){function o(t,e){const o=this,n=merge(o.options.exporting,t),r=function(t){!1===n.fallbackToExportServer?n.error?n.error(n,t):error(28,!0):o.exportChart(n)};H.isMS&&o.styledMode&&!Exporting.inlineAllowlist.length&&Exporting.inlineAllowlist.push(/^blockSize/,/^border/,/^caretColor/,/^color/,/^columnRule/,/^columnRuleColor/,/^cssFloat/,/^cursor/,/^fill$/,/^fillOpacity/,/^font/,/^inlineSize/,/^length/,/^lineHeight/,/^opacity/,/^outline/,/^parentRule/,/^rx$/,/^ry$/,/^stroke/,/^textAlign/,/^textAnchor/,/^textDecoration/,/^transform/,/^vectorEffect/,/^visibility/,/^x$/,/^y$/),H.isMS&&("application/pdf"===n.type||o.container.getElementsByTagName("image").length&&"image/svg+xml"!==n.type)||"application/pdf"===n.type&&[].some.call(o.container.getElementsByTagName("image"),function(t){const e=t.getAttribute("href");return""!==e&&"string"==typeof e&&0!==e.indexOf("data:")})?r(new Error("Image type not supported for this chart/browser.")):o.getSVGForLocalExport(n,e||{},r,function(t){-1<t.indexOf("<foreignObject")&&"image/svg+xml"!==n.type&&(H.isMS||"application/pdf"===n.type)?r(new Error("Image type not supported for charts with embedded HTML")):y.downloadSVGLocal(t,extend({filename:o.getFilename()},n),r,()=>fireEvent(o,"exportChartLocalSuccess"))})}function w(t,e){const o=doc.getElementsByTagName("head")[0],n=doc.createElement("script");n.type="text/javascript",n.src=t,n.onload=e,n.onerror=function(){error("Error loading script "+t)},o.appendChild(n)}function n(e,t,o,n){const r=this,i=t=>r.sanitizeSVG(t,d),a=()=>{g&&m===p&&n(i(c.innerHTML))},l=(t,e,o)=>{++m,o.imageElement.setAttributeNS("http://www.w3.org/1999/xlink","href",t),a()};let s,c,d,f,g,p=0,m=0;r.unbindGetSVG=addEvent(r,"getSVG",t=>{d=t.chartCopy.options,c=t.chartCopy.container.cloneNode(!0),g=c&&c.getElementsByTagName("image")||[],p=g.length}),r.getSVGForExport(e,t);try{if(!g||!g.length)return void n(i(c.innerHTML));for(let t=0;t<g.length;t++)s=g[t],(f=s.getAttributeNS("http://www.w3.org/1999/xlink","href"))?y.imageToDataUrl(f,"image/png",{imageElement:s},e.scale,l,o,o,o):(m++,s.parentNode.removeChild(s),t--,a())}catch(t){o(t)}r.unbindGetSVG()}function r(n,r,i,a,l,t,s,e,c){let d=new win.Image,f;const o=()=>{setTimeout(function(){const t=doc.createElement("canvas"),e=t.getContext&&t.getContext("2d");var o;try{if(e){t.height=d.height*a,t.width=d.width*a,e.drawImage(d,0,0,t.width,t.height);try{o=t.toDataURL(r),l(o,r,i,a)}catch(t){f(n,r,i,a)}}else s(n,r,i,a)}finally{c&&c(n,r,i,a)}},y.loadEventDeferDelay)},g=()=>{e(n,r,i,a),c&&c(n,r,i,a)};f=()=>{d=new win.Image,f=t,d.crossOrigin="Anonymous",d.onload=o,d.onerror=g,d.src=n},d.onload=o,d.onerror=g,d.src=n}function i(t){const e=win.navigator.userAgent;var o=-1<e.indexOf("WebKit")&&e.indexOf("Chrome")<0;try{if(!o&&-1===t.indexOf("<foreignObject"))return y.domurl.createObjectURL(new win.Blob([t],{type:"image/svg+xml;charset-utf-16"}))}catch(t){}return"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(t)}function v(t,e,o,n){const r=(Number(t.getAttribute("width"))+2*e)*o,i=(Number(t.getAttribute("height"))+2*e)*o,a=new win.jspdf.jsPDF(r<i?"p":"l","pt",[r,i]);[].forEach.call(t.querySelectorAll('*[visibility="hidden"]'),function(t){t.parentNode.removeChild(t)});var l=t.querySelectorAll("linearGradient");for(let e=0;e<l.length;e++){const s=l[e],c=s.querySelectorAll("stop");let t=0;for(;t<c.length&&"0"===c[t].getAttribute("offset")&&"0"===c[t+1].getAttribute("offset");)c[t].remove(),t++}[].forEach.call(t.querySelectorAll("tspan"),t=>{"â€‹"===t.textContent&&(t.textContent=" ",t.setAttribute("dx",-5))}),a.svg(t,{x:0,y:0,width:r,height:i,removeInvalid:!0}).then(()=>n(a.output("datauristring")))}y.CanVGRenderer={},y.domurl=win.URL||win.webkitURL||win,y.loadEventDeferDelay=H.isMS?150:0,y.compose=function(t){const e=t.prototype;return e.exportChartLocal||(e.getSVGForLocalExport=n,e.exportChartLocal=o,merge(!0,defaultOptions.exporting,OfflineExportingDefaults)),t},y.downloadSVGLocal=function(d,t,f,g){const p=doc.createElement("div"),l=t.type||"image/png",m=(t.filename||"chart")+"."+("image/svg+xml"===l?"svg":l.split("/")[1]),h=t.scale||1;let e,o,s,c=t.libURL||defaultOptions.exporting.libURL,u=!0,x=t.pdfFont;c="/"!==c.slice(-1)?c+"/":c;const n=()=>{AST.setElementHTML(p,d);const t=p.getElementsByTagName("text");let e,o;[].forEach.call(t,function(r){for(["fontFamily","fontSize"].forEach(t=>{{var o=r,n=t;let e=o;for(;e&&e!==p;){if(e.style[n]){let t=e.style[n];"fontSize"===n&&/em$/.test(t)&&(t=Math.round(16*parseFloat(t))+"px"),o.style[n]=t;break}e=e.parentNode}return}}),r.style.fontFamily=x&&x.normal?"HighchartsFont":String(r.style.fontFamily&&r.style.fontFamily.split(" ").splice(-1)),e=r.getElementsByTagName("title"),[].forEach.call(e,function(t){r.removeChild(t)}),o=r.getElementsByClassName("highcharts-text-outline");0<o.length;){const t=o[0];t.parentNode&&t.parentNode.removeChild(t)}});const n=p.querySelector("svg");if(n){var i=n;var a=()=>{v(n,0,h,t=>{try{downloadURL(t,m),g&&g()}catch(t){f(t)}})};const l=(t,e)=>{win.jspdf.jsPDF.API.events.push(["initialized",function(){this.addFileToVFS(t,e),this.addFont(t,"HighchartsFont",t),this.getFontList().HighchartsFont||this.setFont("HighchartsFont")}])},s=(x&&!/[^\u0000-\u007F\u200B]+/.test(i.textContent||"")&&(x=void 0),["normal","italic","bold","bolditalic"]);let r;const c=()=>{const n=s.shift();if(!n)return a();var t=x&&x[n];t?ajax({url:t,responseType:"blob",success:(t,e)=>{const o=new FileReader;o.onloadend=function(){var t;"string"==typeof this.result&&(t=this.result.split(",")[1],l(n,t),"normal"===n&&(r=t)),c()},o.readAsDataURL(e.response)},error:c}):(r&&l(n,r),c())};c()}};if("image/svg+xml"===l)try{e=void 0!==win.MSBlobBuilder?((o=new win.MSBlobBuilder).append(d),o.getBlob("image/svg+xml")):i(d),downloadURL(e,m),g&&g()}catch(t){f(t)}else"application/pdf"===l?win.jspdf&&win.jspdf.jsPDF?n():(u=!0,w(c+"jspdf.js",function(){w(c+"svg2pdf.js",n)})):(e=i(d),s=function(){try{y.domurl.revokeObjectURL(e)}catch(t){}},r(e,l,{},h,function(t){try{downloadURL(t,m),g&&g()}catch(t){f(t)}},function(){if(1e8<d.length)throw new Error("Input too long");const e=doc.createElement("canvas"),o=e.getContext("2d"),t=d.match(/^<svg[^>]*\s{,1000}width\s{,1000}=\s{,1000}\"?(\d+)\"?[^>]*>/),n=d.match(/^<svg[^>]*\s{0,1000}height\s{,1000}=\s{,1000}\"?(\d+)\"?[^>]*>/);var r,i,a;o&&t&&n&&(r=+t[1]*h,i=+n[1]*h,a=()=>{const t=win.canvg.Canvg.fromString(o,d);t.start();try{downloadURL(win.navigator.msSaveOrOpenBlob?e.msToBlob():e.toDataURL(l),m),g&&g()}catch(t){f(t)}finally{s()}},e.width=r,e.height=i,win.canvg?a():(u=!0,w(c+"canvg.js",a)))},f,f,function(){u&&s()}))},y.getScript=w,y.imageToDataUrl=r,y.svgToDataUrl=i,y.svgToPdf=v}(OfflineExporting=OfflineExporting||{});export default OfflineExporting;