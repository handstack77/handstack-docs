"use strict";import DDU from"./DragDropUtilities.js";const{addEvents,getNormalizedEvent}=DDU;import DraggableChart from"./DraggableChart.js";const initDragDrop=DraggableChart["initDragDrop"];import DragDropDefaults from"./DragDropDefaults.js";import DragDropProps from"./DragDropProps.js";import U from"../../Core/Utilities.js";const{addEvent,clamp,isNumber,merge,pick}=U;function compose(e,o){DraggableChart.compose(e);const r=o.prototype;if(!r.dragDropProps){const t=o.prototype.pointClass,a=o.types,i=t.prototype;i.getDropValues=pointGetDropValues,i.showDragHandles=pointShowDragHandles,addEvent(t,"mouseOut",onPointMouseOut),addEvent(t,"mouseOver",onPointMouseOver),addEvent(t,"remove",onPointRemove),r.dragDropProps=DragDropProps.line,r.getGuideBox=seriesGetGuideBox;for(const s of["arearange","boxplot","bullet","column","columnrange","errorbar","flags","gantt","ohlc","waterfall","xrange"])a[s]&&(a[s].prototype.dragDropProps=DragDropProps[s]);for(const n of["bellcurve","gauge","histogram","map","mapline","pareto","pie","sankey","sma","sunburst","treemap","vector","windbarb","wordcloud"])a[n]&&(a[n].prototype.dragDropProps=null)}}function mouseOut(e){const o=e.series&&e.series.chart,r=o&&o.dragDropData;!o||!o.dragHandles||r&&(r.isDragging&&r.draggedPastSensitivity||r.isHoveringHandle===e.id)||o.hideDragHandles()}function mouseOver(e){const o=e.series,r=o&&o.chart,t=r&&r.dragDropData,a=r&&r.is3d&&r.is3d();!r||t&&t.isDragging&&t.draggedPastSensitivity||r.isDragDropAnimating||!o.options.dragDrop||a||(r.dragHandles&&r.hideDragHandles(),e.showDragHandles())}function onPointMouseOut(){const e=this;setTimeout(()=>{e.series&&mouseOut(e)},10)}function onPointMouseOver(){const e=this;setTimeout(()=>mouseOver(e),12)}function onPointRemove(){const e=this.series.chart,o=e.dragHandles;o&&o.point===this.id&&e.hideDragHandles()}function onResizeHandleMouseOut(e){const o=e.series.chart;o.dragDropData&&e.id===o.dragDropData.isHoveringHandle&&delete o.dragDropData.isHoveringHandle,o.hoverPoint||mouseOut(e)}function onResizeHandleMouseDown(e,o,r){const t=o.series.chart;t.zoomOrPanKeyPressed(e)||(t.mouseIsDown=!1,initDragDrop(e,o),t.dragDropData.updateProp=e.updateProp=r,o.firePointEvent("dragStart",e),e.stopPropagation(),e.preventDefault())}function pointGetDropValues(e,o,r){const t=this,i=t.series,d=i.chart,g=d.mapView,l=merge(i.options.dragDrop,t.options.dragDrop),a={},s=e.points[t.id],n=1===Object.keys(r).length;for(const p of Object.keys(r)){const c=r[p],u=s.point[p],D=i[c.axis+"Axis"],m=g?((t,a,i)=>{if(g){var s=pick(l["dragPrecision"+a],0),n=g.pixelsToLonLat({x:0,y:0}),p=g.pixelsToLonLat({x:d.plotBox.width,y:d.plotBox.height});let e=pick(l["dragMin"+a],n&&n[i],-1/0),o=pick(l["dragMax"+a],p&&p[i],1/0),r=t[i];return"Orthographic"===g.projection.options.name?r:("lat"===i&&((isNaN(e)||e>g.projection.maxLatitude)&&(e=g.projection.maxLatitude),n=o=isNaN(o)||o<-1*g.projection.maxLatitude?-1*g.projection.maxLatitude:o,o=e,e=n),g.projection.hasCoordinates||(a=g.pixelsToLonLat({x:t.chartX-d.plotLeft,y:d.plotHeight-t.chartY+d.plotTop}))&&(r=a[i]),s&&(r=Math.round(r/s)*s),clamp(r,e,o))}})(o,c.axis.toUpperCase(),p):((e,o)=>{var r=i[o.toLowerCase()+"Axis"].categories?1:0,r=pick(l["dragPrecision"+o],r),t=pick(l["dragMin"+o],-1/0),o=pick(l["dragMax"+o],1/0);let a=e;return r&&(a=Math.round(a/r)*r),clamp(a,t,o)})(D.toValue((D.horiz?o.chartX:o.chartY)+s[p+"Offset"]),c.axis.toUpperCase());!isNumber(m)||n&&c.propValidate&&!c.propValidate(m,t)||void 0===u||(a[p]=m)}return a}function pointShowDragHandles(){const t=this,a=t.series,i=a.chart,{inverted:s,renderer:n}=i,p=merge(a.options.dragDrop,t.options.dragDrop),d=a.dragDropProps||{};let g=i.dragHandles;for(const c of Object.keys(d)){const u=d[c],D=merge(DragDropDefaults.dragHandle,u.handleOptions,p.dragHandle),m={class:D.className,"stroke-width":D.lineWidth,fill:D.color,stroke:D.lineColor},h=D.pathFormatter||u.handleFormatter,x=u.handlePositioner,f=!u.validateIndividualDrag||u.validateIndividualDrag(t);let e,o,r;if(u.resize&&f&&u.resizeSide&&h&&(p["draggable"+u.axis.toUpperCase()]||p[u.optionName])&&!1!==p[u.optionName]){g?g.point=t.id:g=i.dragHandles={group:n.g("drag-drop-handles").add(a.markerGroup||a.group),point:t.id},e=x(t),m.d=r=h(t);var l=t.series.xAxis.categories?-.5:0;if(!r||e.x<l||e.y<0)return;m.cursor=D.cursor||("x"===u.axis!=!!s?"ew-resize":"ns-resize"),o=(o=g[u.optionName])||(g[u.optionName]=n.path().add(g.group)),m.translateX=s?a.yAxis.len-e.y:e.x,m.translateY=s?a.xAxis.len-e.x:e.y,s&&(m.rotation=-90),o.attr(m),addEvents(o.element,["touchstart","mousedown"],e=>{onResizeHandleMouseDown(getNormalizedEvent(e,i),t,c)},{passive:!1}),addEvent(g.group.element,"mouseover",()=>{i.dragDropData=i.dragDropData||{},i.dragDropData.isHoveringHandle=t.id}),addEvents(g.group.element,["touchend","mouseout"],()=>{onResizeHandleMouseOut(t)})}}}function seriesGetGuideBox(e){const o=this.chart;let r=1/0,t=-1/0,a=1/0,i=-1/0,s;for(const d of e){var n=d.graphic&&d.graphic.getBBox()||d.shapeArgs;if(n){let e;var p=d.x2,p=(isNumber(p)&&(e=d.series.xAxis.translate(p,!1,!1,!1,!0)),!(n.width||n.height||n.x||n.y));s=!0,r=Math.min(d.plotX||0,e||0,p?1/0:n.x||0,r),t=Math.max(d.plotX||0,e||0,(n.x||0)+(n.width||0),t),a=Math.min(d.plotY||0,p?1/0:n.y||0,a),i=Math.max((n.y||0)+(n.height||0),i)}}return s?o.renderer.rect(r,a,t-r,i-a):o.renderer.g()}const DraggablePoints={compose:compose};export default DraggablePoints;