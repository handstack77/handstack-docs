"use strict";import DataConverter from"./DataConverter.js";import U from"../../Core/Utilities.js";const merge=U["merge"];class CSVConverter extends DataConverter{constructor(e){e=merge(CSVConverter.defaultOptions,e);super(e),this.columns=[],this.headers=[],this.dataTypes=[],this.options=e}export(e,t=this.options){var{useLocalDecimalPoint:s,lineDelimiter:r}=t,i=!1!==this.options.firstRowAsNames;let{decimalPoint:o,itemDelimiter:n}=t;o=o||(","!==n&&s?1.1.toLocaleString()[1]:"."),n=n||(","===o?";":",");const l=e.getSortedColumns(t.usePresentationOrder),a=Object.keys(l),m=[],u=a.length,p=[];i&&m.push(a.map(e=>`"${e}"`).join(n));for(let r=0;r<u;r++){var g=a[r],h=l[g],d=h.length,g=e.whatIs(g);let s;g&&(s=g.dataType);for(let t=0;t<d;t++){let e=h[t];if(p[t]||(p[t]=[]),"string"===s?e='"'+e+'"':"number"==typeof e?e=String(e).replace(".",o):"string"==typeof e&&(e=`"${e}"`),p[t][r]=e,r===u-1){let e=r;for(;2<p[t].length;){if(void 0!==p[t][e])break;p[t].pop(),e--}m.push(p[t].join(n))}}}return m.join(r)}parse(e,t){const r=this,s=r.dataTypes,i=merge(this.options,e),{beforeParse:o,lineDelimiter:n,firstRowAsNames:l,itemDelimiter:a}=i;let m,u=0,{csv:p,startRow:g,endRow:h}=i,d;if(r.columns=[],r.emit({type:"parse",columns:r.columns,detail:t,headers:r.headers}),p=p&&o?o(p):p){if(m=p.replace(/\r\n|\r/g,"\n").split(n||"\n"),(!g||g<0)&&(g=0),(!h||h>=m.length)&&(h=m.length-1),a||(r.guessedItemDelimiter=r.guessDelimiter(m)),l){const f=m[0].split(a||r.guessedItemDelimiter||",");for(let e=0;e<f.length;e++)f[e]=f[e].trim().replace(/^["']|["']$/g,"");r.headers=f,g++}let e=0;for(u=g;u<=h;u++)"#"===m[u][0]?e++:r.parseCSVRow(m[u],u-g-e);s.length&&s[0].length&&"date"===s[0][1]&&!r.options.dateFormat&&r.deduceDateFormat(r.columns[0],null,!0);for(let s=0,e=r.columns.length;s<e;++s)for(let t=0,e=(d=r.columns[s]).length;t<e;++t)if(d[t]&&"string"==typeof d[t]){let e=r.asGuessedType(d[t]);e instanceof Date&&(e=e.getTime()),r.columns[s][t]=e}}r.emit({type:"afterParse",columns:r.columns,detail:t,headers:r.headers})}parseCSVRow(t,s){const r=this,i=r.columns||[],o=r.dataTypes,{startColumn:n,endColumn:l}=r.options,e=r.options.itemDelimiter||r.guessedItemDelimiter;let a=r.options["decimalPoint"],m=(a&&a!==e||(a=r.guessedDecimalPoint||"."),0),u="",p="",g=0,h=0;var d=e=>{u=t[e]};const f=e=>{o.length<h+1&&o.push([e]),o[h][o[h].length-1]!==e&&o[h].push(e)};var c=()=>{if(n>g||g>l)return++g,void(p="");var e;"string"==typeof p?!isNaN(parseFloat(p))&&isFinite(p)?(p=parseFloat(p),f("number")):isNaN(Date.parse(p))?f("string"):(p=p.replace(/\//g,"-"),f("date")):f("number"),i.length<h+1&&i.push([]),"number"!=typeof p&&"number"!==r.guessType(p)&&a&&(p=(e=p).replace(a,"."),"number"!==r.guessType(p)&&(p=e)),i[h][s]=p,p="",++h,++g};if(t.trim().length&&"#"!==t.trim()[0]){for(;m<t.length;m++){if(d(m),"#"===u&&!/^#[A-F\d]{3,3}|[A-F\d]{6,6}/i.test(t.substring(m)))return void c();if('"'===u)for(d(++m);m<t.length&&'"'!==u;)p+=u,d(++m);else u===e?c():p+=u}c()}}guessDelimiter(n){let l=0,a=0,e;const m={",":0,";":0,"\t":0},t=n.length;for(let e=0;e<t;e++){let t=!1,s,r,i,o="";if(13<e)break;var u=n[e];for(let e=0;e<u.length&&(s=u[e],r=u[e+1],i=u[e-1],"#"!==s);e++){if('"'===s)if(t){if('"'!==i&&'"'!==r){for(;" "===r&&e<u.length;)r=u[++e];void 0!==m[r]&&m[r]++,t=!1}}else t=!0;else void 0!==m[s]?(o=o.trim(),isNaN(Date.parse(o))&&!isNaN(Number(o))&&isFinite(Number(o))||m[s]++,o=""):o+=s;","===s&&a++,"."===s&&l++}}return e=m[";"]>m[","]?";":(m[","],m[";"],","),l>a?this.guessedDecimalPoint=".":this.guessedDecimalPoint=",",e}getTable(){return DataConverter.getTableFromColumns(this.columns,this.headers)}}CSVConverter.defaultOptions={...DataConverter.defaultOptions,lineDelimiter:"\n"};export default CSVConverter;