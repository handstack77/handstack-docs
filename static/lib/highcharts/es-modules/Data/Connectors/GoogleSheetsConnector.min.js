"use strict";import DataConnector from"./DataConnector.js";import GoogleSheetsConverter from"../Converters/GoogleSheetsConverter.js";import U from"../../Core/Utilities.js";const{merge,pick}=U;function isGoogleError(e){return"object"==typeof e&&e&&"object"==typeof e.error&&e.error&&"number"==typeof e.error.code&&"string"==typeof e.error.message&&"string"==typeof e.error.status}class GoogleSheetsConnector extends DataConnector{constructor(e){e=merge(GoogleSheetsConnector.defaultOptions,e);super(e),this.converter=new GoogleSheetsConverter(e),this.options=e}load(o){const t=this,r=t.converter,n=t.table,{dataModifier:s,dataRefreshRate:e,enablePolling:a,firstRowAsNames:l,googleAPIKey:i,googleSpreadsheetKey:c}=t.options,g=GoogleSheetsConnector.buildFetchURL(i,c,t.options);if(t.emit({type:"load",detail:o,table:n,url:g}),URL.canParse(g))return fetch(g).then(e=>e.json()).then(e=>{if(isGoogleError(e))throw new Error(e.error.message);return r.parse({firstRowAsNames:l,json:e}),n.deleteColumns(),n.setColumns(r.getTable().getColumns()),t.setModifierOptions(s)}).then(()=>(t.emit({type:"afterLoad",detail:o,table:n,url:g}),a&&setTimeout(()=>t.load(),1e3*Math.max(e||0,1)),t)).catch(e=>{throw t.emit({type:"loadError",detail:o,error:e,table:n}),e});throw new Error("Invalid URL: "+g)}}GoogleSheetsConnector.defaultOptions={googleAPIKey:"",googleSpreadsheetKey:"",enablePolling:!1,dataRefreshRate:2,firstRowAsNames:!0},function(e){const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function a(e={}){var{endColumn:e,endRow:o,googleSpreadsheetRange:t,startColumn:r,startRow:n}=e;return t||(s[r||0]||"A")+(Math.max(n||0,0)+1)+":"+(s[pick(e,25)]||"Z")+(o?Math.max(o,0):"Z")}e.buildFetchURL=function(e,o,t={}){const r=new URL(`https://sheets.googleapis.com/v4/spreadsheets/${o}/values/`),n=(o=t.onlyColumnNames?"A1:Z1":a(t),r.pathname+=o,r.searchParams);return n.set("alt","json"),t.onlyColumnNames||(n.set("dateTimeRenderOption","FORMATTED_STRING"),n.set("majorDimension","COLUMNS"),n.set("valueRenderOption","UNFORMATTED_VALUE")),n.set("prettyPrint","false"),n.set("key",e),r.href},e.buildQueryRange=a}(GoogleSheetsConnector=GoogleSheetsConnector||{}),DataConnector.registerType("GoogleSheets",GoogleSheetsConnector);export default GoogleSheetsConnector;