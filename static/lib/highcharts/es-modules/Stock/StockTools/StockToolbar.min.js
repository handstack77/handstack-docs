"use strict";import U from"../../Core/Utilities.js";import AST from"../../Core/Renderer/HTML/AST.js";import StockToolsUtilities from"./StockToolsUtilities.js";const{addEvent,createElement,css,defined,fireEvent,getStyle,isArray,merge,pick}=U,shallowArraysEqual=StockToolsUtilities["shallowArraysEqual"];class Toolbar{constructor(t,s,i){this.width=0,this.isDirty=!1,this.chart=i,this.options=t,this.lang=s,this.iconsURL=this.getIconsURL(),this.guiEnabled=t.enabled,this.visible=pick(t.visible,!0),this.guiClassName=t.className,this.toolbarClassName=t.toolbarClassName,this.eventsToUnbind=[],this.guiEnabled&&(this.createContainer(),this.createButtons(),this.showHideNavigation()),fireEvent(this,"afterInit")}createButtons(){const i=this.lang,t=this.options,e=this.toolbar,s=t.buttons,a=t.definitions,h=e.childNodes;(this.buttonList=s).forEach(t=>{const s=this.addButton(e,a,t,i);this.eventsToUnbind.push(addEvent(s.buttonWrapper,"click",()=>this.eraseActiveButtons(h,s.buttonWrapper))),isArray(a[t].items)&&this.addSubmenu(s,a[t])})}addSubmenu(t,s){const i=t.submenuArrow,e=t.buttonWrapper,a=getStyle(e,"width"),h=this.wrapper,r=this.listWrapper,o=this.toolbar.childNodes,n=this.submenu=createElement("ul",{className:"highcharts-submenu-wrapper"},void 0,e);this.addSubmenuItems(e,s),this.eventsToUnbind.push(addEvent(i,"click",t=>{if(t.stopPropagation(),this.eraseActiveButtons(o,e),0<=e.className.indexOf("highcharts-current"))r.style.width=r.startWidth+"px",e.classList.remove("highcharts-current"),n.style.display="none";else{n.style.display="block";let t=n.offsetHeight-e.offsetHeight-3;n.offsetHeight+e.offsetTop>h.offsetHeight&&e.offsetTop>t||(t=0),css(n,{top:-t+"px",left:a+3+"px"}),e.className+=" highcharts-current",r.startWidth=h.offsetWidth,r.style.width=r.startWidth+getStyle(r,"padding-left")+n.offsetWidth+3+"px"}}))}addSubmenuItems(s,i){const e=this,a=this.submenu,h=this.lang,r=this.listWrapper,t=i.items;let o;t.forEach(t=>{o=this.addButton(a,i,t,h),this.eventsToUnbind.push(addEvent(o.mainButton,"click",function(){e.switchSymbol(this,s,!0),r.style.width=r.startWidth+"px",a.style.display="none"}))});var n=a.querySelectorAll("li > .highcharts-menu-item-btn")[0];this.switchSymbol(n,!1)}eraseActiveButtons(t,s,i){[].forEach.call(t,t=>{t!==s&&(t.classList.remove("highcharts-current"),t.classList.remove("highcharts-active"),0<(i=t.querySelectorAll(".highcharts-submenu-wrapper")).length&&(i[0].style.display="none"))})}addButton(t,s,i,e={}){var s=s[i],a=s.items,h=Toolbar.prototype.classMapping,r=s.className||"",h=createElement("li",{className:pick(h[i],"")+" "+r,title:e[i]||i},void 0,t),r=s.elementType||"button";const o=createElement(r,{className:"highcharts-menu-item-btn"},void 0,h);if(a&&a.length){const n=createElement("button",{className:"highcharts-submenu-item-arrow highcharts-arrow-right"},void 0,h);return n.style.backgroundImage="url("+this.iconsURL+"arrow-bottom.svg)",{buttonWrapper:h,mainButton:o,submenuArrow:n}}return o.style.backgroundImage="url("+this.iconsURL+s.symbol+")",{buttonWrapper:h,mainButton:o}}addNavigation(){const t=this.wrapper;this.arrowWrapper=createElement("div",{className:"highcharts-arrow-wrapper"}),this.arrowUp=createElement("div",{className:"highcharts-arrow-up"},void 0,this.arrowWrapper),this.arrowUp.style.backgroundImage="url("+this.iconsURL+"arrow-right.svg)",this.arrowDown=createElement("div",{className:"highcharts-arrow-down"},void 0,this.arrowWrapper),this.arrowDown.style.backgroundImage="url("+this.iconsURL+"arrow-right.svg)",t.insertBefore(this.arrowWrapper,t.childNodes[0]),this.scrollButtons()}scrollButtons(){const t=this.wrapper,s=this.toolbar,i=.1*t.offsetHeight;let e=0;this.eventsToUnbind.push(addEvent(this.arrowUp,"click",()=>{0<e&&(e-=i,s.style.marginTop=-e+"px")})),this.eventsToUnbind.push(addEvent(this.arrowDown,"click",()=>{t.offsetHeight+e<=s.offsetHeight+i&&(e+=i,s.style.marginTop=-e+"px")}))}createContainer(){const s=this.chart,t=this.options,i=s.container,e=s.options.navigation,a=e?.bindingsClassName,h=this;let r,o;const n=this.wrapper=createElement("div",{className:"highcharts-stocktools-wrapper "+t.className+" "+a});i.appendChild(n),this.showHideBtn=createElement("div",{className:"highcharts-toggle-toolbar highcharts-arrow-left"},void 0,n),this.eventsToUnbind.push(addEvent(this.showHideBtn,"click",()=>{this.update({gui:{visible:!h.visible}})})),["mousedown","mousemove","click","touchstart"].forEach(t=>{addEvent(n,t,t=>t.stopPropagation())}),addEvent(n,"mouseover",t=>s.pointer?.onContainerMouseLeave(t)),this.toolbar=o=createElement("ul",{className:"highcharts-stocktools-toolbar "+t.toolbarClassName}),this.listWrapper=r=createElement("div",{className:"highcharts-menu-wrapper"}),n.insertBefore(r,n.childNodes[0]),r.insertBefore(o,r.childNodes[0]),this.showHideToolbar(),this.addNavigation()}showHideNavigation(){this.visible&&this.toolbar.offsetHeight>this.wrapper.offsetHeight-50?this.arrowWrapper.style.display="block":(this.toolbar.style.marginTop="0px",this.arrowWrapper.style.display="none")}showHideToolbar(){const t=this.wrapper,s=this.listWrapper,i=this.submenu,e=this.showHideBtn;var a=this.visible;e.style.backgroundImage="url("+this.iconsURL+"arrow-right.svg)",a?(t.style.height="100%",s.classList.remove("highcharts-hide"),e.classList.remove("highcharts-arrow-right"),e.style.top=getStyle(s,"padding-top")+"px",e.style.left=t.offsetWidth+getStyle(s,"padding-left")+"px"):(i&&(i.style.display="none"),e.style.left="0px",this.visible=!1,s.classList.add("highcharts-hide"),e.classList.add("highcharts-arrow-right"),t.style.height=e.offsetHeight+"px")}switchSymbol(t,s){const i=t.parentNode,e=i.className,a=i.parentNode.parentNode;-1<e.indexOf("highcharts-disabled-btn")||(a.className="",e&&a.classList.add(e.trim()),a.querySelectorAll(".highcharts-menu-item-btn")[0].style.backgroundImage=t.style.backgroundImage,s&&this.toggleButtonActiveClass(a))}toggleButtonActiveClass(t){const s=t.classList;s.contains("highcharts-active")?s.remove("highcharts-active"):s.add("highcharts-active")}unselectAllButtons(s){var t=s.parentNode.querySelectorAll(".highcharts-active");[].forEach.call(t,t=>{t!==s&&t.classList.remove("highcharts-active")})}update(t,s){this.isDirty=!!t.gui.definitions,merge(!0,this.chart.options.stockTools,t),merge(!0,this.options,t.gui),this.visible=pick(this.options.visible&&this.options.enabled,!0),this.chart.navigationBindings&&this.chart.navigationBindings.update(),this.chart.isDirtyBox=!0,pick(s,!0)&&this.chart.redraw()}destroy(){const t=this.wrapper,s=t&&t.parentNode;this.eventsToUnbind.forEach(t=>t()),s&&s.removeChild(t)}redraw(){this.options.enabled!==this.guiEnabled?this.handleGuiEnabledChange():this.guiEnabled&&(this.updateClassNames(),this.updateButtons(),this.updateVisibility(),this.showHideNavigation(),this.showHideToolbar())}handleGuiEnabledChange(){!1===this.options.enabled&&(this.destroy(),this.visible=!1),!0===this.options.enabled&&(this.createContainer(),this.createButtons()),this.guiEnabled=this.options.enabled}updateClassNames(){this.options.className!==this.guiClassName&&(this.guiClassName&&this.wrapper.classList.remove(this.guiClassName),this.options.className&&this.wrapper.classList.add(this.options.className),this.guiClassName=this.options.className),this.options.toolbarClassName!==this.toolbarClassName&&(this.toolbarClassName&&this.toolbar.classList.remove(this.toolbarClassName),this.options.toolbarClassName&&this.toolbar.classList.add(this.options.toolbarClassName),this.toolbarClassName=this.options.toolbarClassName)}updateButtons(){shallowArraysEqual(this.options.buttons,this.buttonList)&&!this.isDirty||(this.toolbar.innerHTML=AST.emptyHTML,this.createButtons())}updateVisibility(){defined(this.options.visible)&&(this.visible=this.options.visible)}getIconsURL(){return this.chart.options.navigation.iconsURL||this.options.iconsURL||"https://code.highcharts.com/@product.version@/gfx/stock-icons/"}}Toolbar.prototype.classMapping={circle:"highcharts-circle-annotation",ellipse:"highcharts-ellipse-annotation",rectangle:"highcharts-rectangle-annotation",label:"highcharts-label-annotation",segment:"highcharts-segment",arrowSegment:"highcharts-arrow-segment",ray:"highcharts-ray",arrowRay:"highcharts-arrow-ray",line:"highcharts-infinity-line",arrowInfinityLine:"highcharts-arrow-infinity-line",verticalLine:"highcharts-vertical-line",horizontalLine:"highcharts-horizontal-line",crooked3:"highcharts-crooked3",crooked5:"highcharts-crooked5",elliott3:"highcharts-elliott3",elliott5:"highcharts-elliott5",pitchfork:"highcharts-pitchfork",fibonacci:"highcharts-fibonacci",fibonacciTimeZones:"highcharts-fibonacci-time-zones",parallelChannel:"highcharts-parallel-channel",measureX:"highcharts-measure-x",measureY:"highcharts-measure-y",measureXY:"highcharts-measure-xy",timeCycles:"highcharts-time-cycles",verticalCounter:"highcharts-vertical-counter",verticalLabel:"highcharts-vertical-label",verticalArrow:"highcharts-vertical-arrow",currentPriceIndicator:"highcharts-current-price-indicator",indicators:"highcharts-indicators",flagCirclepin:"highcharts-flag-circlepin",flagDiamondpin:"highcharts-flag-diamondpin",flagSquarepin:"highcharts-flag-squarepin",flagSimplepin:"highcharts-flag-simplepin",zoomX:"highcharts-zoom-x",zoomY:"highcharts-zoom-y",zoomXY:"highcharts-zoom-xy",typeLine:"highcharts-series-type-line",typeOHLC:"highcharts-series-type-ohlc",typeHLC:"highcharts-series-type-hlc",typeCandlestick:"highcharts-series-type-candlestick",typeHollowCandlestick:"highcharts-series-type-hollowcandlestick",typeHeikinAshi:"highcharts-series-type-heikinashi",fullScreen:"highcharts-full-screen",toggleAnnotations:"highcharts-toggle-annotations",saveChart:"highcharts-save-chart",separator:"highcharts-separator"};export default Toolbar;