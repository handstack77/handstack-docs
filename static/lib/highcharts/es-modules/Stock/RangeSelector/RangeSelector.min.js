"use strict";import Axis from"../../Core/Axis/Axis.js";import D from"../../Core/Defaults.js";const defaultOptions=D["defaultOptions"];import H from"../../Core/Globals.js";import RangeSelectorComposition from"./RangeSelectorComposition.js";import SVGElement from"../../Core/Renderer/SVG/SVGElement.js";import U from"../../Core/Utilities.js";import OrdinalAxis from"../../Core/Axis/OrdinalAxis.js";const{addEvent,createElement,css,defined,destroyObjectProperties,discardElement,extend,fireEvent,isNumber,merge,objectEach,pad,pick,pInt,splat}=U;function preferredInputType(e){if(-1!==e.indexOf("%L"))return"text";var t=["a","A","d","e","w","b","B","m","o","y","Y"].some(t=>-1!==e.indexOf("%"+t)),i=["H","k","I","l","M","S"].some(t=>-1!==e.indexOf("%"+t));return t&&i?"datetime-local":t?"date":i?"time":"text"}class RangeSelector{static compose(t,e){RangeSelectorComposition.compose(t,e,RangeSelector)}constructor(t){this.buttonOptions=RangeSelector.prototype.defaultButtons,this.initialButtonGroupWidth=0,this.init(t)}clickButton(t,e){const i=this,n=i.chart,o=i.buttonOptions[t],s=n.xAxis[0],a=n.scroller&&n.scroller.getUnionExtremes()||s||{},r=o.type,l=o.dataGrouping;let d=a.dataMin,h=a.dataMax,p,u=s&&Math.round(Math.min(s.max,pick(h,s.max))),c,m=o._range,g,x,f,b=!0;if(null!==d&&null!==h){if(i.setSelected(t),l&&(this.forcedDataGrouping=!0,Axis.prototype.setDataGrouping.call(s||{chart:this.chart},l,!1),this.frozenStates=o.preserveDataGrouping),"month"===r||"year"===r)s?(x={range:o,max:u,chart:n,dataMin:d,dataMax:h},p=s.minFromRange.call(x),isNumber(x.newMax)&&(u=x.newMax),b=!1):m=o;else if(m)p=Math.max(u-m,d),u=Math.min(p+m,h),b=!1;else if("ytd"===r){if(!s)return void(i.deferredYTDClick=t);void 0!==h&&void 0!==d||(d=Number.MAX_VALUE,h=Number.MIN_VALUE,n.series.forEach(t=>{t=t.xData;t&&(d=Math.min(t[0],d),h=Math.max(t[t.length-1],h))}),e=!1),f=i.getYTDExtremes(h,d,n.time.useUTC),p=g=f.min,u=f.max}else"all"===r&&s&&(n.navigator&&n.navigator.baseSeries[0]&&(n.navigator.baseSeries[0].xAxis.options.range=void 0),p=d,u=h);if(b&&o._offsetMin&&defined(p)&&(p+=o._offsetMin),o._offsetMax&&defined(u)&&(u+=o._offsetMax),this.dropdown&&(this.dropdown.selectedIndex=t+1),s)s.setExtremes(p,u,pick(e,!0),void 0,{trigger:"rangeSelectorButton",rangeSelectorButton:o}),n.setFixedRange(o._range);else{c=splat(n.options.xAxis)[0];const v=addEvent(n,"afterGetAxes",function(){const t=n.xAxis[0];t.range=t.options.range=m,t.min=t.options.min=g});addEvent(n,"load",function(){const t=n.xAxis[0];n.setFixedRange(o._range),t.options.range=c.range,t.options.min=c.min,v()})}fireEvent(this,"afterBtnClick")}}setSelected(t){this.selected=this.options.selected=t}init(e){function t(){var t=i.minInput,e=i.maxInput;t&&t.blur&&fireEvent(t,"blur"),e&&e.blur&&fireEvent(e,"blur")}const i=this,n=e.options.rangeSelector,o=n.buttons||i.defaultButtons.slice(),s=n.selected;i.chart=e,i.options=n,i.buttons=[],i.buttonOptions=o,this.eventsToUnbind=[],this.eventsToUnbind.push(addEvent(e.container,"mousedown",t)),this.eventsToUnbind.push(addEvent(e,"resize",t)),o.forEach(i.computeButtonRange),void 0!==s&&o[s]&&this.clickButton(s,!1),this.eventsToUnbind.push(addEvent(e,"load",function(){e.xAxis&&e.xAxis[0]&&addEvent(e.xAxis[0],"setExtremes",function(t){isNumber(this.max)&&isNumber(this.min)&&this.max-this.min!==e.fixedRange&&"rangeSelectorButton"!==t.trigger&&"updatedData"!==t.trigger&&i.forcedDataGrouping&&!i.frozenStates&&this.setDataGrouping(!1,!1)})})),this.createElements()}updateButtonStates(){const u=this,t=this.chart,e=this.dropdown,i=this.dropdownLabel,c=t.xAxis[0],m=Math.round(c.max-c.min),g=!c.hasVisibleSeries,n=t.scroller&&t.scroller.getUnionExtremes()||c,x=n.dataMin,f=n.dataMax,o=u.getYTDExtremes(f,x,t.time.useUTC),b=o.min,v=o.max,y=u.selected,B=u.options.allButtonsEnabled,w=new Array(u.buttonOptions.length).fill(0),E=isNumber(y),s=u.buttons;let I=!1,S=null;u.buttonOptions.forEach((t,e)=>{var i=t._range,n=t.type,o=t.count||1,t=t._offsetMax-t._offsetMin,s=e===y,a=i>f-x,r=i<c.minRange;let l=!1,d=i===m;s&&a&&(I=!0),c.isOrdinal&&c.ordinal?.positions&&i&&m<i?(h=c.ordinal.positions,p=OrdinalAxis.Additions.findIndexOf(h,c.min,!0),h[Math.min(OrdinalAxis.Additions.findIndexOf(h,c.max,!0)+1,h.length-1)]-h[p]>i&&(d=!0)):("month"===n||"year"===n)&&m+36e5>=864e5*{month:28,year:365}[n]*o-t&&m-36e5<=864e5*{month:31,year:366}[n]*o+t?d=!0:"ytd"===n?(d=v-b+t===m,l=!s):"all"===n&&(d=c.max-c.min>=f-x);var h=!B&&!(I&&"all"===n)&&(a||r||g),p=I&&"all"===n||!l&&d||s&&u.frozenStates;h?w[e]=3:!p||E&&e!==y||(S=e)}),null!==S?(w[S]=2,u.setSelected(S)):(u.setSelected(),i&&(i.setState(0),i.attr({text:(defaultOptions.lang.rangeSelectorZoom||"")+" ▾"})));for(let t=0;t<w.length;t++){var a=w[t];const r=s[t];r.state!==a&&(r.setState(a),e&&(e.options[t+1].disabled=3===a,2===a&&(i&&(i.setState(2),i.attr({text:u.buttonOptions[t].text+" ▾"})),e.selectedIndex=t+1),a=i.getBBox(),css(e,{width:a.width+"px",height:a.height+"px"})))}}computeButtonRange(t){var e=t.type,i=t.count||1,n={millisecond:1,second:1e3,minute:6e4,hour:36e5,day:864e5,week:6048e5};n[e]?t._range=n[e]*i:"month"!==e&&"year"!==e||(t._range=24*{month:30,year:365}[e]*36e5*i),t._offsetMin=pick(t.offsetMin,0),t._offsetMax=pick(t.offsetMax,0),t._range+=t._offsetMax-t._offsetMin}getInputValue(t){t="min"===t?this.minInput:this.maxInput;const e=this.chart.options.rangeSelector;var i=this.chart.time;return t?("text"===t.type&&e.inputDateParser||this.defaultInputDateParser)(t.value,i.useUTC,i):0}setInputValue(e,i){const n=this.options,o=this.chart.time,s="min"===e?this.minInput:this.maxInput,a="min"===e?this.minDateBox:this.maxDateBox;if(s){var e=s.getAttribute("data-hc-time");let t=defined(e)?Number(e):void 0;defined(i)&&(e=t,defined(e)&&s.setAttribute("data-hc-time-previous",e),s.setAttribute("data-hc-time",i),t=i),s.value=o.dateFormat(this.inputTypeFormats[s.type]||n.inputEditDateFormat,t),a&&a.attr({text:o.dateFormat(n.inputDateFormat,t)})}}setInputExtremes(t,e,i){const n="min"===t?this.minInput:this.maxInput;if(n){t=this.inputTypeFormats[n.type];const o=this.chart.time;t&&(e=o.dateFormat(t,e),n.min!==e&&(n.min=e),e=o.dateFormat(t,i),n.max!==e&&(n.max=e))}}showInput(t){var e,i,n,o,s,a,r="min"===t?this.minDateBox:this.maxDateBox,t="min"===t?this.minInput:this.maxInput;t&&r&&this.inputGroup&&(e="text"===t.type,{translateX:i=0,translateY:n=0}=this.inputGroup,{x:r=0,width:o=0,height:s=0}=r,a=this.options["inputBoxWidth"],css(t,{width:e?o+(a?-2:20)+"px":"auto",height:s-2+"px",border:"2px solid silver"}),e&&a?css(t,{left:i+r+"px",top:n+"px"}):css(t,{left:Math.min(Math.round(r+i-(t.offsetWidth-o)/2),this.chart.chartWidth-t.offsetWidth)+"px",top:n-(t.offsetHeight-s)/2+"px"}))}hideInput(t){t="min"===t?this.minInput:this.maxInput;t&&css(t,{top:"-9999em",border:0,width:"1px",height:"1px"})}defaultInputDateParser(t,e,i){var n;let o=t.split("/").join("-").split(" ").join("T"),s=(-1===o.indexOf("T")&&(o+="T00:00"),e?o+="Z":!H.isSafari||6<(n=o).length&&(n.lastIndexOf("-")===n.length-6||n.lastIndexOf("+")===n.length-6)||(n=new Date(o).getTimezoneOffset()/60,o+=n<=0?`+${pad(-n)}:00`:`-${pad(n)}:00`),Date.parse(o));return isNumber(s)||(n=t.split("-"),s=Date.UTC(pInt(n[0]),pInt(n[1])-1,pInt(n[2]))),i&&e&&isNumber(s)&&(s+=i.getTimezoneOffset(s)),s}drawInput(e){const{chart:d,div:t,inputGroup:i}=this,h=this,n=d.renderer.style||{},o=d.renderer,s=d.options.rangeSelector,a=defaultOptions.lang,p="min"===e;function r(t){const{maxInput:e,minInput:i}=h,n=d.xAxis[0],o=d.scroller?.getUnionExtremes()||n,s=o.dataMin,a=o.dataMax,r=d.xAxis[0].getExtremes()[t];let l=h.getInputValue(t);isNumber(l)&&l!==r&&(p&&e&&isNumber(s)?l>Number(e.getAttribute("data-hc-time"))?l=void 0:l<s&&(l=s):i&&isNumber(a)&&(l<Number(i.getAttribute("data-hc-time"))?l=void 0:l>a&&(l=a)),void 0!==l&&n.setExtremes(p?l:n.min,p?n.max:l,void 0,void 0,{trigger:"rangeSelectorInput"}))}var l=a[p?"rangeSelectorFrom":"rangeSelectorTo"]||"";const u=o.label(l,0).addClass("highcharts-range-label").attr({padding:l?2:0,height:l?s.inputBoxHeight:0}).add(i),c=o.label("",0).addClass("highcharts-range-input").attr({padding:2,width:s.inputBoxWidth,height:s.inputBoxHeight,"text-align":"center"}).on("click",function(){h.showInput(e),h[e+"Input"].focus()}),m=(d.styledMode||c.attr({stroke:s.inputBoxBorderColor,"stroke-width":1}),c.add(i),createElement("input",{name:e,className:"highcharts-range-selector"},void 0,t));m.setAttribute("type",preferredInputType(s.inputDateFormat||"%e %b %Y")),d.styledMode||(u.css(merge(n,s.labelStyle)),c.css(merge({color:"#333333"},n,s.inputStyle)),css(m,extend({position:"absolute",border:0,boxShadow:"0 0 15px rgba(0,0,0,0.3)",width:"1px",height:"1px",padding:0,textAlign:"center",fontSize:n.fontSize,fontFamily:n.fontFamily,top:"-9999em"},s.inputStyle))),m.onfocus=()=>{h.showInput(e)};let g=!(m.onblur=()=>{m===H.doc.activeElement&&r(e),h.hideInput(e),h.setInputValue(e),m.blur()});return m.onchange=()=>{g||(r(e),h.hideInput(e),m.blur())},m.onkeypress=t=>{13===t.keyCode&&r(e)},m.onkeydown=t=>{g=!0,"ArrowUp"!==t.key&&"ArrowDown"!==t.key&&"Tab"!==t.key||r(e)},m.onkeyup=()=>{g=!1},{dateBox:c,input:m,label:u}}getPosition(){var t=this.chart,e=t.options.rangeSelector,t="top"===e.verticalAlign?t.plotTop-t.axisOffset[0]:0;return{buttonTop:t+e.buttonPosition.y,inputTop:t+e.inputPosition.y-10}}getYTDExtremes(t,e,i){const n=this.chart.time,o=new n.Date(t),s=n.get("FullYear",o),a=i?n.Date.UTC(s,0,1):+new n.Date(s,0,1),r=Math.max(e,a),l=o.getTime();return{max:Math.min(t||l,l),min:r}}createElements(){const t=this.chart,e=t.renderer,i=t.container,n=t.options,o=n.rangeSelector,s=o.inputEnabled,a=pick(n.chart.style?.zIndex,0)+1;var r;!1!==o.enabled&&(this.group=e.g("range-selector-group").attr({zIndex:7}).add(),this.div=createElement("div",void 0,{position:"relative",height:0,zIndex:a}),this.buttonOptions.length&&this.renderButtons(),i.parentNode&&i.parentNode.insertBefore(this.div,i),s&&(this.inputGroup=e.g("input-group").add(this.group),r=this.drawInput("min"),this.minDateBox=r.dateBox,this.minLabel=r.label,this.minInput=r.input,r=this.drawInput("max"),this.maxDateBox=r.dateBox,this.maxLabel=r.label,this.maxInput=r.input))}render(t,e){const i=this.chart,n=i.options,o=n.rangeSelector,s=o.inputEnabled;if(!1!==o.enabled){if(s){this.setInputValue("min",t),this.setInputValue("max",e);t=i.scroller&&i.scroller.getUnionExtremes()||i.xAxis[0]||{};if(defined(t.dataMin)&&defined(t.dataMax)&&(e=i.xAxis[0].minRange||0,this.setInputExtremes("min",t.dataMin,Math.min(t.dataMax,this.getInputValue("max"))-e),this.setInputExtremes("max",Math.max(t.dataMin,this.getInputValue("min"))+e,t.dataMax)),this.inputGroup){let i=0;[this.minLabel,this.minDateBox,this.maxLabel,this.maxDateBox].forEach(t=>{var e;t&&(e=t.getBBox()["width"],e&&(t.attr({x:i}),i+=e+o.inputSpacing))})}}this.alignElements(),this.updateButtonStates()}}renderButtons(){const{buttons:t,chart:e,options:i}=this;var n=defaultOptions.lang;const s=e.renderer,a=merge(i.buttonTheme),r=a&&a.states,l=a.width||28,d=(delete a.width,delete a.states,this.buttonGroup=s.g("range-selector-buttons").add(this.group),this.dropdown=createElement("select",void 0,{position:"absolute",padding:0,border:0,cursor:"pointer",opacity:1e-4},this.div));var o=e.userOptions.rangeSelector?.buttonTheme;this.dropdownLabel=s.button("",0,0,()=>{},merge(a,{"stroke-width":pick(a["stroke-width"],0),width:"auto",paddingLeft:pick(i.buttonTheme.paddingLeft,o?.padding,8),paddingRight:pick(i.buttonTheme.paddingRight,o?.padding,8)}),r&&r.hover,r&&r.select,r&&r.disabled).hide().add(this.group),addEvent(d,"touchstart",()=>{d.style.fontSize="16px"});const h=H.isMS?"mouseover":"mouseenter",p=H.isMS?"mouseout":"mouseleave";addEvent(d,h,()=>{fireEvent(this.dropdownLabel.element,h)}),addEvent(d,p,()=>{fireEvent(this.dropdownLabel.element,p)}),addEvent(d,"change",()=>{var t=this.buttons[d.selectedIndex-1];fireEvent(t.element,"click")}),this.zoomText=s.label(n.rangeSelectorZoom||"",0).attr({padding:i.buttonTheme.padding,height:i.buttonTheme.height,paddingLeft:0,paddingRight:0}).add(this.buttonGroup),this.chart.styledMode||(this.zoomText.css(i.labelStyle),a["stroke-width"]=pick(a["stroke-width"],0)),createElement("option",{textContent:this.zoomText.textStr,disabled:!0},void 0,d),this.buttonOptions.forEach((n,o)=>{createElement("option",{textContent:n.title||n.text},void 0,d),t[o]=s.button(n.text,0,0,t=>{const e=n.events&&n.events.click;let i;!1!==(i=e?e.call(n,t):i)&&this.clickButton(o),this.isActive=!0},a,r&&r.hover,r&&r.select,r&&r.disabled).attr({"text-align":"center",width:l}).add(this.buttonGroup),n.title&&t[o].attr("title",n.title)})}alignElements(){const{buttonGroup:o,buttons:s,chart:a,group:r,inputGroup:l,options:d,zoomText:h}=this;var p=a.options;const i=p.exporting&&!1!==p.exporting.enabled&&p.navigation&&p.navigation.buttonOptions,{buttonPosition:u,inputPosition:c,verticalAlign:m}=d;p=(t,e)=>i&&this.titleCollision(a)&&"top"===m&&"right"===e.align&&e.y-t.getBBox().height-12<(i.y||0)+(i.height||0)+a.spacing[0]?-40:0;let g=a.plotLeft;if(r&&u&&c){let t=u.x-a.spacing[3];if(o){if(this.positionButtons(),!this.initialButtonGroupWidth){let i=0;h&&(i+=h.getBBox().width+5),s.forEach((t,e)=>{i+=t.width||0,e!==s.length-1&&(i+=d.buttonSpacing)}),this.initialButtonGroupWidth=i}g-=a.spacing[3];var x=p(o,u);this.alignButtonGroup(x),this.buttonGroup?.translateY&&this.dropdownLabel.attr({y:this.buttonGroup.translateY}),r.placed=o.placed=a.hasLoaded}let e=0;l&&(e=p(l,c),"left"===c.align?t=g:"right"===c.align&&(t=-Math.max(a.axisOffset[1],-e)),l.align({y:c.y,width:l.getBBox().width,align:c.align,x:c.x+t-2},!0,a.spacingBox),l.placed=a.hasLoaded),this.handleCollision(e),r.align({verticalAlign:m},!0,a.spacingBox);x=r.alignAttr.translateY;let i=r.getBBox().height+20,n=0;"bottom"===m&&(p=(p=a.legend&&a.legend.options)&&"bottom"===p.verticalAlign&&p.enabled&&!p.floating?a.legend.legendHeight+pick(p.margin,10):0,i=i+p-20,n=x-i-(d.floating?0:d.y)-(a.titleOffset?a.titleOffset[2]:0)-10),"top"===m?(d.floating&&(n=0),a.titleOffset&&a.titleOffset[0]&&(n=a.titleOffset[0]),n+=a.margin[0]-a.spacing[0]||0):"middle"===m&&(c.y===u.y?n=x:(c.y||u.y)&&(c.y<0||u.y<0?n-=Math.min(c.y,u.y):n=x-i)),r.translate(d.x,d.y+Math.floor(n));const{minInput:f,maxInput:b,dropdown:v}=this;d.inputEnabled&&f&&b&&(f.style.marginTop=r.translateY+"px",b.style.marginTop=r.translateY+"px"),v&&(v.style.marginTop=r.translateY+"px")}}alignButtonGroup(t,e){const{chart:i,options:n,buttonGroup:o}=this;var s=n["buttonPosition"],a=i.plotLeft-i.spacing[3];let r=s.x-i.spacing[3];"right"===s.align?r+=t-a:"center"===s.align&&(r-=a/2),o&&o.align({y:s.y,width:pick(e,this.initialButtonGroupWidth),align:s.align,x:r},!0,i.spacingBox)}positionButtons(){const{buttons:i,chart:t,options:n,zoomText:e}=this;var o=t.hasLoaded?"animate":"attr",s=n["buttonPosition"],a=t.plotLeft;let r=a;e&&"hidden"!==e.visibility&&(e[o]({x:pick(a+s.x,a)}),r+=s.x+e.getBBox().width+5);for(let t=0,e=this.buttonOptions.length;t<e;++t)"hidden"!==i[t].visibility?(i[t][o]({x:r}),r+=(i[t].width||0)+n.buttonSpacing):i[t][o]({x:a})}handleCollision(o){const{chart:t,buttonGroup:s,inputGroup:a}=this,{buttonPosition:r,dropdown:e,inputPosition:l}=this.options;var i=()=>{let e=0;return this.buttons.forEach(t=>{t=t.getBBox();t.width>e&&(e=t.width)}),e},n=t=>{var e,i,n;return!(!a?.alignOptions||!s)&&(e=a.alignAttr.translateX+a.alignOptions.x-o+a.getBBox().x+2,i=a.alignOptions.width||0,e<(n=s.alignAttr.translateX+s.getBBox().x)+t&&n<e+i&&r.y<l.y+a.getBBox().height)},d=()=>{a&&s&&a.attr({translateX:a.alignAttr.translateX+(t.axisOffset[1]>=-o?0:-o),translateY:a.alignAttr.translateY+s.getBBox().height+10})};if(s){if("always"===e)return this.collapseButtons(),void(n(i())&&d());"never"===e&&this.expandButtons()}a&&s?l.align===r.align||n(this.initialButtonGroupWidth+20)?"responsive"===e?(this.collapseButtons(),n(i())&&d()):d():"responsive"===e&&this.expandButtons():s&&"responsive"===e&&(this.initialButtonGroupWidth>t.plotWidth?this.collapseButtons():this.expandButtons())}collapseButtons(){const{buttons:t,zoomText:e}=this;!0!==this.isCollapsed&&(this.isCollapsed=!0,e.hide(),t.forEach(t=>{t.hide()}),this.showDropdown())}expandButtons(){const{buttons:t,zoomText:e}=this;!1!==this.isCollapsed&&(this.isCollapsed=!1,this.hideDropdown(),e.show(),t.forEach(t=>{t.show()}),this.positionButtons())}showDropdown(){const{buttonGroup:t,chart:e,dropdownLabel:i,dropdown:n}=this;var o,s;t&&n&&({translateX:o=0,translateY:s=0}=t,o=e.plotLeft+o,s=s,i.attr({x:o,y:s}).show(),css(n,{left:o+"px",top:s+"px",visibility:"inherit"}),this.hasVisibleDropdown=!0)}hideDropdown(){var t=this["dropdown"];t&&(this.dropdownLabel.hide(),css(t,{visibility:"hidden",width:"1px",height:"1px"}),this.hasVisibleDropdown=!1)}getHeight(){const t=this.options,e=this.group,i=t.inputPosition,n=t.buttonPosition,o=t.y,s=n.y,a=i.y;let r=0;if(t.height)return t.height;this.alignElements(),r=e?e.getBBox(!0).height+13+o:0;var l=Math.min(a,s);return(a<0&&s<0||0<a&&0<s)&&(r+=Math.abs(l)),r}titleCollision(t){return!(t.options.title.text||t.options.subtitle.text)}update(t,e=!0){var i=this.chart;merge(!0,i.options.rangeSelector,t),this.destroy(),this.init(i),e&&this.render()}destroy(){const i=this,t=i.minInput,e=i.maxInput;i.eventsToUnbind&&(i.eventsToUnbind.forEach(t=>t()),i.eventsToUnbind=void 0),destroyObjectProperties(i.buttons),t&&(t.onfocus=t.onblur=t.onchange=null),e&&(e.onfocus=e.onblur=e.onchange=null),objectEach(i,function(t,e){t&&"chart"!==e&&(t instanceof SVGElement?t.destroy():t instanceof window.HTMLElement&&discardElement(t)),t!==RangeSelector.prototype[e]&&(i[e]=null)},this)}}extend(RangeSelector.prototype,{defaultButtons:[{type:"month",count:1,text:"1m",title:"View 1 month"},{type:"month",count:3,text:"3m",title:"View 3 months"},{type:"month",count:6,text:"6m",title:"View 6 months"},{type:"ytd",text:"YTD",title:"View year to date"},{type:"year",count:1,text:"1y",title:"View 1 year"},{type:"all",text:"All",title:"View all"}],inputTypeFormats:{"datetime-local":"%Y-%m-%dT%H:%M:%S",date:"%Y-%m-%d",time:"%H:%M:%S"}});export default RangeSelector;