"use strict";import FunnelSeriesDefaults from"./FunnelSeriesDefaults.js";import H from"../../Core/Globals.js";const{composed,noop}=H;import BorderRadius from"../../Extensions/BorderRadius.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{column:ColumnSeries,pie:PieSeries}=SeriesRegistry.seriesTypes;import U from"../../Core/Utilities.js";const{addEvent,correctFloat,extend,fireEvent,isArray,merge,pick,pushUnique,relativeLength,splat}=U,baseAlignDataLabel=SeriesRegistry.series.prototype.alignDataLabel;function getLength(e,t){return/%$/.test(e)?t*parseInt(e,10)/100:parseInt(e,10)}class FunnelSeries extends PieSeries{alignDataLabel(e,t,i,s,a){const n=e.series,o=n.options.reversed,d=e.dlBox||e.shapeArgs,{align:r,padding:l=0,verticalAlign:h}=i,p=((n.options||{}).dataLabels||{}).inside,g=n.center[1],c=e.plotY||0,u=o?2*g-c:c,x=t.height??t.getBBox().height,y=n.getWidthAt(u-d.height/2+x),L="middle"===h?(d.topWidth-d.bottomWidth)/4:(y-d.bottomWidth)/2;let b=d.y,f=d.x;"middle"===h?b=d.y-d.height/2+x/2:"top"===h&&(b=d.y-d.height+x+l),("top"===h&&!o||"bottom"===h&&o||"middle"===h)&&("right"===r?f=d.x-l+L:"left"===r&&(f=d.x+l-L)),s={x:f,y:o?b-d.height:b,width:d.bottomWidth,height:d.height},i.verticalAlign="bottom",p&&(i.distance=void 0),p&&e.visible&&baseAlignDataLabel.call(n,e,t,i,s,a),p&&(!e.visible&&e.dataLabel&&(e.dataLabel.placed=!1),e.contrastColor&&t.css({color:e.contrastColor}))}drawDataLabels(){(splat(this.options.dataLabels)[0].inside?ColumnSeries:PieSeries).prototype.drawDataLabels.call(this)}getDataLabelPosition(e,t){var i=e.plotY||0,s=e.half?1:-1,a=this.getX(i,!!e.half,e);return{distance:t,natural:{x:0,y:i},computed:{},alignment:e.half?"right":"left",connectorPosition:{breakAt:{x:a+(t-5)*s,y:i},touchingSliceAt:{x:a+t*s,y:i}}}}translate(){const s=this,e=s.chart,t=s.options,d=t.reversed,i=t.ignoreHiddenPoint,a=BorderRadius.optionsToObject(t.borderRadius),n=e.plotWidth,o=e.plotHeight,Y=t.center,r=getLength(Y[0],n),l=getLength(Y[1],o),h=getLength(t.width,n),p=getLength(t.height,o),g=getLength(t.neckWidth,n),c=getLength(t.neckHeight,o),u=l-p/2+p-c,x=s.points,w=relativeLength(a.radius,h),y=a.scope,E="left"===t.dataLabels.position?1:0,L=e=>{var t=Math.tan(e/2),i=Math.cos(v),s=Math.sin(v);let a=w,n=a/t,o=Math.tan((Math.PI-e)/3.2104);return n>M&&(n=M,a=n*t),o*=a,{dx:[n*i,(n-o)*i,n-o,n],dy:[n*s,(n-o)*s,n-o,n].map(e=>d?-e:e)}};let b=0,T=0,f,m,S,v,M,A,C,P,W,F,D,R;s.getWidthAt=function(e){var t=l-p/2;return e>u||p===c?g:g+(h-g)*(1-(e-t)/(p-c))},s.getX=function(e,t,i){return r+(t?-1:1)*(s.getWidthAt(d?2*l-e:e)/2+(i.dataLabel?.dataLabelPosition?.distance??relativeLength(this.options.dataLabels?.distance||0,h)))},s.center=[r,l,p],s.centerX=r;for(const j of x)!j.y||!j.isValid()||i&&!1===j.visible||(b+=j.y);for(const H of x){if(R=null,S=b?H.y/b:0,C=l-p/2+T*p,F=C+S*p,f=s.getWidthAt(C),A=r-f/2,P=A+f,f=s.getWidthAt(F),W=r-f/2,D=W+f,correctFloat(C)>=u?(A=W=r-g/2,P=D=r+g/2):F>u&&(R=F,f=s.getWidthAt(u),W=r-f/2,D=W+f,F=u),d&&(C=2*l-C,F=2*l-F,null!==R&&(R=2*l-R)),!w||"point"!==y&&0!==H.index&&H.index!==x.length-1&&null===R)m=[["M",A,C],["L",P,C],["L",D,F]],null!==R&&m.push(["L",D,R],["L",W,R]),m.push(["L",W,F]);else{var k=Math.abs(F-C),B=P-D,I=D-W,U=Math.sqrt(B*B+k*k);v=Math.atan(0!=B?k/B:1/0),M=U/2,null!==R&&(M=Math.min(M,Math.abs(R-F)/2)),1<=I&&(M=Math.min(M,I/2));let e=L(v);m="stack"===y&&0!==H.index?[["M",A,C],["L",P,C]]:[["M",A+e.dx[0],C+e.dy[0]],["C",A+e.dx[1],C+e.dy[1],A+e.dx[2],C,A+e.dx[3],C],["L",P-e.dx[3],C],["C",P-e.dx[2],C,P-e.dx[1],C+e.dy[1],P-e.dx[0],C+e.dy[0]]],null!==R?(k=L(Math.PI/2),e=L(Math.PI/2+v),m.push(["L",D+e.dx[0],F-e.dy[0]],["C",D+e.dx[1],F-e.dy[1],D,F+e.dy[2],D,F+e.dy[3]]),"stack"===y&&H.index!==x.length-1?m.push(["L",D,R],["L",W,R]):m.push(["L",D,R-k.dy[3]],["C",D,R-k.dy[2],D-k.dx[2],R,D-k.dx[3],R],["L",W+k.dx[3],R],["C",W+k.dx[2],R,W,R-k.dy[2],W,R-k.dy[3]]),m.push(["L",W,F+e.dy[3]],["C",W,F+e.dy[2],W-e.dx[1],F-e.dy[1],W-e.dx[0],F-e.dy[0]])):1<=I?(e=L(Math.PI-v),"stack"===y&&0===H.index?m.push(["L",D,F],["L",W,F]):m.push(["L",D+e.dx[0],F-e.dy[0]],["C",D+e.dx[1],F-e.dy[1],D-e.dx[2],F,D-e.dx[3],F],["L",W+e.dx[3],F],["C",W+e.dx[2],F,W-e.dx[1],F-e.dy[1],W-e.dx[0],F-e.dy[0]])):(e=L(Math.PI-2*v),m.push(["L",W+e.dx[0],F-e.dy[0]],["C",W+e.dx[1],F-e.dy[1],W-e.dx[1],F-e.dy[1],W-e.dx[0],F-e.dy[0]]))}m.push(["Z"]),H.shapeType="path",H.shapeArgs={d:m},H.percentage=100*S,H.plotX=r,H.plotY=(C+(R||F))/2,H.tooltipPos=[r,H.plotY],H.dlBox={x:W,y:C,topWidth:P-A,bottomWidth:D-W,height:Math.abs(pick(R,F)-C),width:NaN},H.slice=noop,H.half=E,!H.isValid()||i&&!1===H.visible||(T+=S)}fireEvent(s,"afterTranslate")}sortByAngle(e){e.sort((e,t)=>e.plotY-t.plotY)}}FunnelSeries.defaultOptions=merge(PieSeries.defaultOptions,FunnelSeriesDefaults),extend(FunnelSeries.prototype,{animate:noop}),function(){function t(){for(const t of this.series){let e=t.options&&t.options.dataLabels;isArray(e)&&(e=e[0]),t.is("pie")&&t.placeDataLabels&&e&&!e.inside&&t.placeDataLabels()}}(FunnelSeries||(FunnelSeries={})).compose=function(e){pushUnique(composed,"FunnelSeries")&&addEvent(e,"afterHideAllOverlappingLabels",t)}}(),SeriesRegistry.registerSeriesType("funnel",FunnelSeries);export default FunnelSeries;