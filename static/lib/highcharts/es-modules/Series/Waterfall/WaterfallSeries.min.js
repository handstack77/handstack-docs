"use strict";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{column:ColumnSeries,line:LineSeries}=SeriesRegistry.seriesTypes;import U from"../../Core/Utilities.js";const{addEvent,arrayMax,arrayMin,correctFloat,crisp,extend,isNumber,merge,objectEach,pick}=U;import WaterfallAxis from"../../Core/Axis/WaterfallAxis.js";import WaterfallPoint from"./WaterfallPoint.js";import WaterfallSeriesDefaults from"./WaterfallSeriesDefaults.js";function ownProp(t,e){return Object.hasOwnProperty.call(t,e)}class WaterfallSeries extends ColumnSeries{generatePoints(){ColumnSeries.prototype.generatePoints.apply(this);for(let t=0,e=this.points.length;t<e;t++){const a=this.points[t],s=this.processedYData[t];isNumber(s)&&(a.isIntermediateSum||a.isSum)&&(a.y=correctFloat(s))}}processData(t){const e=this,a=e.options,s=e.yData,r=a.data,i=s.length,o=a.threshold||0;let l,n,h,c,d,p;for(let t=h=n=c=d=0;t<i;t++)p=s[t],l=r&&r[t]?r[t]:{},"sum"===p||l.isSum?s[t]=correctFloat(h):"intermediateSum"===p||l.isIntermediateSum?(s[t]=correctFloat(n),n=0):(h+=p,n+=p),c=Math.min(h,c),d=Math.max(h,d);super.processData.call(this,t),a.stacking||(e.dataMin=c+o,e.dataMax=d)}toYData(t){return t.isSum?"sum":t.isIntermediateSum?"intermediateSum":t.y}updateParallelArrays(t,e){super.updateParallelArrays.call(this,t,e),"sum"!==this.yData[0]&&"intermediateSum"!==this.yData[0]||(this.yData[0]=null)}pointAttribs(t,e){var a=this.options.upColor;a&&!t.options.color&&isNumber(t.y)&&(t.color=0<t.y?a:void 0);const s=ColumnSeries.prototype.pointAttribs.call(this,t,e);return delete s.dashstyle,s}getGraphPath(){return[["M",0,0]]}getCrispPath(){const t=this.data.filter(t=>isNumber(t.y)),a=this.yAxis,s=t.length,r=this.graph?.strokeWidth()||0,i=this.xAxis.reversed,o=this.yAxis.reversed,l=this.options.stacking,n=[];for(let e=1;e<s;e++)if(this.options.connectNulls||isNumber(this.data[t[e].index-1].y)){var h=t[e].box,c=t[e-1],d=c.y||0,p=t[e-1].box;if(h&&p){var u=a.waterfall.stacks[this.stackKey],g=0<d?-p.height:0;if(u&&p&&h){var u=u[e-1];let t;t=l?(u=u.connectorThreshold,crisp(a.translate(u,!1,!0,!1,!0)+(o?g:0),r)):crisp(p.y+(c.minPointLengthOffset||0),r),n.push(["M",(p.x||0)+(!i&&p.width||0),t],["L",(h.x||0)+(i&&h.width||0),t])}if(p&&n.length&&(!l&&d<0&&!o||0<d&&o)){const y=n[n.length-2],m=(y&&"number"==typeof y[2]&&(y[2]+=p.height||0),n[n.length-1]);m&&"number"==typeof m[2]&&(m[2]+=p.height||0)}}}return n}drawGraph(){LineSeries.prototype.drawGraph.call(this),this.graph&&this.graph.attr({d:this.getCrispPath()})}setStackedPoints(t){const e=this,a=e.options,s=t.waterfall?.stacks,r=a.threshold||0,i=e.stackKey,o=e.xData,l=o.length;let n=r,h=n,c,d=0,p=0,u=0,g,y,m,f,S,b,x,k;var P=(t,e,a,s)=>{if(c){if(g)for(;a<g;a++)c.stackState[a]+=s;else c.stackState[0]=t,g=c.stackState.length;c.stackState.push(c.stackState[g-1]+e)}};if(t.stacking&&s&&e.reserveSpace()){k=s.changed,(x=s.alreadyChanged)&&x.indexOf(i)<0&&(k=!0),s[i]||(s[i]={});const T=s[i];if(T)for(let t=0;t<l;t++)b=o[t],T[b]&&!k||(T[b]={negTotal:0,posTotal:0,stackTotal:0,threshold:0,stateIndex:0,stackState:[],label:k&&T[b]?T[b].label:void 0}),c=T[b],0<=(S=e.yData[t])?c.posTotal+=S:c.negTotal+=S,f=a.data[t],y=c.absolutePos=c.posTotal,m=c.absoluteNeg=c.negTotal,c.stackTotal=y+m,g=c.stackState.length,f&&f.isIntermediateSum?(P(u,p,0,u),u=p,p=r,n^=h,h^=n,n^=h):f&&f.isSum?(P(r,d,g,0),n=r):(P(n,S,0,d),f&&(d+=S,p+=S)),c.stateIndex++,c.threshold=n,n+=c.stackTotal;s.changed=!1,s.alreadyChanged||(s.alreadyChanged=[]),s.alreadyChanged.push(i)}}getExtremes(){var t=this.options.stacking;let e,a,s;return t?(e=this.yAxis.waterfall.stacks,a=this.stackedYNeg=[],s=this.stackedYPos=[],"overlap"===t?objectEach(e[this.stackKey],function(t){a.push(arrayMin(t.stackState)),s.push(arrayMax(t.stackState))}):objectEach(e[this.stackKey],function(t){a.push(t.negTotal+t.threshold),s.push(t.posTotal+t.threshold)}),{dataMin:arrayMin(a),dataMax:arrayMax(s)}):{dataMin:this.dataMin,dataMax:this.dataMax}}}WaterfallSeries.defaultOptions=merge(ColumnSeries.defaultOptions,WaterfallSeriesDefaults),WaterfallSeries.compose=WaterfallAxis.compose,extend(WaterfallSeries.prototype,{pointValKey:"y",showLine:!0,pointClass:WaterfallPoint}),addEvent(WaterfallSeries,"afterColumnTranslate",function(){const e=this,{options:t,points:a,yAxis:s}=e,r=pick(t.minPointLength,5),i=r/2,o=t.threshold||0,l=t.stacking,n=s.waterfall.stacks[e.stackKey];let h=o,c=o,d,p,u,g;for(let t=0;t<a.length;t++){const f=a[t],S=e.processedYData[t],b=f.shapeArgs,x=extend({x:0,y:0,width:0,height:0},b||{});f.box=x;var y=[0,S],m=f.y||0;if(l){if(n){const k=n[t],P=("overlap"===l?(p=k.stackState[k.stateIndex--],d=0<=m?p:p-m,ownProp(k,"absolutePos")&&delete k.absolutePos,ownProp(k,"absoluteNeg")&&delete k.absoluteNeg):(d=0<=m?(p=k.threshold+k.posTotal,k.posTotal-=m,p):(p=k.threshold+k.negTotal,k.negTotal-=m,p-m),k.posTotal||isNumber(k.absolutePos)&&ownProp(k,"absolutePos")&&(k.posTotal=k.absolutePos,delete k.absolutePos),k.negTotal||isNumber(k.absoluteNeg)&&ownProp(k,"absoluteNeg")&&(k.negTotal=k.absoluteNeg,delete k.absoluteNeg)),f.isSum||(k.connectorThreshold=k.threshold+k.stackTotal),g=s.reversed?(u=0<=m?d-m:d+m,d):(u=d)-m,f.below=u<=o,x.y=s.translate(u,!1,!0,!1,!0),x.height=Math.abs(x.y-s.translate(g,!1,!0,!1,!0)),s.waterfall.dummyStackItem);P&&(P.x=t,P.label=n[t].label,P.setOffset(e.pointXOffset||0,e.barW||0,e.stackedYNeg[t],e.stackedYPos[t],void 0,this.xAxis))}}else d=Math.max(c,c+m)+y[0],x.y=s.translate(d,!1,!0,!1,!0),f.isSum?(x.y=s.translate(y[1],!1,!0,!1,!0),x.height=Math.min(s.translate(y[0],!1,!0,!1,!0),s.len)-x.y,f.below=y[1]<=o):f.isIntermediateSum?(g=0<=m?(u=y[1]+h,h):(u=h,y[1]+h),s.reversed&&(u^=g,g^=u,u^=g),x.y=s.translate(u,!1,!0,!1,!0),x.height=Math.abs(x.y-Math.min(s.translate(g,!1,!0,!1,!0),s.len)),h+=y[1],f.below=u<=o):(x.height=0<S?s.translate(c,!1,!0,!1,!0)-x.y:s.translate(c,!1,!0,!1,!0)-s.translate(c-S,!1,!0,!1,!0),c+=S,f.below=c<o),x.height<0&&(x.y+=x.height,x.height*=-1);f.plotY=x.y,f.yBottom=x.y+x.height,x.height<=r&&!f.isNull?(x.height=r,x.y-=i,f.yBottom=x.y+x.height,f.plotY=x.y,f.minPointLengthOffset=m<0?-i:i):(f.isNull&&(x.width=0),f.minPointLengthOffset=0);y=f.plotY+(f.negative?x.height:0),m=(f.below&&(f.plotY+=x.height),f.tooltipPos&&(e.chart.inverted?f.tooltipPos[0]=s.len-y:f.tooltipPos[1]=y),f.isInside=this.isPointInside(f),crisp(f.yBottom,e.borderWidth));x.y=crisp(x.y,e.borderWidth),x.height=m-x.y,merge(!0,f.shapeArgs,x)}},{order:2}),SeriesRegistry.registerSeriesType("waterfall",WaterfallSeries);export default WaterfallSeries;