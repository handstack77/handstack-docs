"use strict";import"../Column/ColumnSeries.js";import PatternFill from"../../Extensions/PatternFill.js";import A from"../../Core/Animation/AnimationUtilities.js";import Chart from"../../Core/Chart/Chart.js";import PictorialPoint from"./PictorialPoint.js";import PictorialUtilities from"./PictorialUtilities.js";import Series from"../../Core/Series/Series.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";import StackItem from"../../Core/Axis/Stacking/StackItem.js";import SVGRenderer from"../../Core/Renderer/SVG/SVGRenderer.js";import U from"../../Core/Utilities.js";const ColumnSeries=SeriesRegistry.seriesTypes.column,animObject=(PatternFill.compose(Chart,Series,SVGRenderer),A)["animObject"],{getStackMetrics,invertShadowGroup,rescalePatternFill}=PictorialUtilities,{addEvent,defined,merge,objectEach,pick}=U;class PictorialSeries extends ColumnSeries{animate(t){const{chart:e,group:i}=this,r=animObject(this.options.animation),s=[this.getSharedClipKey(),r.duration,r.easing,r.defer].join(",");let a=e.sharedClips[s];if(t&&i){const o=this.getClipBox();a||(o.y=o.height,o.height=0,a=e.renderer.clipRect(o),e.sharedClips[s]=a),i.clip(a)}else a&&!a.hasClass("highcharts-animating")&&(t=this.getClipBox(),a.addClass("highcharts-animating").animate(t,r))}animateDrilldown(){}animateDrillupFrom(){}pointAttribs(t){const e=super.pointAttribs.apply(this,arguments),i=this.options,r=i.paths;var s,a,o;return t&&t.shapeArgs&&r&&(o=r[t.index%r.length],{y:s,height:a}=getStackMetrics(this.yAxis,o),(o=o.definition)!==t.pathDef?(t.pathDef=o,e.fill={pattern:{path:{d:o,fill:e.fill,strokeWidth:e["stroke-width"],stroke:e.stroke},x:t.shapeArgs.x,y:s,width:t.shapeArgs.width||0,height:a,patternContentUnits:"objectBoundingBox",backgroundColor:"none",color:"#ff0000"}}):t.pathDef&&t.graphic&&delete e.fill),delete e.stroke,delete e.strokeWidth,e}getExtremes(){const e=super.getExtremes.apply(this,arguments),t=this.options.paths;return t&&t.forEach(function(t){defined(t.max)&&defined(e.dataMax)&&t.max>e.dataMax&&(e.dataMax=t.max)}),e}}function renderStackShadow(t){const e=Object.keys(t.points).filter(t=>1<t.split(",").length),i=t.axis.chart.series,r=e.map(t=>parseFloat(t.split(",")[0]));let s=-1;r.forEach(t=>{i[t]&&i[t].visible&&(s=t)});const a=t.axis.chart.series[s];if(a&&a.is("pictorial")&&t.axis.hasData()&&a.xAxis.hasData()){const o=a.xAxis,n=t.axis.options,h=t.axis.chart,d=t.shadow,l=o.toPixels(t.x,!0),c=h.inverted?o.len-l:l,p=a.options.paths||[],f=t.x%p.length,m=p[f],g=a.getColumnMetrics&&a.getColumnMetrics().width,{height:u,y:x}=getStackMetrics(a.yAxis,m),S=n.stackShadow,w=pick(S&&S.borderWidth,a.options.borderWidth,1);if(!d&&S&&S.enabled&&m)t.shadowGroup||(t.shadowGroup=h.renderer.g("shadow-group").add()),t.shadowGroup.attr({translateX:(h.inverted?t.axis:o).pos,translateY:(h.inverted?o:t.axis).pos}),t.shadow=h.renderer.rect(c,x,g,u).attr({fill:{pattern:{path:{d:m.definition,fill:S.color||"#dedede",strokeWidth:w,stroke:S.borderColor||"transparent"},x:c,y:x,width:g,height:u,patternContentUnits:"objectBoundingBox",backgroundColor:"none",color:"#dedede"}}}).add(t.shadowGroup),invertShadowGroup(t.shadowGroup,t.axis),rescalePatternFill(t.shadow,u,g,u,w),t.setOffset(a.pointXOffset||0,a.barW||0);else if(d&&t.shadowGroup){d.animate({x:c,y:x,width:g,height:u});const k=/url\(([^)]+)\)/,C=d.attr("fill"),y=C&&C.match(k);y&&h.renderer.patternElements&&h.renderer.patternElements[y[1].slice(1)].animate({x:c,y:x,width:g,height:u}),t.shadowGroup.animate({translateX:(h.inverted?t.axis:o).pos,translateY:(h.inverted?o:t.axis).pos}),invertShadowGroup(t.shadowGroup,t.axis),rescalePatternFill(d,u,g,u,w),t.setOffset(a.pointXOffset||0,a.barW||0)}}else t.shadow&&t.shadowGroup&&(t.shadow.destroy(),t.shadow=void 0,t.shadowGroup.destroy(),t.shadowGroup=void 0)}function forEachStack(t,e){t.axes&&t.axes.forEach(function(t){t.stacking&&(t=t.stacking.stacks,objectEach(t,function(t){objectEach(t,function(t){e(t)})}))})}function destroyAllStackShadows(t){forEachStack(t,function(t){t.shadow&&t.shadowGroup&&(t.shadow.destroy(),t.shadowGroup.destroy(),delete t.shadow,delete t.shadowGroup)})}PictorialSeries.defaultOptions=merge(ColumnSeries.defaultOptions,{borderWidth:0}),addEvent(PictorialSeries,"afterRender",function(){const n=this,h=n.options.paths,d=/url\(([^)]+)\)/;n.points.forEach(function(t){if(t.graphic&&t.shapeArgs&&h){const e=h[t.index%h.length],i=t.graphic.attr("fill"),r=i&&i.match(d),{y:s,height:a}=getStackMetrics(n.yAxis,e);if(r&&n.chart.renderer.patternElements){const o=n.chart.renderer.patternElements[r[1].slice(1)];o&&o.animate({x:t.shapeArgs.x,y:s,width:t.shapeArgs.width||0,height:a})}rescalePatternFill(t.graphic,getStackMetrics(n.yAxis,e).height,t.shapeArgs.width||0,t.shapeArgs.height||1/0,n.options.borderWidth||0)}})}),addEvent(Chart,"render",function(){forEachStack(this,renderStackShadow)}),addEvent(StackItem,"afterSetOffset",function(t){var e,i,r;this.shadow&&({chart:r,len:e}=this.axis,{xOffset:t,width:i}=t,t=r.inverted?t-r.xAxis[0].len:t,r=r.inverted?-e:0,this.shadow.attr({translateX:t,translateY:r}),this.shadow.animate({width:i}))}),addEvent(Chart,"afterDrilldown",function(){destroyAllStackShadows(this)}),addEvent(Chart,"afterDrillUp",function(){destroyAllStackShadows(this)}),PictorialSeries.prototype.pointClass=PictorialPoint,SeriesRegistry.registerSeriesType("pictorial",PictorialSeries);export default PictorialSeries;