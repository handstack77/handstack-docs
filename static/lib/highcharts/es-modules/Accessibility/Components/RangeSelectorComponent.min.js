"use strict";import AccessibilityComponent from"../AccessibilityComponent.js";import Announcer from"../Utils/Announcer.js";import ChartUtilities from"../Utils/ChartUtilities.js";const{unhideChartElementFromAT,getAxisRangeDescription}=ChartUtilities;import KeyboardNavigationHandler from"../KeyboardNavigationHandler.js";import U from"../../Core/Utilities.js";const{addEvent,attr}=U;function shouldRunInputNavigation(t){return Boolean(t.rangeSelector&&t.rangeSelector.inputGroup&&"hidden"!==t.rangeSelector.inputGroup.element.style.visibility&&!1!==t.options.rangeSelector.inputEnabled&&t.rangeSelector.minInput&&t.rangeSelector.maxInput)}class RangeSelectorComponent extends AccessibilityComponent{init(){var t=this.chart;this.announcer=new Announcer(t,"polite")}onChartUpdate(){const n=this.chart,o=this,i=n.rangeSelector;i&&(this.updateSelectorVisibility(),this.setDropdownAttrs(),i.buttons&&i.buttons.length&&i.buttons.forEach(t=>{o.setRangeButtonAttrs(t)}),i.maxInput&&i.minInput&&["minInput","maxInput"].forEach(function(t,e){t=i[t];t&&(unhideChartElementFromAT(n,t),o.setRangeInputAttrs(t,"accessibility.rangeSelector."+(e?"max":"min")+"InputLabel"))}))}updateSelectorVisibility(){const e=this.chart;var t=e.rangeSelector,n=t&&t.dropdown;const o=t&&t.buttons||[],i=t=>t.setAttribute("aria-hidden",!0);t&&t.hasVisibleDropdown&&n?(unhideChartElementFromAT(e,n),o.forEach(t=>i(t.element))):(n&&i(n),o.forEach(t=>unhideChartElementFromAT(e,t.element)))}setDropdownAttrs(){const t=this.chart,e=t.rangeSelector&&t.rangeSelector.dropdown;var n;e&&(n=t.langFormat("accessibility.rangeSelector.dropdownLabel",{rangeTitle:t.options.lang.rangeSelectorZoom}),e.setAttribute("aria-label",n),e.setAttribute("tabindex",-1))}setRangeButtonAttrs(t){attr(t.element,{tabindex:-1,role:"button"})}setRangeInputAttrs(t,e){const n=this.chart;attr(t,{tabindex:-1,"aria-label":n.langFormat(e,{chart:n})})}onButtonNavKbdArrowKey(t,e){const n=t.response,o=this.keyCodes,i=this.chart,r=i.options.accessibility.keyboardNavigation.wrapAround,a=e===o.left||e===o.up?-1:1,s=i.highlightRangeSelectorButton(i.highlightedRangeSelectorItemIx+a);return s?n.success:r?(t.init(a),n.success):n[0<a?"next":"prev"]}onButtonNavKbdClick(t){var t=t.response,e=this.chart;return 3===e.oldRangeSelectorItemState||this.fakeClickEvent(e.rangeSelector.buttons[e.highlightedRangeSelectorItemIx].element),t.success}onAfterBtnClick(){const t=this.chart;var e=getAxisRangeDescription(t.xAxis[0]),e=t.langFormat("accessibility.rangeSelector.clickButtonAnnouncement",{chart:t,axisRangeDescription:e});e&&this.announcer.announce(e)}onInputKbdMove(t){const e=this.chart;var n=e.rangeSelector,o=e.highlightedInputRangeIx=(e.highlightedInputRangeIx||0)+t,i=1<o||o<0;if(i){if(e.accessibility)return e.accessibility.keyboardNavigation.exiting=!0,e.accessibility.keyboardNavigation.tabindexContainer.focus(),e.accessibility.keyboardNavigation.move(t)}else n&&(i=n[o?"maxDateBox":"minDateBox"],t=n[o?"maxInput":"minInput"],i&&t&&e.setFocusToElement(i,t));return!0}onInputNavInit(t){const e=this,n=this.chart;var t=0<t?0:1,o=n.rangeSelector,i=o&&o[t?"maxDateBox":"minDateBox"],r=o&&o.minInput,o=o&&o.maxInput,a=t?o:r;if(n.highlightedInputRangeIx=t,i&&r&&o){n.setFocusToElement(i,a),this.removeInputKeydownHandler&&this.removeInputKeydownHandler();t=t=>{(t.which||t.keyCode)===this.keyCodes.tab&&e.onInputKbdMove(t.shiftKey?-1:1)&&(t.preventDefault(),t.stopPropagation())};const s=addEvent(r,"keydown",t),c=addEvent(o,"keydown",t);this.removeInputKeydownHandler=()=>{s(),c()}}}onInputNavTerminate(){const t=this.chart.rangeSelector||{};t.maxInput&&t.hideInput("max"),t.minInput&&t.hideInput("min"),this.removeInputKeydownHandler&&(this.removeInputKeydownHandler(),delete this.removeInputKeydownHandler)}initDropdownNav(){const o=this.chart;var t=o.rangeSelector,e=t&&t.dropdown;t&&e&&(o.setFocusToElement(t.buttonGroup,e),this.removeDropdownKeydownHandler&&this.removeDropdownKeydownHandler(),this.removeDropdownKeydownHandler=addEvent(e,"keydown",t=>{const e=(t.which||t.keyCode)===this.keyCodes.tab,n=o.accessibility;e&&(t.preventDefault(),t.stopPropagation(),n&&(n.keyboardNavigation.tabindexContainer.focus(),n.keyboardNavigation.move(t.shiftKey?-1:1)))}))}getRangeSelectorButtonNavigation(){const n=this.chart;var t=this.keyCodes;const o=this;return new KeyboardNavigationHandler(n,{keyCodeMap:[[[t.left,t.right,t.up,t.down],function(t){return o.onButtonNavKbdArrowKey(this,t)}],[[t.enter,t.space],function(){return o.onButtonNavKbdClick(this)}]],validate:function(){return!!(n.rangeSelector&&n.rangeSelector.buttons&&n.rangeSelector.buttons.length)},init:function(t){var e=n.rangeSelector;e&&e.hasVisibleDropdown?o.initDropdownNav():e&&(e=e.buttons.length-1,n.highlightRangeSelectorButton(0<t?0:e))},terminate:function(){o.removeDropdownKeydownHandler&&(o.removeDropdownKeydownHandler(),delete o.removeDropdownKeydownHandler)}})}getRangeSelectorInputNavigation(){const t=this.chart,e=this;return new KeyboardNavigationHandler(t,{keyCodeMap:[],validate:function(){return shouldRunInputNavigation(t)},init:function(t){e.onInputNavInit(t)},terminate:function(){e.onInputNavTerminate()}})}getKeyboardNavigation(){return[this.getRangeSelectorButtonNavigation(),this.getRangeSelectorInputNavigation()]}destroy(){this.removeDropdownKeydownHandler&&this.removeDropdownKeydownHandler(),this.removeInputKeydownHandler&&this.removeInputKeydownHandler(),this.announcer&&this.announcer.destroy()}}!function(){function o(t){const e=this.rangeSelector&&this.rangeSelector.buttons||[];var n=this.highlightedRangeSelectorItemIx,o=this.rangeSelector&&this.rangeSelector.selected;return void 0!==n&&e[n]&&n!==o&&e[n].setState(this.oldRangeSelectorItemState||0),this.highlightedRangeSelectorItemIx=t,!!e[t]&&(this.setFocusToElement(e[t].box,e[t].element),t!==o&&(this.oldRangeSelectorItemState=e[t].state,e[t].setState(1)),!0)}function i(){const t=this.chart.accessibility;if(t&&t.components.rangeSelector)return t.components.rangeSelector.onAfterBtnClick()}(RangeSelectorComponent||(RangeSelectorComponent={})).compose=function(t,e){const n=t.prototype;n.highlightRangeSelectorButton||(n.highlightRangeSelectorButton=o,addEvent(e,"afterBtnClick",i))}}();export default RangeSelectorComponent;