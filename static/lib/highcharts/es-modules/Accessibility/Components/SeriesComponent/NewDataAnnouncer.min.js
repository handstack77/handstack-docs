"use strict";import H from"../../../Core/Globals.js";const composed=H["composed"];import U from"../../../Core/Utilities.js";const{addEvent,defined,pushUnique}=U;import Announcer from"../../Utils/Announcer.js";import ChartUtilities from"../../Utils/ChartUtilities.js";const getChartTitle=ChartUtilities["getChartTitle"];import EventProvider from"../../Utils/EventProvider.js";import SeriesDescriber from"./SeriesDescriber.js";const{defaultPointDescriptionFormatter,defaultSeriesDescriptionFormatter}=SeriesDescriber;function chartHasAnnounceEnabled(e){return!!e.options.accessibility.announceNewData.enabled}function findPointInDataArray(n){var e=n.series.data.filter(e=>n.x===e.x&&n.y===e.y);return 1===e.length?e[0]:n}function getUniqueSeries(e,n){const t=(e||[]).concat(n||[]).reduce((e,n)=>(e[n.name+n.index]=n,e),{});return Object.keys(t).map(e=>t[e])}class NewDataAnnouncer{constructor(e){this.dirty={allSeries:{}},this.lastAnnouncementTime=0,this.chart=e}init(){var e=this.chart,n=e.options.accessibility.announceNewData.interruptUser?"assertive":"polite";this.lastAnnouncementTime=0,this.dirty={allSeries:{}},this.eventProvider=new EventProvider,this.announcer=new Announcer(e,n),this.addEventListeners()}destroy(){this.eventProvider.removeAddedEvents(),this.announcer.destroy()}addEventListeners(){const n=this,e=this.chart,t=this.eventProvider;t.addEvent(e,"afterApplyDrilldown",function(){n.lastAnnouncementTime=0}),t.addEvent(e,"afterAddSeries",function(e){n.onSeriesAdded(e.series)}),t.addEvent(e,"redraw",function(){n.announceDirtyData()})}onSeriesAdded(e){chartHasAnnounceEnabled(this.chart)&&(this.dirty.hasDirty=!0,this.dirty.allSeries[e.name+e.index]=e,this.dirty.newSeries=defined(this.dirty.newSeries)?void 0:e)}announceDirtyData(){const e=this.chart,n=this;if(e.options.accessibility.announceNewData&&this.dirty.hasDirty){let e=this.dirty.newPoint;e=e&&findPointInDataArray(e),this.queueAnnouncement(Object.keys(this.dirty.allSeries).map(e=>n.dirty.allSeries[e]),this.dirty.newSeries,e),this.dirty={allSeries:{}}}}queueAnnouncement(e,n,t){var i,s,r=this.chart.options.accessibility.announceNewData;r.enabled&&(s=(i=+new Date)-this.lastAnnouncementTime,r=Math.max(0,r.minAnnounceInterval-s),s=getUniqueSeries(this.queuedAnnouncement&&this.queuedAnnouncement.series,e),(e=this.buildAnnouncementMessage(s,n,t))&&(this.queuedAnnouncement&&clearTimeout(this.queuedAnnouncementTimer),this.queuedAnnouncement={time:i,message:e,series:s},this.queuedAnnouncementTimer=setTimeout(()=>{this&&this.announcer&&(this.lastAnnouncementTime=+new Date,this.announcer.announce(this.queuedAnnouncement.message),delete this.queuedAnnouncement,delete this.queuedAnnouncementTimer)},r)))}buildAnnouncementMessage(e,n,t){const i=this.chart,s=i.options.accessibility.announceNewData;if(s.announcementFormatter){e=s.announcementFormatter(e,n,t);if(!1!==e)return e.length?e:null}var e=H.charts&&1<H.charts.length?"Multiple":"Single",e=n?"newSeriesAnnounce"+e:t?"newPointAnnounce"+e:"newDataAnnounce",r=getChartTitle(i);return i.langFormat("accessibility.announceNewData."+e,{chartTitle:r,seriesDesc:n?defaultSeriesDescriptionFormatter(n):null,pointDesc:t?defaultPointDescriptionFormatter(t):null,point:t,series:n})}}!function(){function n(e){const n=this.chart,t=n.accessibility?.components.series.newDataAnnouncer;t&&t.chart===n&&chartHasAnnounceEnabled(n)&&(t.dirty.newPoint=defined(t.dirty.newPoint)?void 0:e.point)}function t(){const e=this.chart,n=e.accessibility?.components.series.newDataAnnouncer;n&&n.chart===e&&chartHasAnnounceEnabled(e)&&(n.dirty.hasDirty=!0,n.dirty.allSeries[this.name+this.index]=this)}(NewDataAnnouncer||(NewDataAnnouncer={})).compose=function(e){pushUnique(composed,"A11y.NDA")&&(addEvent(e,"addPoint",n),addEvent(e,"updatedData",t))}}();export default NewDataAnnouncer;